var De={Event:"Event",Site:"Site",Date:"Date",Round:"Round",White:"White",Black:"Black",Result:"Result",WhiteTitle:"WhiteTitle",BlackTitle:"BlackTitle",WhiteElo:"WhiteElo",BlackElo:"BlackElo",WhiteUSCF:"WhiteUSCF",BlackUSCF:"BlackUSCF",WhiteNA:"WhiteNA",BlackNA:"BlackNA:",WhiteType:"WhiteType",BlackType:"BlackType",EventDate:"EventDate",EventSponsor:"EventSponsor",Section:"Section",Stage:"Stage",Board:"Board",Opening:"Opening",ECO:"ECO",Time:"Time",UTCTime:"UTCTime",UTCDate:"UTCDate",TimeControl:"TimeControl",SetUp:"SetUp",FEN:"FEN",Termination:"Termination",Annotator:"Annotator",Mode:"Mode",PlyCount:"PlyCount"},zt=class{constructor(t=""){this.clear();let e=t.match(/\[([^\]]+)]/g);if(e&&e.length>0)for(let i=0;i<e.length;i++){let n=e[i].match(/\[(\w+)\s+"([^"]+)"/);n&&(this.tags[n[1]]=n[2])}}clear(){this.tags={}}render(){let t="";for(let e in this.tags)t+=`[${e} "${this.tags[e]}"]
`;return t}};function Cr(c,t){function e(){this.constructor=c}e.prototype=t.prototype,c.prototype=new e}function ct(c,t,e,i){this.message=c,this.expected=t,this.found=e,this.location=i,this.name="SyntaxError",typeof Error.captureStackTrace=="function"&&Error.captureStackTrace(this,ct)}Cr(ct,Error);ct.buildMessage=function(c,t){var e={literal:function(g){return'"'+n(g.text)+'"'},class:function(g){var x="",k;for(k=0;k<g.parts.length;k++)x+=g.parts[k]instanceof Array?o(g.parts[k][0])+"-"+o(g.parts[k][1]):o(g.parts[k]);return"["+(g.inverted?"^":"")+x+"]"},any:function(g){return"any character"},end:function(g){return"end of input"},other:function(g){return g.description}};function i(g){return g.charCodeAt(0).toString(16).toUpperCase()}function n(g){return g.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(x){return"\\x0"+i(x)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(x){return"\\x"+i(x)})}function o(g){return g.replace(/\\/g,"\\\\").replace(/\]/g,"\\]").replace(/\^/g,"\\^").replace(/-/g,"\\-").replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(x){return"\\x0"+i(x)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(x){return"\\x"+i(x)})}function l(g){return e[g.type](g)}function f(g){var x=new Array(g.length),k,ee;for(k=0;k<g.length;k++)x[k]=l(g[k]);if(x.sort(),x.length>0){for(k=1,ee=1;k<x.length;k++)x[k-1]!==x[k]&&(x[ee]=x[k],ee++);x.length=ee}switch(x.length){case 1:return x[0];case 2:return x[0]+" or "+x[1];default:return x.slice(0,-1).join(", ")+", or "+x[x.length-1]}}function m(g){return g?'"'+n(g)+'"':"end of input"}return"Expected "+f(c)+" but "+m(t)+" found."};function gr(c,t){t=t!==void 0?t:{};var e={},i={pgn:Ci},n=Ci,o=function(s,r){var p=r||[];return p.unshift(s),p},l=function(s,r){var p=r||[];return p.unshift(s),p},f=function(){return[[]]},m=function(s){return s},g=function(s){return s},x=function(s,r,p,E,w,P,S,_){var N=_||[],K={};return K.turn="w",K.moveNumber=r,K.notation=E,K.commentBefore=p,K.commentAfter=P,K.commentMove=s,K.variations=S||[],K.nag=w||null,N.unshift(K),N},k=function(s,r,p,E,w,P,S,_){var N=_||[],K={};return K.turn="b",K.moveNumber=r,K.notation=E,K.commentBefore=p,K.commentAfter=P,K.variations=S||[],N.unshift(K),K.nag=w||null,N},ee="1:0",de=T("1:0",!1),ye=function(){return["1:0"]},mt="0:1",he=T("0:1",!1),Ct=function(){return["0:1"]},Xe="1-0",qt=T("1-0",!1),Ot=function(){return["1-0"]},Lt="0-1",Rt=T("0-1",!1),me=function(){return["0-1"]},We="1/2-1/2",Me=T("1/2-1/2",!1),gt=function(){return["1/2-1/2"]},st="*",vt=T("*",!1),Et=function(){return["*"]},it=/^[^}]/,nt=xt(["}"],!0,!1),xs=function(s){return s.join("").trim()},Ee="{",ke=T("{",!1),Nt="}",rt=T("}",!1),Ut=function(s,r,p){var E=r||[];return E.unshift(s),E},h=function(s,r){var p=r||[];return p.unshift(s),p},u="(",d=T("(",!1),C=")",b=T(")",!1),v=".",y=T(".",!1),q=function(s){return s},G=fi("integer"),z=/^[0-9]/,Z=xt([["0","9"]],!1,!1),I=function(s){return mr(s)},W=" ",R=T(" ",!1),H=function(){return""},J=function(s,r,p,E,w,P,S){var _={};return _.fig=s||null,_.disc=r||null,_.strike=p||null,_.col=E,_.row=w,_.check=S||null,_.promotion=P,_.notation=(s||"")+(r||"")+(p||"")+E+w+(P||"")+(S||""),_},pe=function(s,r,p,E,w,P,S,_){var N={};return N.fig=s||null,N.strike=E=="x"?E:null,N.col=w,N.row=P,N.check=_||null,N.notation=(s&&s!=="P"?s:"")+r+p+(E=="x"?E:"-")+w+P+(S||"")+(_||""),N.promotion=S,N},te=function(s,r,p,E,w,P){var S={};return S.fig=s||null,S.strike=r||null,S.col=p,S.row=E,S.check=P||null,S.notation=(s||"")+(r||"")+p+E+(w||"")+(P||""),S.promotion=w,S},fe="O-O-O",Ie=T("O-O-O",!1),Ce=function(s){var r={};return r.notation="O-O-O"+(s||""),r.check=s||null,r},He="O-O",Y=T("O-O",!1),le=function(s){var r={};return r.notation="O-O"+(s||""),r.check=s||null,r},be="+-",Ke=T("+-",!1),qe="+",Ze=T("+",!1),bt=function(s){return s[1]},Je="$$$",Gt=T("$$$",!1),Ni="#",Ui=T("#",!1),ei="=",ti=T("=",!1),Gi=function(s){return"="+s},Vi=function(s,r){var p=r||[];return p.unshift(s),p},Wi="$",Hi=T("$",!1),Ki=function(s){return"$"+s},si="!!",zi=T("!!",!1),ii=function(){return"$3"},ni="??",Qi=T("??",!1),ri=function(){return"$4"},oi="!?",Yi=T("!?",!1),ai=function(){return"$5"},li="?!",ji=T("?!",!1),ci=function(){return"$6"},Xi="!",Zi=T("!",!1),Ji=function(){return"$1"},en="?",tn=T("?",!1),sn=function(){return"$2"},nn="\u203C",rn=T("\u203C",!1),on="\u2047",an=T("\u2047",!1),ln="\u2049",cn=T("\u2049",!1),hn="\u2048",un=T("\u2048",!1),pn="\u25A1",fn=T("\u25A1",!1),dn=function(){return"$7"},mn=function(){return"$10"},Cn="\u221E",gn=T("\u221E",!1),vn=function(){return"$13"},En="\u2A72",bn=T("\u2A72",!1),xn=function(){return"$14"},An="\u2A71",Fn=T("\u2A71",!1),Bn=function(){return"$15"},Dn="\xB1",wn=T("\xB1",!1),yn=function(){return"$16"},kn="\u2213",Sn=T("\u2213",!1),Pn=function(){return"$17"},_n=function(){return"$18"},hi="-+",Tn=T("-+",!1),$n=function(){return"$19"},Mn="\u2A00",In=T("\u2A00",!1),qn=function(){return"$22"},On="\u27F3",Ln=T("\u27F3",!1),Rn=function(){return"$32"},Nn="\u2192",Un=T("\u2192",!1),Gn=function(){return"$36"},Vn="\u2191",Wn=T("\u2191",!1),Hn=function(){return"$40"},Kn="\u21C6",zn=T("\u21C6",!1),Qn=function(){return"$132"},Yn="D",jn=T("D",!1),Xn=function(){return"$220"},Zn=/^[RNBQKP]/,Jn=xt(["R","N","B","Q","K","P"],!1,!1),er=/^[a-h]/,tr=xt([["a","h"]],!1,!1),sr=/^[1-8]/,ir=xt([["1","8"]],!1,!1),ui="x",pi=T("x",!1),nr="-",rr=T("-",!1),a=0,F=0,Vt=[{line:1,column:1}],Se=0,As=[],A=0,Wt;if("startRule"in t){if(!(t.startRule in i))throw new Error(`Can't start parsing from rule "`+t.startRule+'".');n=i[t.startRule]}function Ur(){return c.substring(F,a)}function Gr(){return At(F,a)}function Vr(s,r){throw r=r!==void 0?r:At(F,a),mi([fi(s)],c.substring(F,a),r)}function Wr(s,r){throw r=r!==void 0?r:At(F,a),ar(s,r)}function T(s,r){return{type:"literal",text:s,ignoreCase:r}}function xt(s,r,p){return{type:"class",parts:s,inverted:r,ignoreCase:p}}function Hr(){return{type:"any"}}function or(){return{type:"end"}}function fi(s){return{type:"other",description:s}}function di(s){var r=Vt[s],p;if(r)return r;for(p=s-1;!Vt[p];)p--;for(r=Vt[p],r={line:r.line,column:r.column};p<s;)c.charCodeAt(p)===10?(r.line++,r.column=1):r.column++,p++;return Vt[s]=r,r}function At(s,r){var p=di(s),E=di(r);return{start:{offset:s,line:p.line,column:p.column},end:{offset:r,line:E.line,column:E.column}}}function B(s){a<Se||(a>Se&&(Se=a,As=[]),As.push(s))}function ar(s,r){return new ct(s,null,null,r)}function mi(s,r,p){return new ct(ct.buildMessage(s,r),s,r,p)}function Ci(){var s,r,p;return s=a,r=lr(),r!==e?(p=Fs(),p===e&&(p=null),p!==e?(F=s,r=o(r,p),s=r):(a=s,s=e)):(a=s,s=e),s===e&&(s=a,r=gi(),r!==e?(p=Ht(),p===e&&(p=null),p!==e?(F=s,r=l(r,p),s=r):(a=s,s=e)):(a=s,s=e),s===e&&(s=a,r=se(),r===e&&(r=null),r!==e&&(F=s,r=f()),s=r)),s}function lr(){var s,r;return s=a,r=Ht(),r!==e&&(F=s,r=m(r)),s=r,s}function gi(){var s,r;return s=a,r=Fs(),r!==e&&(F=s,r=g(r)),s=r,s}function Ht(){var s,r,p,E,w,P,S,_,N,K,xe,Oe,Ae,Le,Fe,Be;return s=a,r=se(),r===e&&(r=null),r!==e?(p=ot(),p===e&&(p=null),p!==e?(E=se(),E===e&&(E=null),E!==e?(w=ur(),w===e&&(w=null),w!==e?(P=se(),P===e&&(P=null),P!==e?(S=ot(),S===e&&(S=null),S!==e?(_=se(),_===e&&(_=null),_!==e?(N=Fi(),N!==e?(K=se(),K===e&&(K=null),K!==e?(xe=ws(),xe===e&&(xe=null),xe!==e?(Oe=se(),Oe===e&&(Oe=null),Oe!==e?(Ae=ot(),Ae===e&&(Ae=null),Ae!==e?(Le=se(),Le===e&&(Le=null),Le!==e?(Fe=Ei(),Fe===e&&(Fe=null),Fe!==e?(Be=Fs(),Be===e&&(Be=null),Be!==e?(F=s,r=x(p,w,S,N,xe,Ae,Fe,Be),s=r):(a=s,s=e)):(a=s,s=e)):(a=s,s=e)):(a=s,s=e)):(a=s,s=e)):(a=s,s=e)):(a=s,s=e)):(a=s,s=e)):(a=s,s=e)):(a=s,s=e)):(a=s,s=e)):(a=s,s=e)):(a=s,s=e)):(a=s,s=e)):(a=s,s=e),s===e&&(s=vi()),s}function Fs(){var s,r,p,E,w,P,S,_,N,K,xe,Oe,Ae,Le,Fe,Be;return s=a,r=se(),r===e&&(r=null),r!==e?(p=ot(),p===e&&(p=null),p!==e?(E=se(),E===e&&(E=null),E!==e?(w=Di(),w===e&&(w=null),w!==e?(P=se(),P===e&&(P=null),P!==e?(S=ot(),S===e&&(S=null),S!==e?(_=se(),_===e&&(_=null),_!==e?(N=Fi(),N!==e?(K=se(),K===e&&(K=null),K!==e?(xe=ws(),xe===e&&(xe=null),xe!==e?(Oe=se(),Oe===e&&(Oe=null),Oe!==e?(Ae=ot(),Ae===e&&(Ae=null),Ae!==e?(Le=se(),Le===e&&(Le=null),Le!==e?(Fe=bi(),Fe===e&&(Fe=null),Fe!==e?(Be=Ht(),Be===e&&(Be=null),Be!==e?(F=s,r=k(p,w,S,N,xe,Ae,Fe,Be),s=r):(a=s,s=e)):(a=s,s=e)):(a=s,s=e)):(a=s,s=e)):(a=s,s=e)):(a=s,s=e)):(a=s,s=e)):(a=s,s=e)):(a=s,s=e)):(a=s,s=e)):(a=s,s=e)):(a=s,s=e)):(a=s,s=e)):(a=s,s=e)):(a=s,s=e),s===e&&(s=vi()),s}function vi(){var s,r;return s=a,c.substr(a,3)===ee?(r=ee,a+=3):(r=e,A===0&&B(de)),r!==e&&(F=s,r=ye()),s=r,s===e&&(s=a,c.substr(a,3)===mt?(r=mt,a+=3):(r=e,A===0&&B(he)),r!==e&&(F=s,r=Ct()),s=r,s===e&&(s=a,c.substr(a,3)===Xe?(r=Xe,a+=3):(r=e,A===0&&B(qt)),r!==e&&(F=s,r=Ot()),s=r,s===e&&(s=a,c.substr(a,3)===Lt?(r=Lt,a+=3):(r=e,A===0&&B(Rt)),r!==e&&(F=s,r=me()),s=r,s===e&&(s=a,c.substr(a,7)===We?(r=We,a+=7):(r=e,A===0&&B(Me)),r!==e&&(F=s,r=gt()),s=r,s===e&&(s=a,c.charCodeAt(a)===42?(r=st,a++):(r=e,A===0&&B(vt)),r!==e&&(F=s,r=Et()),s=r))))),s}function ot(){var s,r,p,E;if(s=a,r=cr(),r!==e){for(p=[],it.test(c.charAt(a))?(E=c.charAt(a),a++):(E=e,A===0&&B(nt));E!==e;)p.push(E),it.test(c.charAt(a))?(E=c.charAt(a),a++):(E=e,A===0&&B(nt));p!==e?(E=hr(),E!==e?(F=s,r=xs(p),s=r):(a=s,s=e)):(a=s,s=e)}else a=s,s=e;return s}function cr(){var s;return c.charCodeAt(a)===123?(s=Ee,a++):(s=e,A===0&&B(ke)),s}function hr(){var s;return c.charCodeAt(a)===125?(s=Nt,a++):(s=e,A===0&&B(rt)),s}function Ei(){var s,r,p,E,w,P,S,_;return s=a,r=xi(),r!==e?(p=Ht(),p!==e?(E=Ai(),E!==e?(w=se(),w===e&&(w=null),w!==e?(P=Ei(),P===e&&(P=null),P!==e?(S=se(),S===e&&(S=null),S!==e?(_=Di(),_===e&&(_=null),_!==e?(F=s,r=Ut(p,P,_),s=r):(a=s,s=e)):(a=s,s=e)):(a=s,s=e)):(a=s,s=e)):(a=s,s=e)):(a=s,s=e)):(a=s,s=e),s}function bi(){var s,r,p,E,w,P;return s=a,r=xi(),r!==e?(p=gi(),p!==e?(E=Ai(),E!==e?(w=se(),w===e&&(w=null),w!==e?(P=bi(),P===e&&(P=null),P!==e?(F=s,r=h(p,P),s=r):(a=s,s=e)):(a=s,s=e)):(a=s,s=e)):(a=s,s=e)):(a=s,s=e),s}function xi(){var s;return c.charCodeAt(a)===40?(s=u,a++):(s=e,A===0&&B(d)),s}function Ai(){var s;return c.charCodeAt(a)===41?(s=C,a++):(s=e,A===0&&B(b)),s}function ur(){var s,r,p;return s=a,r=Bs(),r!==e?(c.charCodeAt(a)===46?(p=v,a++):(p=e,A===0&&B(y)),p===e&&(p=null),p!==e?(F=s,r=q(r),s=r):(a=s,s=e)):(a=s,s=e),s}function Bs(){var s,r,p;if(A++,s=a,r=[],z.test(c.charAt(a))?(p=c.charAt(a),a++):(p=e,A===0&&B(Z)),p!==e)for(;p!==e;)r.push(p),z.test(c.charAt(a))?(p=c.charAt(a),a++):(p=e,A===0&&B(Z));else r=e;return r!==e&&(F=s,r=I(r)),s=r,A--,s===e&&(r=e,A===0&&B(G)),s}function se(){var s,r,p;if(s=a,r=[],c.charCodeAt(a)===32?(p=W,a++):(p=e,A===0&&B(R)),p!==e)for(;p!==e;)r.push(p),c.charCodeAt(a)===32?(p=W,a++):(p=e,A===0&&B(R));else r=e;return r!==e&&(F=s,r=H()),s=r,s}function Fi(){var s,r,p,E,w,P,S,_,N;return s=a,r=Kt(),r===e&&(r=null),r!==e?(p=a,A++,E=fr(),A--,E!==e?(a=p,p=void 0):p=e,p!==e?(E=Bi(),E!==e?(w=ys(),w===e&&(w=null),w!==e?(P=at(),P!==e?(S=lt(),S!==e?(_=Ds(),_===e&&(_=null),_!==e?(N=Ft(),N===e&&(N=null),N!==e?(F=s,r=J(r,E,w,P,S,_,N),s=r):(a=s,s=e)):(a=s,s=e)):(a=s,s=e)):(a=s,s=e)):(a=s,s=e)):(a=s,s=e)):(a=s,s=e)):(a=s,s=e),s===e&&(s=a,r=Kt(),r===e&&(r=null),r!==e?(p=at(),p!==e?(E=lt(),E!==e?(w=dr(),w===e&&(w=null),w!==e?(P=at(),P!==e?(S=lt(),S!==e?(_=Ds(),_===e&&(_=null),_!==e?(N=Ft(),N===e&&(N=null),N!==e?(F=s,r=pe(r,p,E,w,P,S,_,N),s=r):(a=s,s=e)):(a=s,s=e)):(a=s,s=e)):(a=s,s=e)):(a=s,s=e)):(a=s,s=e)):(a=s,s=e)):(a=s,s=e),s===e&&(s=a,r=Kt(),r===e&&(r=null),r!==e?(p=ys(),p===e&&(p=null),p!==e?(E=at(),E!==e?(w=lt(),w!==e?(P=Ds(),P===e&&(P=null),P!==e?(S=Ft(),S===e&&(S=null),S!==e?(F=s,r=te(r,p,E,w,P,S),s=r):(a=s,s=e)):(a=s,s=e)):(a=s,s=e)):(a=s,s=e)):(a=s,s=e)):(a=s,s=e),s===e&&(s=a,c.substr(a,5)===fe?(r=fe,a+=5):(r=e,A===0&&B(Ie)),r!==e?(p=Ft(),p===e&&(p=null),p!==e?(F=s,r=Ce(p),s=r):(a=s,s=e)):(a=s,s=e),s===e&&(s=a,c.substr(a,3)===He?(r=He,a+=3):(r=e,A===0&&B(Y)),r!==e?(p=Ft(),p===e&&(p=null),p!==e?(F=s,r=le(p),s=r):(a=s,s=e)):(a=s,s=e))))),s}function Ft(){var s,r,p,E;return s=a,r=a,p=a,A++,c.substr(a,2)===be?(E=be,a+=2):(E=e,A===0&&B(Ke)),A--,E===e?p=void 0:(a=p,p=e),p!==e?(c.charCodeAt(a)===43?(E=qe,a++):(E=e,A===0&&B(Ze)),E!==e?(p=[p,E],r=p):(a=r,r=e)):(a=r,r=e),r!==e&&(F=s,r=bt(r)),s=r,s===e&&(s=a,r=a,p=a,A++,c.substr(a,3)===Je?(E=Je,a+=3):(E=e,A===0&&B(Gt)),A--,E===e?p=void 0:(a=p,p=e),p!==e?(c.charCodeAt(a)===35?(E=Ni,a++):(E=e,A===0&&B(Ui)),E!==e?(p=[p,E],r=p):(a=r,r=e)):(a=r,r=e),r!==e&&(F=s,r=bt(r)),s=r),s}function Ds(){var s,r,p;return s=a,c.charCodeAt(a)===61?(r=ei,a++):(r=e,A===0&&B(ti)),r!==e?(p=Kt(),p!==e?(F=s,r=Gi(p),s=r):(a=s,s=e)):(a=s,s=e),s}function ws(){var s,r,p,E;return s=a,r=pr(),r!==e?(p=se(),p===e&&(p=null),p!==e?(E=ws(),E===e&&(E=null),E!==e?(F=s,r=Vi(r,E),s=r):(a=s,s=e)):(a=s,s=e)):(a=s,s=e),s}function pr(){var s,r,p;return s=a,c.charCodeAt(a)===36?(r=Wi,a++):(r=e,A===0&&B(Hi)),r!==e?(p=Bs(),p!==e?(F=s,r=Ki(p),s=r):(a=s,s=e)):(a=s,s=e),s===e&&(s=a,c.substr(a,2)===si?(r=si,a+=2):(r=e,A===0&&B(zi)),r!==e&&(F=s,r=ii()),s=r,s===e&&(s=a,c.substr(a,2)===ni?(r=ni,a+=2):(r=e,A===0&&B(Qi)),r!==e&&(F=s,r=ri()),s=r,s===e&&(s=a,c.substr(a,2)===oi?(r=oi,a+=2):(r=e,A===0&&B(Yi)),r!==e&&(F=s,r=ai()),s=r,s===e&&(s=a,c.substr(a,2)===li?(r=li,a+=2):(r=e,A===0&&B(ji)),r!==e&&(F=s,r=ci()),s=r,s===e&&(s=a,c.charCodeAt(a)===33?(r=Xi,a++):(r=e,A===0&&B(Zi)),r!==e&&(F=s,r=Ji()),s=r,s===e&&(s=a,c.charCodeAt(a)===63?(r=en,a++):(r=e,A===0&&B(tn)),r!==e&&(F=s,r=sn()),s=r,s===e&&(s=a,c.charCodeAt(a)===8252?(r=nn,a++):(r=e,A===0&&B(rn)),r!==e&&(F=s,r=ii()),s=r,s===e&&(s=a,c.charCodeAt(a)===8263?(r=on,a++):(r=e,A===0&&B(an)),r!==e&&(F=s,r=ri()),s=r,s===e&&(s=a,c.charCodeAt(a)===8265?(r=ln,a++):(r=e,A===0&&B(cn)),r!==e&&(F=s,r=ai()),s=r,s===e&&(s=a,c.charCodeAt(a)===8264?(r=hn,a++):(r=e,A===0&&B(un)),r!==e&&(F=s,r=ci()),s=r,s===e&&(s=a,c.charCodeAt(a)===9633?(r=pn,a++):(r=e,A===0&&B(fn)),r!==e&&(F=s,r=dn()),s=r,s===e&&(s=a,c.charCodeAt(a)===61?(r=ei,a++):(r=e,A===0&&B(ti)),r!==e&&(F=s,r=mn()),s=r,s===e&&(s=a,c.charCodeAt(a)===8734?(r=Cn,a++):(r=e,A===0&&B(gn)),r!==e&&(F=s,r=vn()),s=r,s===e&&(s=a,c.charCodeAt(a)===10866?(r=En,a++):(r=e,A===0&&B(bn)),r!==e&&(F=s,r=xn()),s=r,s===e&&(s=a,c.charCodeAt(a)===10865?(r=An,a++):(r=e,A===0&&B(Fn)),r!==e&&(F=s,r=Bn()),s=r,s===e&&(s=a,c.charCodeAt(a)===177?(r=Dn,a++):(r=e,A===0&&B(wn)),r!==e&&(F=s,r=yn()),s=r,s===e&&(s=a,c.charCodeAt(a)===8723?(r=kn,a++):(r=e,A===0&&B(Sn)),r!==e&&(F=s,r=Pn()),s=r,s===e&&(s=a,c.substr(a,2)===be?(r=be,a+=2):(r=e,A===0&&B(Ke)),r!==e&&(F=s,r=_n()),s=r,s===e&&(s=a,c.substr(a,2)===hi?(r=hi,a+=2):(r=e,A===0&&B(Tn)),r!==e&&(F=s,r=$n()),s=r,s===e&&(s=a,c.charCodeAt(a)===10752?(r=Mn,a++):(r=e,A===0&&B(In)),r!==e&&(F=s,r=qn()),s=r,s===e&&(s=a,c.charCodeAt(a)===10227?(r=On,a++):(r=e,A===0&&B(Ln)),r!==e&&(F=s,r=Rn()),s=r,s===e&&(s=a,c.charCodeAt(a)===8594?(r=Nn,a++):(r=e,A===0&&B(Un)),r!==e&&(F=s,r=Gn()),s=r,s===e&&(s=a,c.charCodeAt(a)===8593?(r=Vn,a++):(r=e,A===0&&B(Wn)),r!==e&&(F=s,r=Hn()),s=r,s===e&&(s=a,c.charCodeAt(a)===8646?(r=Kn,a++):(r=e,A===0&&B(zn)),r!==e&&(F=s,r=Qn()),s=r,s===e&&(s=a,c.charCodeAt(a)===68?(r=Yn,a++):(r=e,A===0&&B(jn)),r!==e&&(F=s,r=Xn()),s=r))))))))))))))))))))))))),s}function Bi(){var s;return s=at(),s===e&&(s=lt()),s}function fr(){var s,r,p,E,w;return s=a,r=Bi(),r!==e?(p=ys(),p===e&&(p=null),p!==e?(E=at(),E!==e?(w=lt(),w!==e?(r=[r,p,E,w],s=r):(a=s,s=e)):(a=s,s=e)):(a=s,s=e)):(a=s,s=e),s}function Di(){var s,r,p,E;if(s=a,r=Bs(),r!==e){if(p=[],c.charCodeAt(a)===46?(E=v,a++):(E=e,A===0&&B(y)),E!==e)for(;E!==e;)p.push(E),c.charCodeAt(a)===46?(E=v,a++):(E=e,A===0&&B(y));else p=e;p!==e?(F=s,r=q(r),s=r):(a=s,s=e)}else a=s,s=e;return s}function Kt(){var s;return Zn.test(c.charAt(a))?(s=c.charAt(a),a++):(s=e,A===0&&B(Jn)),s}function at(){var s;return er.test(c.charAt(a))?(s=c.charAt(a),a++):(s=e,A===0&&B(tr)),s}function lt(){var s;return sr.test(c.charAt(a))?(s=c.charAt(a),a++):(s=e,A===0&&B(ir)),s}function ys(){var s;return c.charCodeAt(a)===120?(s=ui,a++):(s=e,A===0&&B(pi)),s}function dr(){var s;return c.charCodeAt(a)===120?(s=ui,a++):(s=e,A===0&&B(pi)),s===e&&(c.charCodeAt(a)===45?(s=nr,a++):(s=e,A===0&&B(rr))),s}function mr(s){return parseInt(s.join(""),10)}if(Wt=n(),Wt!==e&&a===c.length)return Wt;throw Wt!==e&&a<c.length&&B(or()),mi(As,Se<c.length?c.charAt(Se):null,Se<c.length?At(Se,Se+1):At(Se,Se))}var Qt=class{static parse(t,e){return gr(t,e)}};var vr="pnbrqkPNBRQK",ks="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1",Er=["1-0","0-1","1/2-1/2","*"],Ss={b:[16,32,17,15],w:[-16,-32,-17,-15]},wi={n:[-18,-33,-31,-14,18,33,31,14],b:[-17,-15,17,15],r:[-16,1,16,-1],q:[-17,-16,-15,1,17,16,15,-1],k:[-17,-16,-15,1,17,16,15,-1]},br=[20,0,0,0,0,0,0,24,0,0,0,0,0,0,20,0,0,20,0,0,0,0,0,24,0,0,0,0,0,20,0,0,0,0,20,0,0,0,0,24,0,0,0,0,20,0,0,0,0,0,0,20,0,0,0,24,0,0,0,20,0,0,0,0,0,0,0,0,20,0,0,24,0,0,20,0,0,0,0,0,0,0,0,0,0,20,2,24,2,20,0,0,0,0,0,0,0,0,0,0,0,2,53,56,53,2,0,0,0,0,0,0,24,24,24,24,24,24,56,0,56,24,24,24,24,24,24,0,0,0,0,0,0,2,53,56,53,2,0,0,0,0,0,0,0,0,0,0,0,20,2,24,2,20,0,0,0,0,0,0,0,0,0,0,20,0,0,24,0,0,20,0,0,0,0,0,0,0,0,20,0,0,0,24,0,0,0,20,0,0,0,0,0,0,20,0,0,0,0,24,0,0,0,0,20,0,0,0,0,20,0,0,0,0,0,24,0,0,0,0,0,20,0,0,20,0,0,0,0,0,0,24,0,0,0,0,0,0,20],xr=[17,0,0,0,0,0,0,16,0,0,0,0,0,0,15,0,0,17,0,0,0,0,0,16,0,0,0,0,0,15,0,0,0,0,17,0,0,0,0,16,0,0,0,0,15,0,0,0,0,0,0,17,0,0,0,16,0,0,0,15,0,0,0,0,0,0,0,0,17,0,0,16,0,0,15,0,0,0,0,0,0,0,0,0,0,17,0,16,0,15,0,0,0,0,0,0,0,0,0,0,0,0,17,16,15,0,0,0,0,0,0,0,1,1,1,1,1,1,1,0,-1,-1,-1,-1,-1,-1,-1,0,0,0,0,0,0,0,-15,-16,-17,0,0,0,0,0,0,0,0,0,0,0,0,-15,0,-16,0,-17,0,0,0,0,0,0,0,0,0,0,-15,0,0,-16,0,0,-17,0,0,0,0,0,0,0,0,-15,0,0,0,-16,0,0,0,-17,0,0,0,0,0,0,-15,0,0,0,0,-16,0,0,0,0,-17,0,0,0,0,-15,0,0,0,0,0,-16,0,0,0,0,0,-17,0,0,-15,0,0,0,0,0,0,-16,0,0,0,0,0,0,-17],Ar={p:0,n:1,b:2,r:3,q:4,k:5},M={NORMAL:1,CAPTURE:2,BIG_PAWN:4,EP_CAPTURE:8,PROMOTION:16,KSIDE_CASTLE:32,QSIDE_CASTLE:64},Fr=7,Br=6;var Dr=1,wr=0,V={a8:0,b8:1,c8:2,d8:3,e8:4,f8:5,g8:6,h8:7,a7:16,b7:17,c7:18,d7:19,e7:20,f7:21,g7:22,h7:23,a6:32,b6:33,c6:34,d6:35,e6:36,f6:37,g6:38,h6:39,a5:48,b5:49,c5:50,d5:51,e5:52,f5:53,g5:54,h5:55,a4:64,b4:65,c4:66,d4:67,e4:68,f4:69,g4:70,h4:71,a3:80,b3:81,c3:82,d3:83,e3:84,f3:85,g3:86,h3:87,a2:96,b2:97,c2:98,d2:99,e2:100,f2:101,g2:102,h2:103,a1:112,b1:113,c1:114,d1:115,e1:116,f1:117,g1:118,h1:119},ze={w:[{square:V.a1,flag:M.QSIDE_CASTLE},{square:V.h1,flag:M.KSIDE_CASTLE}],b:[{square:V.a8,flag:M.QSIDE_CASTLE},{square:V.h8,flag:M.KSIDE_CASTLE}]},yr=0,yi=1;function kr(c,t){for(var e=c.from,i=c.to,n=c.piece,o=0,l=0,f=0,m=0,g=t.length;m<g;m++){var x=t[m].from,k=t[m].to,ee=t[m].piece;n===ee&&e!==x&&i===k&&(o++,Ye(e)===Ye(x)&&l++,Dt(e)===Dt(x)&&f++)}return o>0?l>0&&f>0?ue(e):f>0?ue(e).charAt(1):ue(e).charAt(0):""}function Sr(c){var t=c.charAt(0);if(t>="a"&&t<="h"){var e=c.match(/[a-h]\d.*[a-h]\d/);return e?void 0:Pe}return t=t.toLowerCase(),t==="o"?ht:t}function ki(c){return c.replace(/=/,"").replace(/[+#]?[?!]*$/,"")}function Ye(c){return c>>4}function Dt(c){return c&15}function ue(c){var t=Dt(c),e=Ye(c);return"abcdefgh".substring(t,t+1)+"87654321".substring(e,e+1)}function Bt(c){return c===_e?Qe:_e}function Pr(c){return"0123456789".indexOf(c)!==-1}function _i(c){var t=c instanceof Array?[]:{};for(var e in c)typeof e=="object"?t[e]=_i(c[e]):t[e]=c[e];return t}function Si(c){return c.replace(/^\s+|\s+$/g,"")}var Qe="b",_e="w",we=-1,Pe="p",Pi="n",Yt="b",_r="r",Tr="q",ht="k",Ti=function(){for(var c=[],t=V.a8;t<=V.h1;t++){if(t&136){t+=7;continue}c.push(ue(t))}return c}(),$r={NORMAL:"n",CAPTURE:"c",BIG_PAWN:"b",EP_CAPTURE:"e",PROMOTION:"p",KSIDE_CASTLE:"k",QSIDE_CASTLE:"q"},ie=function(c){var t=new Array(128),e={w:we,b:we},i=_e,n={w:0,b:0},o=we,l=0,f=1,m=[],g={},x={};ye(typeof c>"u"?ks:c);function k(h){typeof h>"u"&&(h=!1),t=new Array(128),e={w:we,b:we},i=_e,n={w:0,b:0},o=we,l=0,f=1,m=[],h||(g={}),x={},Xe(he())}function ee(){for(var h=[],u={},d=function(C){C in x&&(u[C]=x[C])};m.length>0;)h.push(ke());for(d(he());h.length>0;)Ee(h.pop()),d(he());x=u}function de(){ye(ks)}function ye(h,u){typeof u>"u"&&(u=!1);var d=h.split(/\s+/),C=d[0],b=0;if(!mt(h).valid)return!1;k(u);for(var v=0;v<C.length;v++){var y=C.charAt(v);if(y==="/")b+=8;else if(Pr(y))b+=parseInt(y,10);else{var q=y<"a"?_e:Qe;Ot({type:y.toLowerCase(),color:q},ue(b)),b++}}return i=d[1],d[2].indexOf("K")>-1&&(n.w|=M.KSIDE_CASTLE),d[2].indexOf("Q")>-1&&(n.w|=M.QSIDE_CASTLE),d[2].indexOf("k")>-1&&(n.b|=M.KSIDE_CASTLE),d[2].indexOf("q")>-1&&(n.b|=M.QSIDE_CASTLE),o=d[3]==="-"?we:V[d[3]],l=parseInt(d[4],10),f=parseInt(d[5],10),Xe(he()),!0}function mt(h){var u={0:"No errors.",1:"FEN string must contain six space-delimited fields.",2:"6th field (move number) must be a positive integer.",3:"5th field (half move counter) must be a non-negative integer.",4:"4th field (en-passant square) is invalid.",5:"3rd field (castling availability) is invalid.",6:"2nd field (side to move) is invalid.",7:"1st field (piece positions) does not contain 8 '/'-delimited rows.",8:"1st field (piece positions) is invalid [consecutive numbers].",9:"1st field (piece positions) is invalid [invalid piece].",10:"1st field (piece positions) is invalid [row too large].",11:"Illegal en-passant square"},d=h.split(/\s+/);if(d.length!==6)return{valid:!1,error_number:1,error:u[1]};if(isNaN(parseInt(d[5]))||parseInt(d[5],10)<=0)return{valid:!1,error_number:2,error:u[2]};if(isNaN(parseInt(d[4]))||parseInt(d[4],10)<0)return{valid:!1,error_number:3,error:u[3]};if(!/^(-|[abcdefgh][36])$/.test(d[3]))return{valid:!1,error_number:4,error:u[4]};if(!/^(KQ?k?q?|Qk?q?|kq?|q|-)$/.test(d[2]))return{valid:!1,error_number:5,error:u[5]};if(!/^(w|b)$/.test(d[1]))return{valid:!1,error_number:6,error:u[6]};var C=d[0].split("/");if(C.length!==8)return{valid:!1,error_number:7,error:u[7]};for(var b=0;b<C.length;b++){for(var v=0,y=!1,q=0;q<C[b].length;q++)if(isNaN(C[b][q])){if(!/^[prnbqkPRNBQK]$/.test(C[b][q]))return{valid:!1,error_number:9,error:u[9]};v+=1,y=!1}else{if(y)return{valid:!1,error_number:8,error:u[8]};v+=parseInt(C[b][q],10),y=!0}if(v!==8)return{valid:!1,error_number:10,error:u[10]}}return d[3][1]=="3"&&d[1]=="w"||d[3][1]=="6"&&d[1]=="b"?{valid:!1,error_number:11,error:u[11]}:{valid:!0,error_number:0,error:u[0]}}function he(){for(var h=0,u="",d=V.a8;d<=V.h1;d++){if(t[d]==null)h++;else{h>0&&(u+=h,h=0);var C=t[d].color,b=t[d].type;u+=C===_e?b.toUpperCase():b.toLowerCase()}d+1&136&&(h>0&&(u+=h),d!==V.h1&&(u+="/"),h=0,d+=8)}var v="";n[_e]&M.KSIDE_CASTLE&&(v+="K"),n[_e]&M.QSIDE_CASTLE&&(v+="Q"),n[Qe]&M.KSIDE_CASTLE&&(v+="k"),n[Qe]&M.QSIDE_CASTLE&&(v+="q"),v=v||"-";var y=o===we?"-":ue(o);return[u,i,v,y,l,f].join(" ")}function Ct(h){for(var u=0;u<h.length;u+=2)typeof h[u]=="string"&&typeof h[u+1]=="string"&&(g[h[u]]=h[u+1]);return g}function Xe(h){m.length>0||(h!==ks?(g.SetUp="1",g.FEN=h):(delete g.SetUp,delete g.FEN))}function qt(h){var u=t[V[h]];return u?{type:u.type,color:u.color}:null}function Ot(h,u){if(!("type"in h&&"color"in h)||vr.indexOf(h.type.toLowerCase())===-1||!(u in V))return!1;var d=V[u];return h.type==ht&&!(e[h.color]==we||e[h.color]==d)?!1:(t[d]={type:h.type,color:h.color},h.type===ht&&(e[h.color]=d),Xe(he()),!0)}function Lt(h){var u=qt(h);return t[V[h]]=null,u&&u.type===ht&&(e[u.color]=we),Xe(he()),u}function Rt(h,u,d,C,b){var v={color:i,from:u,to:d,flags:C,piece:h[u].type};return b&&(v.flags|=M.PROMOTION,v.promotion=b),h[d]?v.captured=h[d].type:C&M.EP_CAPTURE&&(v.captured=Pe),v}function me(h){function u(Ce,He,Y,le,be){if(Ce[Y].type===Pe&&(Ye(le)===wr||Ye(le)===Fr))for(var Ke=[Tr,_r,Yt,Pi],qe=0,Ze=Ke.length;qe<Ze;qe++)He.push(Rt(Ce,Y,le,be,Ke[qe]));else He.push(Rt(Ce,Y,le,be))}var d=[],C=i,b=Bt(C),v={b:Dr,w:Br},y=V.a8,q=V.h1,G=!1,z=typeof h<"u"&&"legal"in h?h.legal:!0,Z=typeof h<"u"&&"piece"in h&&typeof h.piece=="string"?h.piece.toLowerCase():!0;if(typeof h<"u"&&"square"in h)if(h.square in V)y=q=V[h.square],G=!0;else return[];for(var I=y;I<=q;I++){if(I&136){I+=7;continue}var W=t[I];if(!(W==null||W.color!==C)){if(W.type===Pe&&(Z===!0||Z===Pe)){var R=I+Ss[C][0];if(t[R]==null){u(t,d,I,R,M.NORMAL);var R=I+Ss[C][1];v[C]===Ye(I)&&t[R]==null&&u(t,d,I,R,M.BIG_PAWN)}for(H=2;H<4;H++){var R=I+Ss[C][H];R&136||(t[R]!=null&&t[R].color===b?u(t,d,I,R,M.CAPTURE):R===o&&u(t,d,I,o,M.EP_CAPTURE))}}else if(Z===!0||Z===W.type)for(var H=0,J=wi[W.type].length;H<J;H++)for(var pe=wi[W.type][H],R=I;R+=pe,!(R&136);){if(t[R]==null)u(t,d,I,R,M.NORMAL);else{if(t[R].color===C)break;u(t,d,I,R,M.CAPTURE);break}if(W.type==="n"||W.type==="k")break}}}if((Z===!0||Z===ht)&&(!G||q===e[C])){if(n[C]&M.KSIDE_CASTLE){var te=e[C],fe=te+2;t[te+1]==null&&t[fe]==null&&!Me(b,e[C])&&!Me(b,te+1)&&!Me(b,fe)&&u(t,d,e[C],fe,M.KSIDE_CASTLE)}if(n[C]&M.QSIDE_CASTLE){var te=e[C],fe=te-2;t[te-1]==null&&t[te-2]==null&&t[te-3]==null&&!Me(b,e[C])&&!Me(b,te-1)&&!Me(b,fe)&&u(t,d,e[C],fe,M.QSIDE_CASTLE)}}if(!z)return d;for(var Ie=[],I=0,J=d.length;I<J;I++)Ee(d[I]),gt(C)||Ie.push(d[I]),ke();return Ie}function We(h,u){var d="";if(h.flags&M.KSIDE_CASTLE)d="O-O";else if(h.flags&M.QSIDE_CASTLE)d="O-O-O";else{if(h.piece!==Pe){var C=kr(h,u);d+=h.piece.toUpperCase()+C}h.flags&(M.CAPTURE|M.EP_CAPTURE)&&(h.piece===Pe&&(d+=ue(h.from)[0]),d+="x"),d+=ue(h.to),h.flags&M.PROMOTION&&(d+="="+h.promotion.toUpperCase())}return Ee(h),st()&&(vt()?d+="#":d+="+"),ke(),d}function Me(h,u){for(var d=V.a8;d<=V.h1;d++){if(d&136){d+=7;continue}if(!(t[d]==null||t[d].color!==h)){var C=t[d],b=d-u,v=b+119;if(br[v]&1<<Ar[C.type]){if(C.type===Pe){if(b>0){if(C.color===_e)return!0}else if(C.color===Qe)return!0;continue}if(C.type==="n"||C.type==="k")return!0;for(var y=xr[v],q=d+y,G=!1;q!==u;){if(t[q]!=null){G=!0;break}q+=y}if(!G)return!0}}}return!1}function gt(h){return Me(Bt(h),e[h])}function st(){return gt(i)}function vt(){return st()&&me().length===0}function Et(){return!st()&&me().length===0}function it(){for(var h={},u=[],d=0,C=0,b=V.a8;b<=V.h1;b++){if(C=(C+1)%2,b&136){b+=7;continue}var v=t[b];v&&(h[v.type]=v.type in h?h[v.type]+1:1,v.type===Yt&&u.push(C),d++)}if(d===2)return!0;if(d===3&&(h[Yt]===1||h[Pi]===1))return!0;if(d===h[Yt]+2){for(var y=0,q=u.length,b=0;b<q;b++)y+=u[b];if(y===0||y===q)return!0}return!1}function nt(){for(var h=[],u={},d=!1;;){var C=ke();if(!C)break;h.push(C)}for(;;){var b=he().split(" ").slice(0,4).join(" ");if(u[b]=b in u?u[b]+1:1,u[b]>=3&&(d=!0),!h.length)break;Ee(h.pop())}return d}function xs(h){m.push({move:h,kings:{b:e.b,w:e.w},turn:i,castling:{b:n.b,w:n.w},ep_square:o,half_moves:l,move_number:f})}function Ee(h){var u=i,d=Bt(u);if(xs(h),t[h.to]=t[h.from],t[h.from]=null,h.flags&M.EP_CAPTURE&&(i===Qe?t[h.to-16]=null:t[h.to+16]=null),h.flags&M.PROMOTION&&(t[h.to]={type:h.promotion,color:u}),t[h.to].type===ht){if(e[t[h.to].color]=h.to,h.flags&M.KSIDE_CASTLE){var C=h.to-1,b=h.to+1;t[C]=t[b],t[b]=null}else if(h.flags&M.QSIDE_CASTLE){var C=h.to+1,b=h.to-2;t[C]=t[b],t[b]=null}n[u]=""}if(n[u]){for(var v=0,y=ze[u].length;v<y;v++)if(h.from===ze[u][v].square&&n[u]&ze[u][v].flag){n[u]^=ze[u][v].flag;break}}if(n[d]){for(var v=0,y=ze[d].length;v<y;v++)if(h.to===ze[d][v].square&&n[d]&ze[d][v].flag){n[d]^=ze[d][v].flag;break}}h.flags&M.BIG_PAWN?i==="b"?o=h.to-16:o=h.to+16:o=we,h.piece===Pe||h.flags&(M.CAPTURE|M.EP_CAPTURE)?l=0:l++,i===Qe&&f++,i=Bt(i)}function ke(){var h=m.pop();if(h==null)return null;var u=h.move;e=h.kings,i=h.turn,n=h.castling,o=h.ep_square,l=h.half_moves,f=h.move_number;var d=i,C=Bt(i);if(t[u.from]=t[u.to],t[u.from].type=u.piece,t[u.to]=null,u.flags&M.CAPTURE)t[u.to]={type:u.captured,color:C};else if(u.flags&M.EP_CAPTURE){var b;d===Qe?b=u.to-16:b=u.to+16,t[b]={type:Pe,color:C}}if(u.flags&(M.KSIDE_CASTLE|M.QSIDE_CASTLE)){var v,y;u.flags&M.KSIDE_CASTLE?(v=u.to+1,y=u.to-1):u.flags&M.QSIDE_CASTLE&&(v=u.to-2,y=u.to+1),t[v]=t[y],t[y]=null}return u}function Nt(h,u){for(var d=ki(h),C=0;C<2;C++){if(C==yi){if(!u)return null;var b=!1,v=d.match(/([pnbrqkPNBRQK])?([a-h][1-8])x?-?([a-h][1-8])([qrbnQRBN])?/);if(v){var y=v[1],q=v[2],G=v[3],z=v[4];q.length==1&&(b=!0)}else{var v=d.match(/([pnbrqkPNBRQK])?([a-h]?[1-8]?)x?-?([a-h][1-8])([qrbnQRBN])?/);if(v){var y=v[1],q=v[2],G=v[3],z=v[4];if(q.length==1)var b=!0}}}for(var Z=Sr(d),I=me({legal:!0,piece:y||Z}),W=0,R=I.length;W<R;W++)switch(C){case yr:{if(d===ki(We(I[W],I)))return I[W];break}case yi:if(v){if((!y||y.toLowerCase()==I[W].piece)&&V[q]==I[W].from&&V[G]==I[W].to&&(!z||z.toLowerCase()==I[W].promotion))return I[W];if(b){var H=ue(I[W].from);if((!y||y.toLowerCase()==I[W].piece)&&V[G]==I[W].to&&(q==H[0]||q==H[1])&&(!z||z.toLowerCase()==I[W].promotion))return I[W]}}}}return null}function rt(h){var u=_i(h);u.san=We(u,me({legal:!0})),u.to=ue(u.to),u.from=ue(u.from);var d="";for(var C in M)M[C]&u.flags&&(d+=$r[C]);return u.flags=d,u}function Ut(h){for(var u=me({legal:!1}),d=0,C=i,b=0,v=u.length;b<v;b++){if(Ee(u[b]),!gt(C))if(h-1>0){var y=Ut(h-1);d+=y}else d++;ke()}return d}return{load:function(h){return ye(h)},reset:function(){return de()},moves:function(h){for(var u=me(h),d=[],C=0,b=u.length;C<b;C++)typeof h<"u"&&"verbose"in h&&h.verbose?d.push(rt(u[C])):d.push(We(u[C],me({legal:!0})));return d},in_check:function(){return st()},in_checkmate:function(){return vt()},in_stalemate:function(){return Et()},in_draw:function(){return l>=100||Et()||it()||nt()},insufficient_material:function(){return it()},in_threefold_repetition:function(){return nt()},game_over:function(){return l>=100||vt()||Et()||it()||nt()},validate_fen:function(h){return mt(h)},fen:function(){return he()},board:function(){for(var h=[],u=[],d=V.a8;d<=V.h1;d++)t[d]==null?u.push(null):u.push({square:ue(d),type:t[d].type,color:t[d].color}),d+1&136&&(h.push(u),u=[],d+=8);return h},pgn:function(h){var u=typeof h=="object"&&typeof h.newline_char=="string"?h.newline_char:`
`,d=typeof h=="object"&&typeof h.max_width=="number"?h.max_width:0,C=[],b=!1;for(var v in g)C.push("["+v+' "'+g[v]+'"]'+u),b=!0;b&&m.length&&C.push(u);for(var y=function(H){var J=x[he()];if(typeof J<"u"){var pe=H.length>0?" ":"";H=`${H}${pe}{${J}}`}return H},q=[];m.length>0;)q.push(ke());var G=[],z="";for(q.length===0&&G.push(y(""));q.length>0;){z=y(z);var Z=q.pop();if(!m.length&&Z.color==="b"){let H=`${f}. ...`;z=z?`${z} ${H}`:H}else Z.color==="w"&&(z.length&&G.push(z),z=f+".");z=z+" "+We(Z,me({legal:!0})),Ee(Z)}if(z.length&&G.push(y(z)),typeof g.Result<"u"&&G.push(g.Result),d===0)return C.join("")+G.join(" ");for(var I=function(){return C.length>0&&C[C.length-1]===" "?(C.pop(),!0):!1},W=function(H,J){for(var pe of J.split(" "))if(pe){if(H+pe.length>d){for(;I();)H--;C.push(u),H=0}C.push(pe),H+=pe.length,C.push(" "),H++}return I()&&H--,H},R=0,v=0;v<G.length;v++){if(R+G[v].length>d&&G[v].includes("{")){R=W(R,G[v]);continue}R+G[v].length>d&&v!==0?(C[C.length-1]===" "&&C.pop(),C.push(u),R=0):v!==0&&(C.push(" "),R++),C.push(G[v]),R+=G[v].length}return C.join("")},load_pgn:function(h,u){var d=typeof u<"u"&&"sloppy"in u?u.sloppy:!1;function C(Y){return Y.replace(/\\/g,"\\")}function b(Y,le){for(var be=typeof le=="object"&&typeof le.newline_char=="string"?le.newline_char:`\r?
`,Ke={},qe=Y.split(new RegExp(C(be))),Ze="",bt="",Je=0;Je<qe.length;Je++){var Gt=/^\s*\[([A-Za-z]+)\s*"(.*)"\s*\]\s*$/;Ze=qe[Je].replace(Gt,"$1"),bt=qe[Je].replace(Gt,"$2"),Si(Ze).length>0&&(Ke[Ze]=bt)}return Ke}h=h.trim();var v=typeof u=="object"&&typeof u.newline_char=="string"?u.newline_char:`\r?
`,y=new RegExp("^(\\[((?:"+C(v)+")|.)*\\])(?:\\s*"+C(v)+"){2}"),q=y.test(h)?y.exec(h)[1]:"";de();var G=b(q,u),z="";for(var Z in G)Z.toLowerCase()==="fen"&&(z=G[Z]),Ct([Z,G[Z]]);if(d){if(z&&!ye(z,!0))return!1}else if(G.SetUp==="1"&&!("FEN"in G&&ye(G.FEN,!0)))return!1;for(var I=function(Y){return Array.from(Y).map(function(le){return le.charCodeAt(0)<128?le.charCodeAt(0).toString(16):encodeURIComponent(le).replace(/\%/g,"").toLowerCase()}).join("")},W=function(Y){return Y.length==0?"":decodeURIComponent("%"+Y.match(/.{1,2}/g).join("%"))},R=function(Y){return Y=Y.replace(new RegExp(C(v),"g")," "),`{${I(Y.slice(1,Y.length-1))}}`},H=function(Y){if(Y.startsWith("{")&&Y.endsWith("}"))return W(Y.slice(1,Y.length-1))},J=h.replace(q,"").replace(new RegExp(`({[^}]*})+?|;([^${C(v)}]*)`,"g"),function(Y,le,be){return le!==void 0?R(le):" "+R(`{${be.slice(1)}}`)}).replace(new RegExp(C(v),"g")," "),pe=/(\([^\(\)]+\))+?/g;pe.test(J);)J=J.replace(pe,"");J=J.replace(/\d+\.(\.\.)?/g,""),J=J.replace(/\.\.\./g,""),J=J.replace(/\$\d+/g,"");var te=Si(J).split(new RegExp(/\s+/));te=te.join(",").replace(/,,+/g,",").split(",");for(var fe="",Ie="",Ce=0;Ce<te.length;Ce++){var He=H(te[Ce]);if(He!==void 0){x[he()]=He;continue}if(fe=Nt(te[Ce],d),fe==null)if(Er.indexOf(te[Ce])>-1)Ie=te[Ce];else return!1;else Ie="",Ee(fe)}return Ie&&Object.keys(g).length&&!g.Result&&Ct(["Result",Ie]),!0},header:function(){return Ct(arguments)},turn:function(){return i},move:function(h,u){var d=typeof u<"u"&&"sloppy"in u?u.sloppy:!1,C=null;if(typeof h=="string")C=Nt(h,d);else if(typeof h=="object"){for(var b=me(),v=0,y=b.length;v<y;v++)if(h.from===ue(b[v].from)&&h.to===ue(b[v].to)&&(!("promotion"in b[v])||h.promotion===b[v].promotion)){C=b[v];break}}if(!C)return null;var q=rt(C);return Ee(C),q},undo:function(){var h=ke();return h?rt(h):null},clear:function(){return k()},put:function(h,u){return Ot(h,u)},get:function(h){return qt(h)},ascii(){for(var h=`   +------------------------+
`,u=V.a8;u<=V.h1;u++){if(Dt(u)===0&&(h+=" "+"87654321"[Ye(u)]+" |"),t[u]==null)h+=" . ";else{var d=t[u].type,C=t[u].color,b=C===_e?d.toUpperCase():d.toLowerCase();h+=" "+b+" "}u+1&136&&(h+=`|
`,u+=8)}return h+=`   +------------------------+
`,h+="     a  b  c  d  e  f  g  h",h},remove:function(h){return Lt(h)},perft:function(h){return Ut(h)},square_color:function(h){if(h in V){var u=V[h];return(Ye(u)+Dt(u))%2===0?"light":"dark"}return null},history:function(h){for(var u=[],d=[],C=typeof h<"u"&&("verbose"in h)&&h.verbose;m.length>0;)u.push(ke());for(;u.length>0;){var b=u.pop();C?d.push(rt(b)):d.push(We(b,me({legal:!0}))),Ee(b)}return d},get_comment:function(){return x[he()]},set_comment:function(h){x[he()]=h.replace("{","[").replace("}","]")},delete_comment:function(){var h=x[he()];return delete x[he()],h},get_comments:function(){return ee(),Object.keys(x).map(function(h){return{fen:h,comment:x[h]}})},delete_comments:function(){return ee(),Object.keys(x).map(function(h){var u=x[h];return delete x[h],{fen:h,comment:u}})}}};function Mr(c,t){this.fen=c,this.notation=t,this.toString=function(){return"IllegalMoveException: "+c+" => "+t}}var wt=class{constructor(t=null,e=null,i=!1){if(!t)this.clear();else{let n=Qt.parse(t.replace(/\s\s+/g," ").replace(/\n/g," "));this.moves=this.traverse(n[0],e,null,1,i)}this.setUpFen=e}clear(){this.moves=[]}traverse(t,e,i=null,n=1,o=!1){let l=e?new ie(e):new ie,f=[],m=i;for(let g of t){if(g.notation){let x=g.notation.notation,k=l.move(x,{sloppy:o});if(k){m?(k.previous=m,m.next=k):k.previous=null,k.ply=n,this.fillMoveFromChessState(k,l),g.nag&&(k.nag=g.nag[0]),g.commentBefore&&(k.commentBefore=g.commentBefore),g.commentMove&&(k.commentMove=g.commentMove),g.commentAfter&&(k.commentAfter=g.commentAfter),k.variations=[];let ee=g.variations;if(ee.length>0){let de=f.length>0?f[f.length-1].fen:e;for(let ye of ee)k.variations.push(this.traverse(ye,de,m,n,o))}k.variation=f,f.push(k),m=k}else throw new Mr(l.fen(),x)}n++}return f}fillMoveFromChessState(t,e){t.fen=e.fen(),t.uci=t.from+t.to+(t.promotion?t.promotion:""),t.variations=[],e.game_over()&&(t.gameOver=!0,e.in_draw()&&(t.inDraw=!0),e.in_stalemate()&&(t.inStalemate=!0),e.insufficient_material()&&(t.insufficientMaterial=!0),e.in_threefold_repetition()&&(t.inThreefoldRepetition=!0),e.in_checkmate()&&(t.inCheckmate=!0)),e.in_check()&&(t.inCheck=!0)}historyToMove(t){let e=[],i=t;for(e.push(i);i.previous;)e.push(i.previous),i=i.previous;return e.reverse()}validateMove(t,e=null,i=!0){e||this.moves.length>0&&(e=this.moves[this.moves.length-1]);let n=new ie(this.setUpFen?this.setUpFen:void 0);if(e){let l=this.historyToMove(e);for(let f of l)n.move(f)}let o=n.move(t,{sloppy:i});return o&&this.fillMoveFromChessState(o,n),o}addMove(t,e=null,i=!0){e||this.moves.length>0&&(e=this.moves[this.moves.length-1]);let n=this.validateMove(t,e,i);if(!n)throw new Error("invalid move");return n.previous=e,e?(n.ply=e.ply+1,n.uci=n.from+n.to+(n.promotion?n.promotion:""),e.next?(e.next.variations.push([]),n.variation=e.next.variations[e.next.variations.length-1],n.variation.push(n)):(e.next=n,n.variation=e.variation,e.variation.push(n))):(n.variation=this.moves,n.ply=1,this.moves.push(n)),n}render(t=!0,e=!0){let i=(o,l=!1)=>{let f="";for(let m of o){if(m.ply%2===1?f+=Math.floor(m.ply/2)+1+". ":(f.length===0||l)&&(f+=m.ply/2+"... "),l=!1,e&&m.nag&&(f+="$"+m.nag+" "),t&&m.commentBefore&&(f+="{"+m.commentBefore+"} ",l=!0),f+=m.san+" ",t&&m.commentMove&&(f+="{"+m.commentMove+"} ",l=!0),t&&m.commentAfter&&(f+="{"+m.commentAfter+"} ",l=!0),m.variations.length>0)for(let g of m.variations)f+="("+i(g)+") ",l=!0;f+=" "}return f},n=i(this.moves);return n=n.replace(/\s+\)/g,")"),n=n.replace(/\s\s+/g," ").trim(),n}};var yt=class{constructor(t="",e={}){let i=t.trim().slice(-1)==="]"?t.length:t.lastIndexOf(`]

`)+1,n=t.substring(0,i),o=t.substring(i),l=!!e.sloppy;this.header=new zt(n),this.header.tags[De.SetUp]==="1"&&this.header.tags[De.FEN]?this.history=new wt(o,this.header.tags[De.FEN],l):this.history=new wt(o,null,l)}wrap(t,e){let i=t.split(" "),n=[],o="";for(let l=0;l<i.length;l++){let f=i[l];o.length+f.length<e?o+=f+" ":(n.push(o.trim()),o=f+" ")}return n.push(o.trim()),n.join(`
`)}render(t=!0,e=!0,i=!0){let n=t?this.header.render()+`
`:"",o=this.history.render(e,i);return this.header.tags[De.Result]&&(o+=" "+this.header.tags[De.Result]),n+this.wrap(o,80)}};var Ps={p:{name:"pawn",value:1},n:{name:"knight",value:3},b:{name:"bishop",value:3},r:{name:"rook",value:5},q:{name:"queen",value:9},k:{name:"king",value:1/0}},re={white:"w",black:"b"},ut={empty:"8/8/8/8/8/8/8/8 w - - 0 1",start:"rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1"},kt={illegalMove:"illegalMove",legalMove:"legalMove",undoMove:"undoMove",initialized:"initialized"};function St(c,t){for(let e of c)setTimeout(()=>{e(t)})}var jt=class{constructor(t=ut.start){this.observers=[],typeof t=="string"?this.load(t):t.fen?this.load(t.fen):t.pgn?this.loadPgn(t.pgn):this.load(ut.start)}fen(t=this.lastMove()){return t?t.fen:this.setUpFen()}setUpFen(){return this.pgn.header.tags[De.SetUp]?this.pgn.header.tags[De.FEN]:ut.start}header(){return this.pgn.header.tags}gameOver(t=this.lastMove()){return t?t.gameOver:new ie(this.fen()).game_over()}inDraw(t=this.lastMove()){return t?t.inDraw===!0:new ie(this.fen()).in_draw()}inStalemate(t=this.lastMove()){return t?t.inStalemate===!0:new ie(this.fen()).in_stalemate()}insufficientMaterial(t=this.lastMove()){return t?t.insufficientMaterial===!0:new ie(this.fen()).insufficient_material()}inThreefoldRepetition(t=this.lastMove()){return t&&t.inThreefoldRepetition===!0}inCheckmate(t=this.lastMove()){return t?t.inCheckmate===!0:new ie(this.fen()).in_checkmate()}inCheck(t=this.lastMove()){return t?t.inCheck===!0:new ie(this.fen()).in_check()}history(){return this.pgn.history.moves}lastMove(){return this.pgn.history.moves.length>0?this.pgn.history.moves[this.pgn.history.moves.length-1]:null}load(t){let e=new ie(t);if(e&&e.fen()===t)this.pgn=new yt,t!==ut.start&&(this.pgn.header.tags[De.SetUp]="1",this.pgn.header.tags[De.FEN]=e.fen(),this.pgn.history.setUpFen=t);else throw Error("Invalid fen "+t);St(this.observers,{type:kt.initialized,fen:t})}loadPgn(t){this.pgn=new yt(t),St(this.observers,{type:kt.initialized,pgn:t})}move(t,e=void 0,i=!0){try{let n=this.pgn.history.addMove(t,e,i);return St(this.observers,{type:kt.legalMove,move:n,previousMove:e}),n}catch{return St(this.observers,{type:kt.illegalMove,move:t,previousMove:e}),null}}moves(t=void 0,e=this.lastMove()){return new ie(this.fen(e)).moves(t)}validateMove(t,e=void 0,i=!0){return this.pgn.history.validateMove(t,e,i)}renderPgn(t=!0,e=!0,i=!0){return this.pgn.render(t,e,i)}pieces(t=void 0,e=void 0,i=this.lastMove()){let n=i?new ie(i.fen):new ie(this.fen()),o=[];for(let l=0;l<64;l++){let f=Ti[l],m=n.get(f);m&&(m.square=f),t?(!e&&m&&m.type===t||m&&m.color===e&&m.type===t)&&o.push(m):!e&&m&&o.push(m)}return o}piece(t,e=this.lastMove()){return(e?new ie(e.fen):new ie(this.fen())).get(t)}turn(){let t=0;return this.setUpFen()&&this.setUpFen().split(" ")[1]===re.black&&(t=1),this.pgn.history.moves.length%2===t?re.white:re.black}undo(t=this.lastMove()){t.previous&&(t.previous.next=void 0);let e=t.variation.findIndex(i=>i.ply===t.ply);t.variation=t.variation.splice(e),St(this.observers,{type:kt.undoMove,move:t})}plyCount(){return this.history().length}fenOfPly(t){return t>0?this.history()[t-1].fen:this.setUpFen()}addObserver(t){this.observers.push(t)}};var je={start:"rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1",empty:"8/8/8/8/8/8/8/8"},ce=class c{constructor(t=je.empty){this.squares=new Array(64).fill(null),this.setFen(t)}setFen(t=je.empty){let e=t.replace(/^\s*/,"").replace(/\s*$/,"").split(/\/|\s/);for(let i=0;i<8;i++){let n=e[7-i].replace(/\d/g,o=>{let l=parseInt(o),f="";for(let m=0;m<l;m++)f+="-";return f});for(let o=0;o<8;o++){let l=n.substring(o,o+1),f=null;l!=="-"&&(l.toUpperCase()===l?f=`w${l.toLowerCase()}`:f=`b${l}`),this.squares[i*8+o]=f}}}getFen(){let t=new Array(8).fill("");for(let e=0;e<8;e++){let i=0;for(let n=0;n<8;n++){let o=this.squares[e*8+n];if(!o)i++;else{i>0&&(t[7-e]+=i,i=0);let l=o.substring(0,1),f=o.substring(1,2);l==="w"?t[7-e]+=f.toUpperCase():t[7-e]+=f}}i>0&&(t[7-e]+=i,i=0)}return t.join("/")}getPieces(t=["k","q","r","b","n","p"]){let e=[],i=(n,o)=>t.indexOf(n.name)-t.indexOf(o.name);for(let n=0;n<64;n++){let o=this.squares[n];o&&e.push({name:o.charAt(1),color:o.charAt(0),position:c.indexToSquare(n)})}return t&&e.sort(i),e}movePiece(t,e){if(!this.squares[c.squareToIndex(t)]){console.warn("no piece on",t);return}this.squares[c.squareToIndex(e)]=this.squares[c.squareToIndex(t)],this.squares[c.squareToIndex(t)]=null}setPiece(t,e){this.squares[c.squareToIndex(t)]=e}getPiece(t){return this.squares[c.squareToIndex(t)]}static squareToIndex(t){let e=c.squareToCoordinates(t);return e[0]+e[1]*8}static indexToSquare(t){return this.coordinatesToSquare([Math.floor(t%8),t/8])}static squareToCoordinates(t){let e=t.charCodeAt(0)-97,i=t.charCodeAt(1)-49;return[e,i]}static coordinatesToSquare(t){let e=String.fromCharCode(t[0]+97),i=String.fromCharCode(t[1]+49);return e+i}clone(){let t=new c;return t.squares=this.squares.slice(0),t}};var Xt=class{constructor(){this.position=new ce,this.orientation=void 0,this.inputWhiteEnabled=!1,this.inputBlackEnabled=!1,this.moveInputCallback=null,this.extensionPoints={},this.moveInputProcess=Promise.resolve()}inputEnabled(){return this.inputWhiteEnabled||this.inputBlackEnabled}invokeExtensionPoints(t,e={}){let i=this.extensionPoints[t],n=Object.assign({},e);n.extensionPoint=t;let o=!0;if(i)for(let l of i)l(n)===!1&&(o=!1);return o}};var $i="http://www.w3.org/2000/svg",O=class{static createSvg(t=void 0){let e=document.createElementNS($i,"svg");return t&&(e.setAttribute("width","100%"),e.setAttribute("height","100%"),t.appendChild(e)),e}static addElement(t,e,i={}){let n=document.createElementNS($i,e);e==="use"&&(i["xlink:href"]=i.href);for(let o in i)if(i.hasOwnProperty(o))if(o.indexOf(":")!==-1){let l=o.split(":");n.setAttributeNS("http://www.w3.org/1999/"+l[0],l[1],i[o])}else n.setAttribute(o,i[o]);return t.appendChild(n),n}static removeElement(t){if(!t){console.warn("removeElement, element is",t);return}t.parentNode?t.parentNode.removeChild(t):console.warn(t,"without parentNode")}};var L={positionChanged:"positionChanged",boardChanged:"boardChanged",moveInputToggled:"moveInputToggled",moveInput:"moveInput",beforeRedrawBoard:"beforeRedrawBoard",afterRedrawBoard:"afterRedrawBoard",redrawBoard:"redrawBoard",animation:"animation",destroy:"destroy"},Te=class{constructor(t){this.chessboard=t}registerExtensionPoint(t,e){t===L.redrawBoard&&(console.warn("EXTENSION_POINT.redrawBoard is deprecated, use EXTENSION_POINT.afterRedrawBoard"),t=L.afterRedrawBoard),this.chessboard.state.extensionPoints[t]||(this.chessboard.state.extensionPoints[t]=[]),this.chessboard.state.extensionPoints[t].push(e)}registerMethod(t,e){console.warn("registerMethod is deprecated, just add methods directly to the chessboard instance"),this.chessboard[t]?log.error("method",t,"already exists"):this.chessboard[t]=(...i)=>e.apply(this,i)}};var oe=class c{static delegate(t,e,i,n){let o=function(l){let f=l.target;for(;f&&f!==this;)f.matches(i)&&n.call(f,l),f=f.parentNode};return t.addEventListener(e,o),{remove:function(){t.removeEventListener(e,o)}}}static mergeObjects(t,e){let i=n=>n&&typeof n=="object";if(!i(t)||!i(e))return e;for(let n of Object.keys(e))e[n]instanceof Object&&Object.assign(e[n],c.mergeObjects(t[n],e[n]));return Object.assign(t||{},e),t}static createDomElement(t){let e=document.createElement("template");return e.innerHTML=t.trim(),e.content.firstChild}static createTask(){let t,e,i=new Promise(function(n,o){t=n,e=o});return i.resolve=t,i.reject=e,i}static isAbsoluteUrl(t){return t.indexOf("://")!==-1||t.startsWith("/")}};var _s={start:"start",frame:"frame",end:"end"},Ts=class{constructor(){this.queue=[],this.workingOnPromise=!1,this.stop=!1}async enqueue(t){return new Promise((e,i)=>{this.queue.push({promise:t,resolve:e,reject:i}),this.dequeue()})}dequeue(){if(this.workingOnPromise)return;if(this.stop){this.queue=[],this.stop=!1;return}let t=this.queue.shift();if(t){try{this.workingOnPromise=!0,t.promise().then(e=>{this.workingOnPromise=!1,t.resolve(e),this.dequeue()}).catch(e=>{this.workingOnPromise=!1,t.reject(e),this.dequeue()})}catch(e){this.workingOnPromise=!1,t.reject(e),this.dequeue()}return!0}}destroy(){this.stop=!0}},$e={move:0,appear:1,disappear:2},Pt=class c{constructor(t,e,i,n,o){this.view=t,e&&i?(this.animatedElements=this.createAnimation(e.squares,i.squares),this.duration=n,this.callback=o,this.frameHandle=requestAnimationFrame(this.animationStep.bind(this))):console.error("fromPosition",e,"toPosition",i),this.view.positionsAnimationTask=oe.createTask(),this.view.chessboard.state.invokeExtensionPoints(L.animation,{type:_s.start})}static seekChanges(t,e){let i=[],n=[],o=[];for(let l=0;l<64;l++){let f=t[l],m=e[l];m!==f&&(m&&i.push({piece:m,index:l}),f&&n.push({piece:f,index:l}))}return i.forEach(l=>{let f=8,m=null;n.forEach(g=>{if(l.piece===g.piece){let x=c.squareDistance(l.index,g.index);x<f&&(m=g,f=x)}}),m?(n.splice(n.indexOf(m),1),o.push({type:$e.move,piece:l.piece,atIndex:m.index,toIndex:l.index})):o.push({type:$e.appear,piece:l.piece,atIndex:l.index})}),n.forEach(l=>{o.push({type:$e.disappear,piece:l.piece,atIndex:l.index})}),o}createAnimation(t,e){let i=c.seekChanges(t,e),n=[];return i.forEach(o=>{let l={type:o.type};switch(o.type){case $e.move:l.element=this.view.getPieceElement(ce.indexToSquare(o.atIndex)),l.element.parentNode.appendChild(l.element),l.atPoint=this.view.indexToPoint(o.atIndex),l.toPoint=this.view.indexToPoint(o.toIndex);break;case $e.appear:l.element=this.view.drawPieceOnSquare(ce.indexToSquare(o.atIndex),o.piece),l.element.style.opacity=0;break;case $e.disappear:l.element=this.view.getPieceElement(ce.indexToSquare(o.atIndex));break}n.push(l)}),n}animationStep(t){if(!this.view||!this.view.chessboard.state)return;this.startTime||(this.startTime=t);let e=t-this.startTime;if(e<=this.duration)this.frameHandle=requestAnimationFrame(this.animationStep.bind(this));else{cancelAnimationFrame(this.frameHandle),this.animatedElements.forEach(o=>{o.type===$e.disappear&&O.removeElement(o.element)}),this.view.positionsAnimationTask.resolve(),this.view.chessboard.state.invokeExtensionPoints(L.animation,{type:_s.end}),this.callback();return}let i=Math.min(1,e/this.duration),n=i<.5?2*i*i:-1+(4-2*i)*i;(isNaN(n)||n>.99)&&(n=1),this.animatedElements.forEach(o=>{if(o.element)switch(o.type){case $e.move:o.element.transform.baseVal.removeItem(0);let l=this.view.svg.createSVGTransform();l.setTranslate(o.atPoint.x+(o.toPoint.x-o.atPoint.x)*n,o.atPoint.y+(o.toPoint.y-o.atPoint.y)*n),o.element.transform.baseVal.appendItem(l);break;case $e.appear:o.element.style.opacity=Math.round(n*100)/100;break;case $e.disappear:o.element.style.opacity=Math.round((1-n)*100)/100;break}else console.warn("animatedItem has no element",o)}),this.view.chessboard.state.invokeExtensionPoints(L.animation,{type:_s.frame,progress:n})}static squareDistance(t,e){let i=t%8,n=Math.floor(t/8),o=e%8,l=Math.floor(e/8);return Math.max(Math.abs(l-n),Math.abs(o-i))}},Zt=class extends Ts{constructor(t){super(),this.chessboard=t}async enqueuePositionChange(t,e,i){return t.getFen()===e.getFen()?Promise.resolve():super.enqueue(()=>new Promise(n=>{let o=i?this.chessboard.props.style.animationDuration:0;this.queue.length>0&&(o=o/(1+Math.pow(this.queue.length/5,2))),new Pt(this.chessboard.view,t,e,i?o:0,()=>{this.chessboard.view&&this.chessboard.view.redrawPieces(e.squares),n()})}))}async enqueueTurnBoard(t,e,i){return super.enqueue(()=>new Promise(n=>{let o=new ce(je.empty),l=i?this.chessboard.props.style.animationDuration:0;this.queue.length>0&&(l=l/(1+Math.pow(this.queue.length/5,2))),new Pt(this.chessboard.view,t,o,i?l:0,()=>{this.chessboard.state.orientation=e,this.chessboard.view.redrawBoard(),this.chessboard.view.redrawPieces(o.squares),new Pt(this.chessboard.view,o,t,i?l:0,()=>{this.chessboard.view.redrawPieces(t.squares),n()})})}))}};var D={waitForInputStart:"waitForInputStart",pieceClickedThreshold:"pieceClickedThreshold",clickTo:"clickTo",secondClickThreshold:"secondClickThreshold",dragTo:"dragTo",clickDragTo:"clickDragTo",moveDone:"moveDone",reset:"reset"},_t={secondClick:"secondClick",secondaryClick:"secondaryClick",movedOutOfBoard:"movedOutOfBoard",draggedBack:"draggedBack",clickedAnotherPiece:"clickedAnotherPiece"},Mi=4,Jt=class{constructor(t){this.view=t,this.chessboard=t.chessboard,this.moveInputState=null,this.fromSquare=null,this.toSquare=null,this.setMoveInputState(D.waitForInputStart)}moveInputStartedCallback(t){let e=this.view.moveInputStartedCallback(t);return e&&(this.chessboard.state.moveInputProcess=oe.createTask(),this.chessboard.state.moveInputProcess.then(i=>{(this.moveInputState===D.waitForInputStart||this.moveInputState===D.moveDone)&&this.view.moveInputFinishedCallback(this.fromSquare,this.toSquare,i)})),e}movingOverSquareCallback(t,e){this.view.movingOverSquareCallback(t,e)}validateMoveInputCallback(t,e){let i=this.view.validateMoveInputCallback(t,e);return this.chessboard.state.moveInputProcess.resolve(i),i}moveInputCanceledCallback(t,e,i){this.view.moveInputCanceledCallback(t,e,i),this.chessboard.state.moveInputProcess.resolve()}setMoveInputState(t,e=void 0){let i=this.moveInputState;switch(this.moveInputState=t,t){case D.waitForInputStart:break;case D.pieceClickedThreshold:if(D.waitForInputStart!==i&&D.clickTo!==i)throw new Error("moveInputState");if(this.pointerMoveListener&&(removeEventListener(this.pointerMoveListener.type,this.pointerMoveListener),this.pointerMoveListener=null),this.pointerUpListener&&(removeEventListener(this.pointerUpListener.type,this.pointerUpListener),this.pointerUpListener=null),this.fromSquare=e.square,this.toSquare=null,this.movedPiece=e.piece,this.startPoint=e.point,!this.pointerMoveListener&&!this.pointerUpListener){if(e.type==="mousedown")this.pointerMoveListener=this.onPointerMove.bind(this),this.pointerMoveListener.type="mousemove",addEventListener("mousemove",this.pointerMoveListener),this.pointerUpListener=this.onPointerUp.bind(this),this.pointerUpListener.type="mouseup",addEventListener("mouseup",this.pointerUpListener);else if(e.type==="touchstart")this.pointerMoveListener=this.onPointerMove.bind(this),this.pointerMoveListener.type="touchmove",addEventListener("touchmove",this.pointerMoveListener),this.pointerUpListener=this.onPointerUp.bind(this),this.pointerUpListener.type="touchend",addEventListener("touchend",this.pointerUpListener);else throw Error("4b74af");this.contextMenuListener||(this.contextMenuListener=this.onContextMenu.bind(this),this.chessboard.view.svg.addEventListener("contextmenu",this.contextMenuListener))}else throw Error("94ad0c");break;case D.clickTo:this.draggablePiece&&(O.removeElement(this.draggablePiece),this.draggablePiece=null),i===D.dragTo&&this.view.setPieceVisibility(e.square,!0);break;case D.secondClickThreshold:if(D.clickTo!==i)throw new Error("moveInputState");this.startPoint=e.point;break;case D.dragTo:if(D.pieceClickedThreshold!==i)throw new Error("moveInputState");this.view.chessboard.state.inputEnabled()&&(this.view.setPieceVisibility(e.square,!1),this.createDraggablePiece(e.piece));break;case D.clickDragTo:if(D.secondClickThreshold!==i)throw new Error("moveInputState");this.view.chessboard.state.inputEnabled()&&(this.view.setPieceVisibility(e.square,!1),this.createDraggablePiece(e.piece));break;case D.moveDone:if([D.dragTo,D.clickTo,D.clickDragTo].indexOf(i)===-1)throw new Error("moveInputState");this.toSquare=e.square,this.toSquare&&this.validateMoveInputCallback(this.fromSquare,this.toSquare)?this.chessboard.movePiece(this.fromSquare,this.toSquare,i===D.clickTo).then(()=>{i===D.clickTo&&this.view.setPieceVisibility(this.toSquare,!0),this.setMoveInputState(D.reset)}):(this.view.setPieceVisibility(this.fromSquare,!0),this.setMoveInputState(D.reset));break;case D.reset:this.fromSquare&&!this.toSquare&&this.movedPiece&&this.chessboard.state.position.setPiece(this.fromSquare,this.movedPiece),this.fromSquare=null,this.toSquare=null,this.movedPiece=null,this.draggablePiece&&(O.removeElement(this.draggablePiece),this.draggablePiece=null),this.pointerMoveListener&&(removeEventListener(this.pointerMoveListener.type,this.pointerMoveListener),this.pointerMoveListener=null),this.pointerUpListener&&(removeEventListener(this.pointerUpListener.type,this.pointerUpListener),this.pointerUpListener=null),this.contextMenuListener&&(removeEventListener("contextmenu",this.contextMenuListener),this.contextMenuListener=null),this.setMoveInputState(D.waitForInputStart);let n=this.view.piecesGroup.querySelectorAll("[visibility=hidden]");for(let o=0;o<n.length;o++)n[o].removeAttribute("visibility");break;default:throw Error(`260b09: moveInputState ${t}`)}}createDraggablePiece(t){if(this.draggablePiece)throw Error("draggablePiece already exists");this.draggablePiece=O.createSvg(document.body),this.draggablePiece.classList.add("cm-chessboard-draggable-piece"),this.draggablePiece.setAttribute("width",this.view.squareWidth),this.draggablePiece.setAttribute("height",this.view.squareHeight),this.draggablePiece.setAttribute("style","pointer-events: none"),this.draggablePiece.name=t;let e=this.chessboard.props.assetsCache?"":this.view.getSpriteUrl(),i=O.addElement(this.draggablePiece,"use",{href:`${e}#${t}`}),n=this.view.squareHeight/this.chessboard.props.style.pieces.tileSize,o=this.draggablePiece.createSVGTransform();o.setScale(n,n),i.transform.baseVal.appendItem(o)}moveDraggablePiece(t,e){this.draggablePiece.setAttribute("style",`pointer-events: none; position: absolute; left: ${t-this.view.squareHeight/2}px; top: ${e-this.view.squareHeight/2}px`)}onPointerDown(t){if(!(t.type==="mousedown"&&t.button===0||t.type==="touchstart"))return;let e=t.target.getAttribute("data-square");if(!e)return;let i=this.chessboard.getPiece(e),n;if(i&&(n=i?i.substring(0,1):null,(n==="w"&&this.chessboard.state.inputWhiteEnabled||n==="b"&&this.chessboard.state.inputBlackEnabled)&&t.preventDefault()),this.moveInputState!==D.waitForInputStart||this.chessboard.state.inputWhiteEnabled&&n==="w"||this.chessboard.state.inputBlackEnabled&&n==="b"){let o;if(t.type==="mousedown"?o={x:t.clientX,y:t.clientY}:t.type==="touchstart"&&(o={x:t.touches[0].clientX,y:t.touches[0].clientY}),this.moveInputState===D.waitForInputStart&&i&&this.moveInputStartedCallback(e))this.setMoveInputState(D.pieceClickedThreshold,{square:e,piece:i,point:o,type:t.type});else if(this.moveInputState===D.clickTo)if(e===this.fromSquare)this.setMoveInputState(D.secondClickThreshold,{square:e,piece:i,point:o,type:t.type});else{let l=this.chessboard.getPiece(e),f=l?l.substring(0,1):null,m=this.chessboard.getPiece(this.fromSquare),g=m?m.substring(0,1):null;n&&g===f?(this.moveInputCanceledCallback(this.fromSquare,e,_t.clickedAnotherPiece),this.moveInputStartedCallback(e)?this.setMoveInputState(D.pieceClickedThreshold,{square:e,piece:l,point:o,type:t.type}):this.setMoveInputState(D.reset)):this.setMoveInputState(D.moveDone,{square:e})}}}onPointerMove(t){let e,i,n,o,l;if(t.type==="mousemove"?(n=t.clientX,o=t.clientY,e=t.pageX,i=t.pageY,l=t.target):t.type==="touchmove"&&(n=t.touches[0].clientX,o=t.touches[0].clientY,e=t.touches[0].pageX,i=t.touches[0].pageY,l=document.elementFromPoint(n,o)),this.moveInputState===D.pieceClickedThreshold||this.moveInputState===D.secondClickThreshold)(Math.abs(this.startPoint.x-n)>Mi||Math.abs(this.startPoint.y-o)>Mi)&&(this.moveInputState===D.secondClickThreshold?this.setMoveInputState(D.clickDragTo,{square:this.fromSquare,piece:this.movedPiece}):this.setMoveInputState(D.dragTo,{square:this.fromSquare,piece:this.movedPiece}),this.view.chessboard.state.inputEnabled()&&this.moveDraggablePiece(e,i));else if(this.moveInputState===D.dragTo||this.moveInputState===D.clickDragTo||this.moveInputState===D.clickTo){if(l&&l.getAttribute&&l.parentElement===this.view.boardGroup){let f=l.getAttribute("data-square");f!==this.fromSquare&&f!==this.toSquare?(this.toSquare=f,this.movingOverSquareCallback(this.fromSquare,this.toSquare)):f===this.fromSquare&&this.toSquare!==null&&(this.toSquare=null,this.movingOverSquareCallback(this.fromSquare,null))}else this.toSquare!==null&&(this.toSquare=null,this.movingOverSquareCallback(this.fromSquare,null));this.view.chessboard.state.inputEnabled()&&(this.moveInputState===D.dragTo||this.moveInputState===D.clickDragTo)&&this.moveDraggablePiece(e,i)}}onPointerUp(t){let e;if(t.type==="mouseup"?e=t.target:t.type==="touchend"&&(e=document.elementFromPoint(t.changedTouches[0].clientX,t.changedTouches[0].clientY)),e&&e.getAttribute){let i=e.getAttribute("data-square");if(i)this.moveInputState===D.dragTo||this.moveInputState===D.clickDragTo?this.fromSquare===i?this.moveInputState===D.clickDragTo?(this.chessboard.state.position.setPiece(this.fromSquare,this.movedPiece),this.view.setPieceVisibility(this.fromSquare),this.moveInputCanceledCallback(i,null,_t.draggedBack),this.setMoveInputState(D.reset)):this.setMoveInputState(D.clickTo,{square:i}):this.setMoveInputState(D.moveDone,{square:i}):this.moveInputState===D.pieceClickedThreshold?this.setMoveInputState(D.clickTo,{square:i}):this.moveInputState===D.secondClickThreshold&&(this.setMoveInputState(D.reset),this.moveInputCanceledCallback(i,null,_t.secondClick));else{this.view.redrawPieces();let n=this.fromSquare;this.setMoveInputState(D.reset),this.moveInputCanceledCallback(n,null,_t.movedOutOfBoard)}}else this.view.redrawPieces(),this.setMoveInputState(D.reset)}onContextMenu(t){t.preventDefault(),this.view.redrawPieces(),this.setMoveInputState(D.reset),this.moveInputCanceledCallback(this.fromSquare,null,_t.secondaryClick)}isDragging(){return this.moveInputState===D.dragTo||this.moveInputState===D.clickDragTo}destroy(){this.setMoveInputState(D.reset)}};var es=class{constructor(t){this.chessboard=t,this.visualMoveInput=new Jt(this),t.props.assetsCache&&this.cacheSpriteToDiv("cm-chessboard-sprite",this.getSpriteUrl()),this.container=document.createElement("div"),this.chessboard.context.appendChild(this.container),t.props.responsive&&(typeof ResizeObserver<"u"?(this.resizeObserver=new ResizeObserver(()=>{setTimeout(()=>{this.handleResize()})}),this.resizeObserver.observe(this.chessboard.context)):(this.resizeListener=this.handleResize.bind(this),window.addEventListener("resize",this.resizeListener))),this.positionsAnimationTask=Promise.resolve(),this.pointerDownListener=this.pointerDownHandler.bind(this),this.pointerDownListener=this.pointerDownHandler.bind(this),this.container.addEventListener("mousedown",this.pointerDownListener),this.container.addEventListener("touchstart",this.pointerDownListener,{passive:!1}),this.createSvgAndGroups(),this.handleResize()}pointerDownHandler(t){this.visualMoveInput.onPointerDown(t)}destroy(){this.visualMoveInput.destroy(),this.resizeObserver&&this.resizeObserver.unobserve(this.chessboard.context),this.resizeListener&&window.removeEventListener("resize",this.resizeListener),this.chessboard.context.removeEventListener("mousedown",this.pointerDownListener),this.chessboard.context.removeEventListener("touchstart",this.pointerDownListener),O.removeElement(this.svg)}cacheSpriteToDiv(t,e){if(!document.getElementById(t)){let i=document.createElement("div");i.style.transform="scale(0)",i.style.position="absolute",i.setAttribute("aria-hidden","true"),i.id=t,document.body.appendChild(i);let n=new XMLHttpRequest;n.open("GET",e,!0),n.onload=function(){i.insertAdjacentHTML("afterbegin",n.response)},n.send()}}createSvgAndGroups(){this.svg=O.createSvg(this.container);let t=this.chessboard.props.style.cssClass?this.chessboard.props.style.cssClass:"default";this.svg.setAttribute("class","cm-chessboard border-type-"+this.chessboard.props.style.borderType+" "+t),this.svg.setAttribute("role","img"),this.updateMetrics(),this.boardGroup=O.addElement(this.svg,"g",{class:"board"}),this.coordinatesGroup=O.addElement(this.svg,"g",{class:"coordinates","aria-hidden":"true"}),this.markersLayer=O.addElement(this.svg,"g",{class:"markers-layer"}),this.piecesLayer=O.addElement(this.svg,"g",{class:"pieces-layer"}),this.piecesGroup=O.addElement(this.piecesLayer,"g",{class:"pieces"}),this.markersTopLayer=O.addElement(this.svg,"g",{class:"markers-top-layer"}),this.interactiveTopLayer=O.addElement(this.svg,"g",{class:"interactive-top-layer"})}updateMetrics(){let t=this.chessboard.props.style.pieces.tileSize;this.width=this.container.clientWidth,this.height=this.container.clientWidth*(this.chessboard.props.style.aspectRatio||1),this.chessboard.props.style.borderType===et.frame?this.borderSize=this.width/25:this.chessboard.props.style.borderType===et.thin?this.borderSize=this.width/320:this.borderSize=0,this.innerWidth=this.width-2*this.borderSize,this.innerHeight=this.height-2*this.borderSize,this.squareWidth=this.innerWidth/8,this.squareHeight=this.innerHeight/8,this.scalingX=this.squareWidth/t,this.scalingY=this.squareHeight/t,this.pieceXTranslate=this.squareWidth/2-t*this.scalingY/2}handleResize(){this.container.style.width=this.chessboard.context.clientWidth+"px",this.container.style.height=this.chessboard.context.clientWidth*this.chessboard.props.style.aspectRatio+"px",(this.container.clientWidth!==this.width||this.container.clientHeight!==this.height)&&(this.updateMetrics(),this.redrawBoard(),this.redrawPieces()),this.svg.setAttribute("width","100%"),this.svg.setAttribute("height","100%")}redrawBoard(){this.chessboard.state.invokeExtensionPoints(L.beforeRedrawBoard),this.redrawSquares(),this.drawCoordinates(),this.chessboard.state.invokeExtensionPoints(L.afterRedrawBoard),this.visualizeInputState()}redrawSquares(){for(;this.boardGroup.firstChild;)this.boardGroup.removeChild(this.boardGroup.lastChild);if(O.addElement(this.boardGroup,"rect",{width:this.width,height:this.height}).setAttribute("class","border"),this.chessboard.props.style.borderType===et.frame){let e=this.borderSize;O.addElement(this.boardGroup,"rect",{x:e,y:e,width:this.width-e*2,height:this.height-e*2}).setAttribute("class","border-inner")}for(let e=0;e<64;e++){let i=this.chessboard.state.orientation===U.white?e:63-e,o=`square ${(9*i&8)===0?"black":"white"}`,l=this.squareToPoint(ce.indexToSquare(i)),f=O.addElement(this.boardGroup,"rect",{x:l.x,y:l.y,width:this.squareWidth,height:this.squareHeight});f.setAttribute("class",o),f.setAttribute("data-square",ce.indexToSquare(i))}}drawCoordinates(){if(!this.chessboard.props.style.showCoordinates)return;for(;this.coordinatesGroup.firstChild;)this.coordinatesGroup.removeChild(this.coordinatesGroup.lastChild);let t=this.chessboard.props.style.borderType!==et.frame;for(let e=0;e<8;e++){let i=this.borderSize+(17+this.chessboard.props.style.pieces.tileSize*e)*this.scalingX,n=this.height-this.scalingY*3.5,o="coordinate file";t&&(i=i+this.scalingX*15.5,o+=e%2?" white":" black");let l=O.addElement(this.coordinatesGroup,"text",{class:o,x:i,y:n,style:`font-size: ${this.scalingY*10}px`});this.chessboard.state.orientation===U.white?l.textContent=String.fromCharCode(97+e):l.textContent=String.fromCharCode(104-e)}for(let e=0;e<8;e++){let i=this.borderSize/3.7,n=this.borderSize+25*this.scalingY+e*this.squareHeight,o="coordinate rank";t&&(o+=e%2?" black":" white",this.chessboard.props.style.borderType===et.frame?(i=i+this.scalingX*10,n=n-this.scalingY*15):(i=i+this.scalingX*2,n=n-this.scalingY*15));let l=O.addElement(this.coordinatesGroup,"text",{class:o,x:i,y:n,style:`font-size: ${this.scalingY*10}px`});this.chessboard.state.orientation===U.white?l.textContent=""+(8-e):l.textContent=""+(1+e)}}redrawPieces(t=this.chessboard.state.position.squares){let e=Array.from(this.piecesGroup.childNodes),i=this.visualMoveInput.isDragging();for(let n=0;n<64;n++){let o=t[n];if(o){let l=ce.indexToSquare(n);this.drawPieceOnSquare(l,o,i&&l===this.visualMoveInput.fromSquare)}}for(let n of e)this.piecesGroup.removeChild(n)}drawPiece(t,e,i){let n=O.addElement(t,"g",{});n.setAttribute("data-piece",e);let o=this.svg.createSVGTransform();o.setTranslate(i.x,i.y),n.transform.baseVal.appendItem(o);let l=this.chessboard.props.assetsCache?"":this.getSpriteUrl(),f=O.addElement(n,"use",{href:`${l}#${e}`,class:"piece"}),m=this.svg.createSVGTransform();return m.setScale(this.scalingY,this.scalingY),f.transform.baseVal.appendItem(m),n}drawPieceOnSquare(t,e,i=!1){let n=O.addElement(this.piecesGroup,"g",{});n.setAttribute("data-piece",e),n.setAttribute("data-square",t),i&&n.setAttribute("visibility","hidden");let o=this.squareToPoint(t),l=this.svg.createSVGTransform();l.setTranslate(o.x,o.y),n.transform.baseVal.appendItem(l);let f=this.chessboard.props.assetsCache?"":this.getSpriteUrl(),m=O.addElement(n,"use",{href:`${f}#${e}`,class:"piece"}),g=this.svg.createSVGTransform();g.setTranslate(this.pieceXTranslate,0),m.transform.baseVal.appendItem(g);let x=this.svg.createSVGTransform();return x.setScale(this.scalingY,this.scalingY),m.transform.baseVal.appendItem(x),n}setPieceVisibility(t,e=!0){let i=this.getPieceElement(t);i?e?i.setAttribute("visibility","visible"):i.setAttribute("visibility","hidden"):console.warn("no piece on",t)}getPieceElement(t){if(!t||t.length<2)return console.warn("invalid square",t),null;let e=this.piecesGroup.querySelector(`g[data-square='${t}']`);return e||(console.warn("no piece on",t),null)}enableMoveInput(t,e=null){if(this.chessboard.state.moveInputCallback)throw Error("moveInput already enabled");e===U.white?this.chessboard.state.inputWhiteEnabled=!0:e===U.black?this.chessboard.state.inputBlackEnabled=!0:(this.chessboard.state.inputWhiteEnabled=!0,this.chessboard.state.inputBlackEnabled=!0),this.chessboard.state.moveInputCallback=t,this.chessboard.state.invokeExtensionPoints(L.moveInputToggled,{enabled:!0,color:e}),this.visualizeInputState()}disableMoveInput(){this.chessboard.state.inputWhiteEnabled=!1,this.chessboard.state.inputBlackEnabled=!1,this.chessboard.state.moveInputCallback=null,this.chessboard.state.invokeExtensionPoints(L.moveInputToggled,{enabled:!1}),this.visualizeInputState()}moveInputStartedCallback(t){let e={chessboard:this.chessboard,type:j.moveInputStarted,square:t,squareFrom:t,piece:this.chessboard.getPiece(t)};return this.chessboard.state.moveInputCallback&&(e.moveInputCallbackResult=this.chessboard.state.moveInputCallback(e)),this.chessboard.state.invokeExtensionPoints(L.moveInput,e),e.moveInputCallbackResult}movingOverSquareCallback(t,e){let i={chessboard:this.chessboard,type:j.movingOverSquare,squareFrom:t,squareTo:e,piece:this.chessboard.getPiece(t)};this.chessboard.state.moveInputCallback&&(i.moveInputCallbackResult=this.chessboard.state.moveInputCallback(i)),this.chessboard.state.invokeExtensionPoints(L.moveInput,i)}validateMoveInputCallback(t,e){let i={chessboard:this.chessboard,type:j.validateMoveInput,squareFrom:t,squareTo:e,piece:this.chessboard.getPiece(t)};return this.chessboard.state.moveInputCallback&&(i.moveInputCallbackResult=this.chessboard.state.moveInputCallback(i)),this.chessboard.state.invokeExtensionPoints(L.moveInput,i),i.moveInputCallbackResult}moveInputCanceledCallback(t,e,i){let n={chessboard:this.chessboard,type:j.moveInputCanceled,reason:i,squareFrom:t,squareTo:e};this.chessboard.state.moveInputCallback&&this.chessboard.state.moveInputCallback(n),this.chessboard.state.invokeExtensionPoints(L.moveInput,n)}moveInputFinishedCallback(t,e,i){let n={chessboard:this.chessboard,type:j.moveInputFinished,squareFrom:t,squareTo:e,legalMove:i};this.chessboard.state.moveInputCallback&&this.chessboard.state.moveInputCallback(n),this.chessboard.state.invokeExtensionPoints(L.moveInput,n)}visualizeInputState(){this.chessboard.state&&(this.chessboard.state.inputWhiteEnabled||this.chessboard.state.inputBlackEnabled?this.boardGroup.setAttribute("class","board input-enabled"):this.boardGroup.setAttribute("class","board"))}indexToPoint(t){let e,i;return this.chessboard.state.orientation===U.white?(e=this.borderSize+t%8*this.squareWidth,i=this.borderSize+(7-Math.floor(t/8))*this.squareHeight):(e=this.borderSize+(7-t%8)*this.squareWidth,i=this.borderSize+Math.floor(t/8)*this.squareHeight),{x:e,y:i}}squareToPoint(t){let e=ce.squareToIndex(t);return this.indexToPoint(e)}getSpriteUrl(){return oe.isAbsoluteUrl(this.chessboard.props.style.pieces.file)?this.chessboard.props.style.pieces.file:this.chessboard.props.assetsUrl+this.chessboard.props.style.pieces.file}};var U={white:"w",black:"b"},j={moveInputStarted:"moveInputStarted",movingOverSquare:"movingOverSquare",validateMoveInput:"validateMoveInput",moveInputCanceled:"moveInputCanceled",moveInputFinished:"moveInputFinished"};var et={none:"none",thin:"thin",frame:"frame"},Re={wp:"wp",wb:"wb",wn:"wn",wr:"wr",wq:"wq",wk:"wk",bp:"bp",bb:"bb",bn:"bn",br:"br",bq:"bq",bk:"bk"},Ir={svgSprite:"svgSprite"};var ts=class{constructor(t,e={}){if(!t)throw new Error("container element is "+t);this.context=t,this.id=(Math.random()+1).toString(36).substring(2,8),this.extensions=[],this.props={position:je.empty,orientation:U.white,responsive:!0,assetsUrl:"./assets/",assetsCache:!0,style:{cssClass:"default",showCoordinates:!0,borderType:et.none,aspectRatio:1,pieces:{type:Ir.svgSprite,file:"pieces/standard.svg",tileSize:40},animationDuration:300},extensions:[]},oe.mergeObjects(this.props,e),this.state=new Xt,this.view=new es(this),this.positionAnimationsQueue=new Zt(this),this.state.orientation=this.props.orientation;for(let i of this.props.extensions)this.addExtension(i.class,i.props);this.view.redrawBoard(),this.state.position=new ce(this.props.position),this.view.redrawPieces(),this.state.invokeExtensionPoints(L.positionChanged),this.initialized=Promise.resolve()}async setPiece(t,e,i=!1){let n=this.state.position.clone();return this.state.position.setPiece(t,e),this.state.invokeExtensionPoints(L.positionChanged),this.positionAnimationsQueue.enqueuePositionChange(n,this.state.position.clone(),i)}async movePiece(t,e,i=!1){let n=this.state.position.clone();return this.state.position.movePiece(t,e),this.state.invokeExtensionPoints(L.positionChanged),this.positionAnimationsQueue.enqueuePositionChange(n,this.state.position.clone(),i)}async setPosition(t,e=!1){let i=this.state.position.clone(),n=new ce(t);return i.getFen()!==n.getFen()&&(this.state.position.setFen(t),this.state.invokeExtensionPoints(L.positionChanged)),this.positionAnimationsQueue.enqueuePositionChange(i,this.state.position.clone(),e)}async setOrientation(t,e=!1){let i=this.state.position.clone();if(this.boardTurning){console.warn("setOrientation is only once in queue allowed");return}return this.boardTurning=!0,this.positionAnimationsQueue.enqueueTurnBoard(i,t,e).then(()=>{this.boardTurning=!1,this.state.invokeExtensionPoints(L.boardChanged)})}getPiece(t){return this.state.position.getPiece(t)}getPosition(){return this.state.position.getFen()}getOrientation(){return this.state.orientation}enableMoveInput(t,e=void 0){this.view.enableMoveInput(t,e)}disableMoveInput(){this.view.disableMoveInput()}addExtension(t,e){if(this.getExtension(t))throw Error('extension "'+t.name+'" already added');this.extensions.push(new t(this,e))}getExtension(t){for(let e of this.extensions)if(e instanceof t)return e;return null}destroy(){this.state.invokeExtensionPoints(L.destroy),this.positionAnimationsQueue.destroy(),this.view.destroy(),this.view=void 0,this.state=void 0}};var Tt=class{constructor(t={}){if(this.props={locale:null,fallbackLang:"en"},Object.assign(this.props,t),this.locale=this.props.locale,!this.locale){let e=document.documentElement.getAttribute("lang");e&&(this.locale=e),this.locale||(this.locale=navigator.language)}this.lang=this.locale.substr(0,2),this.translations={}}load(t){let e=[];for(let i in t)if(t.hasOwnProperty(i)){this.translations[i]||(this.translations[i]={});let n=t[i];typeof n=="string"?e.push(new Promise(o=>{fetch(n).then(l=>l.json()).then(l=>{Object.assign(this.translations[i],l),o()}).catch(l=>{throw l})})):Object.assign(this.translations[i],n)}return e.length>0?Promise.all(e):Promise.resolve()}t(t,...e){let i;if(this.translations[this.locale]&&this.translations[this.locale][t])i=this.translations[this.locale][t];else if(this.translations[this.lang]&&this.translations[this.lang][t])i=this.translations[this.lang][t];else if(this.translations[this.props.fallbackLang][t])i=this.translations[this.props.fallbackLang][t];else return console.warn("Error, no translation found for locale:",this.locale,", lang: ",this.lang,", code: ",t),"?"+t+"?";if(e&&e.length>0){let n=0;for(let o of e)i=i.replace(new RegExp("\\$"+n,"g"),o),n++}return i}};var ss=class{constructor(){this.topics=[]}subscribe(t,e){if(!t){let i="subscribe: topic needed";throw console.error(i,e),new Error(i)}if(!e){let i="subscribe: callback needed";throw console.error(i,t),new Error(i)}this.topics[t]===void 0&&(this.topics[t]=[]),this.topics[t].indexOf(e)===-1&&this.topics[t].push(e)}unsubscribe(t=null,e=null){if(e!==null&&t!==null)this.topics[t].splice(this.topics[t].indexOf(e),1);else if(e===null&&t!==null)this.topics[t]=[];else if(t===null&&e!==null)for(let i in this.topics){let n=this.topics[i];for(let o of n)o===e&&this.unsubscribe(i,e)}else this.topics=[];t!==null&&this.topics[t]&&this.topics[t].length===0&&delete this.topics[t]}publish(t,e={},i=!0){if(!t){let l="publish: topic needed";throw console.error(l,e),new Error(l)}let n=t.split("/"),o="";for(let l of n)this.callback(o+"#",t,e,i),o+=l+"/";this.callback(t,t,e,i)}callback(t,e,i={},n=!0){this.topics[t]&&this.topics[t].forEach(function(o){if(n)setTimeout(function(){o(i,e)});else return o(i,e)})}};var ge=class{static onDocumentReady(t){this.documentReady(t)}static documentReady(t){document.addEventListener("DOMContentLoaded",t),(document.readyState==="interactive"||document.readyState==="complete")&&(document.removeEventListener("DOMContentLoaded",t),t())}static isElementVisible(t){return!!(t.offsetWidth||t.offsetHeight||t.getClientRects().length)}static isElementInViewport(t){let e=t.getBoundingClientRect();return e.top>=0&&e.left>=0&&e.bottom<=(window.innerHeight||document.documentElement.clientHeight)&&e.right<=(window.innerWidth||document.documentElement.clientWidth)}static getFormInputValues(t){let e=t.querySelectorAll("input,select"),i={};return e.forEach(n=>{n.type==="checkbox"?i[n.id]=!!n.checked:i[n.id]=n.value}),i}static isBrowserDarkMode(){return!!(window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches)}static browserSupportsPreferredColorScheme(){return window.matchMedia&&(window.matchMedia("(prefers-color-scheme: dark)").matches||window.matchMedia("(prefers-color-scheme: light)").matches)}static loadJs(t){let e=document.createElement("script");e.setAttribute("type","text/javascript"),e.setAttribute("src",t),document.getElementsByTagName("head")[0].appendChild(e)}static loadCss(t){let e=document.createElement("link");e.setAttribute("rel","stylesheet"),e.setAttribute("type","text/css"),e.setAttribute("href",t),document.getElementsByTagName("head")[0].appendChild(e)}static setCustomProperty(t,e,i=document.documentElement){i.style.setProperty("--"+t,e.trim())}static getCustomProperty(t,e=document.documentElement){return getComputedStyle(e).getPropertyValue("--"+t).trim()}static createElement(t){let e=document.createElement("template");return e.innerHTML=t.trim(),e.content.firstChild}static removeElement(t){t.parentNode.removeChild(t)}static clearElement(t){for(;t.firstChild;)t.removeChild(t.firstChild)}static insertAfter(t,e){e.parentNode.insertBefore(t,e.nextSibling)}static delegate(t,e,i,n){let o=function(l){let f=l.target;for(;f&&f!==this;)f.matches(i)&&n.call(f,l),f=f.parentNode};return t.addEventListener(e,o),{remove:function(){t.removeEventListener(e,o)}}}static openExternalLinksBlank(){let t=document.links;for(let e=0;e<t.length;e++){let i=t[e].target;t[e].hostname!==window.location.hostname&&i!=="_self"&&(t[e].target="_blank")}}};var tt=class{constructor(t={},e={}){this.props=t,this.state=e}},ae=class extends tt{constructor(t,e={},i={}){super(e,i),this.context=t,this.actions={}}addDataEventListeners(t=this.context){let e=t.querySelectorAll("[data-event-listener]");this.props.debug&&console.log("eventListenerElements",t,e);for(let i of e){let n=i.dataset.eventListener,o=i.dataset.action,l=i.dataset.delegate;this.actions[o]||console.error(t,'You have to add the action "'+o+'" to your component.'),l?ge.delegate(i,n,l,f=>{this.props.debug&&console.log("delegate",o,f),this.actions[o](f)}):(this.props.debug&&console.log("addEventListener",n,o),this.actions[o]?i.addEventListener(n,this.actions[o].bind(this)):console.error("no action",'"'+o+'"',"is defined"))}return this}};var Ne={en:{colors:{w:"w",b:"b"},colors_long:{w:"White",b:"Black"},pieces:{p:"p",n:"n",b:"b",r:"r",q:"q",k:"k"},pieces_long:{p:"Pawn",n:"Knight",b:"Bishop",r:"Rook",q:"Queen",k:"King"}},de:{colors:{w:"w",b:"s"},colors_long:{w:"Wei\xDF",b:"Schwarz"},pieces:{p:"b",n:"s",b:"l",r:"t",q:"d",k:"k"},pieces_long:{p:"Bauer",n:"Springer",b:"L\xE4ufer",r:"Turm",q:"Dame",k:"K\xF6nig"}}};function is(c,t,e=void 0){let i=Ne[c].pieces_long[t];return e&&(i+=" "+Ne[c].colors_long[e]),i}var $s={array:["copyWithin","fill","pop","push","reverse","shift","unshift","sort","splice"],set:["add","clear","delete"],map:["set","clear","delete"]},Ue=new Map,X=class c{static preFunction(t,e,i){if(Array.isArray(e)){let o=[];return e.forEach(l=>{o.push(c.preFunction(t,l,i))}),{remove:()=>{o.forEach(l=>{l.remove()})}}}Ue.has(t)||Ue.set(t,{});let n=Ue.get(t);if(n.observedPreFunctions===void 0&&(n.observedPreFunctions=new Map),!n.observedPreFunctions.has(e)){n.observedPreFunctions.set(e,new Set);let o=t[e];t[e]=function(){let l=arguments;return n.observedPreFunctions.get(e).forEach(function(f){let g=f({functionName:e,arguments:l});g&&(l=g)}),o.apply(t,l)}}return n.observedPreFunctions.get(e).add(i),{remove:()=>{n.observedPreFunctions.get(e).delete(i)}}}static postFunction(t,e,i){if(Array.isArray(e)){let o=[];return e.forEach(l=>{o.push(c.postFunction(t,l,i))}),{remove:()=>{o.forEach(l=>{l.remove()})}}}Ue.has(t)||Ue.set(t,{});let n=Ue.get(t);if(n.observedPostFunctions===void 0&&(n.observedPostFunctions=new Map),!n.observedPostFunctions.has(e)){n.observedPostFunctions.set(e,new Set);let o=t[e];t[e]=function(){let l=o.apply(t,arguments),f=arguments;return n.observedPostFunctions.get(e).forEach(function(m){let g={functionName:e,arguments:f,returnValue:l};m(g),l=g.returnValue}),l}}return n.observedPostFunctions.get(e).add(i),{remove:()=>{n.observedPostFunctions.get(e).delete(i)}}}static property(t,e,i){if(Array.isArray(e)){let l=[];return e.forEach(f=>{l.push(c.property(t,f,i))}),{remove:()=>{l.forEach(f=>{f.remove()})}}}if(!t.hasOwnProperty(e)){console.error("Observe.property",t,"missing property: "+e);return}let n=!1;Ue.has(t)||Ue.set(t,{});let o=Ue.get(t);if(o.observedProperties===void 0&&(o.observedProperties=new Map),!o.observedProperties.has(e)){o.observedProperties.set(e,{value:t[e],observers:new Set});let l=t[e],f=[];l instanceof Array?(n=!0,f=$s.array):l instanceof Set||l instanceof WeakSet?(n=!0,f=$s.set):(l instanceof Map||l instanceof WeakMap)&&(n=!0,f=$s.map),delete t[e]?(Object.defineProperty(t,e,{get:function(){return o.observedProperties.get(e).value},set:function(m){let g=o.observedProperties.get(e).value;m!==g&&(o.observedProperties.get(e).value=m,o.observedProperties.get(e).observers.forEach(function(x){x({propertyName:e,oldValue:g,newValue:m})}))},enumerable:!0,configurable:!0}),n&&f.forEach(function(m){t[e][m]=function(){t[e].constructor.prototype[m].apply(this,arguments);let g=arguments;o.observedProperties.get(e).observers.forEach(function(x){let k={propertyName:e,methodName:m,arguments:g,newValue:t[e]};x(k)})}})):console.error("Error: Observe.property",e,"failed")}return o.observedProperties.get(e).observers.add(i),{remove:()=>{o.observedProperties.get(e).observers.delete(i)}}}};var ns=class{constructor(t){this.chess=new jt,this.orientation=t.playerColor||U.white,this.plyViewed=void 0}observeChess(t){["move","clear","load","loadPgn","put","remove","reset","undo"].forEach(i=>{X.postFunction(this.chess,i,n=>{t(n)})})}};var Q={newGame:"game/new",initGame:"game/init",gameOver:"game/over",moveRequest:"game/moveRequest",legalMove:"game/move/legal",illegalMove:"game/move/illegal",moveUndone:"game/move/undone",load:"game/load"},Ms=class extends ae{constructor(t,e,i,n={},o=new ns(n)){super(t,n,o),this.props={locale:navigator.language,playerColor:U.white,pgn:void 0,accessible:!1},this.props.figures||(this.props.figures={Rw:'<i class="fas fa-fw fa-chess-rook fa-figure-white"></i>',Nw:'<i class="fas fa-fw fa-chess-knight fa-figure-white"></i>',Bw:'<i class="fas fa-fw fa-chess-bishop fa-figure-white"></i>',Qw:'<i class="fas fa-fw fa-chess-queen fa-figure-white"></i>',Kw:'<i class="fas fa-fw fa-chess-king fa-figure-white"></i>',Pw:'<i class="fas fa-fw fa-chess-pawn fa-figure-white"></i>',Rb:'<i class="fas fa-fw fa-chess-rook fa-figure-black"></i>',Nb:'<i class="fas fa-fw fa-chess-knight fa-figure-black"></i>',Bb:'<i class="fas fa-fw fa-chess-bishop fa-figure-black"></i>',Qb:'<i class="fas fa-fw fa-chess-queen fa-figure-black"></i>',Kb:'<i class="fas fa-fw fa-chess-king fa-figure-black"></i>',Pb:'<i class="fas fa-fw fa-chess-pawn fa-figure-black"></i>'});let l={consoleGame:"col-xl-7 order-xl-2 col-lg-8 order-lg-1 order-md-1 col-md-12",consoleRight:"col-xl-3 order-xl-3 col-lg-4 order-lg-2 col-md-8 order-md-3",consoleLeft:"col-xl-2 order-xl-1 order-lg-3 col-lg-12 col-md-4 order-md-2"};this.initialized=new Promise(m=>{this.i18n=new Tt({locale:n.locale}),this.i18n.load({de:{ok:"OK",cancel:"Abbrechen"},en:{ok:"OK",cancel:"Cancel"}}).then(()=>{this.i18n.load(Ne).then(()=>{m(this)})})}),this.initialization=this.initialized,this.props.template||(this.props.template=`
                <div class="row chess-console">
                    <div class="chess-console-center ${l.consoleGame}">
                        <div class="chess-console-board"></div>
                    </div>
                    <div class="chess-console-right ${l.consoleRight}">
                        <div class="control-buttons buttons-grid mb-4"></div>
                        <div class="chess-console-notifications"></div>
                    </div>
                    <div class="chess-console-left ${l.consoleLeft}">
                        <div class="row">
                            <div class="col-xl-12 col-lg-4 col-md-12 col-6">
                                <div class="chess-console-history"></div>
                            </div>
                            <div class="col-xl-12 col-lg-8 col-md-12 col-6">
                                <div class="chess-console-captured"></div>
                            </div>
                        </div>
                    </div>
                </div>`),Object.assign(this.props,n),this.messageBroker=new ss;let f=ge.createElement(this.context.innerHTML);(!(f instanceof Element)||!f.querySelector(".chess-console")&&!f.classList.contains("chess-console"))&&(this.context.innerHTML=this.props.template),this.componentContainers={center:this.context.querySelector(".chess-console-center"),left:this.context.querySelector(".chess-console-left"),right:this.context.querySelector(".chess-console-right"),board:this.context.querySelector(".chess-console-board"),controlButtons:this.context.querySelector(".control-buttons"),notifications:this.context.querySelector(".chess-console-notifications")},this.components={},this.player=new e.type(this,e.name,e.props),this.opponent=new i.type(this,i.name,i.props),this.persistence=void 0}initGame(t={},e=!0){Object.assign(this.props,t),this.state.orientation=this.props.playerColor,t.pgn?(this.state.chess.loadPgn(t.pgn,{sloppy:!0}),this.state.plyViewed=this.state.chess.plyCount()):(this.state.chess.load(ut.start),this.state.plyViewed=0),e&&this.nextMove(),this.messageBroker.publish(Q.initGame,{props:t})}newGame(t={}){this.messageBroker.publish(Q.newGame,{props:t}),this.initGame(t),this.components.board.chessboard&&this.components.board.chessboard.disableMoveInput()}playerWhite(){return this.props.playerColor===U.white?this.player:this.opponent}playerBlack(){return this.props.playerColor===U.white?this.opponent:this.player}playerToMove(){return this.state.chess.gameOver()?null:this.state.chess.turn()==="w"?this.playerWhite():this.playerBlack()}nextMove(){let t=this.playerToMove();t&&(this.messageBroker.publish(Q.moveRequest,{playerToMove:t}),setTimeout(()=>{t.moveRequest(this.state.chess.fen(),e=>this.handleMoveResponse(e))}))}handleMoveResponse(t){let e=this.playerToMove(),i=this.state.chess.move(t);if(!i)return this.props.debug&&console.warn("illegalMove",this.state.chess,t),this.messageBroker.publish(Q.illegalMove,{playerMoved:e,move:t}),i;if(this.state.plyViewed===this.state.chess.plyCount()-1&&this.state.plyViewed++,this.messageBroker.publish(Q.legalMove,{playerMoved:e,move:t,moveResult:i}),!this.state.chess.gameOver())this.nextMove();else{let n=null;this.state.chess.inCheckmate()&&(n=this.state.chess.turn()===U.white?U.black:U.white),this.messageBroker.publish(Q.gameOver,{wonColor:n})}return i}undoMove(){this.components.board.chessboard.disableMoveInput(),this.state.chess.undo(),this.playerToMove()!==this.player&&this.state.chess.undo(),this.state.plyViewed>this.state.chess.plyCount()&&(this.state.plyViewed=this.state.chess.plyCount()),this.messageBroker.publish(Q.moveUndone),this.nextMove()}};var pt=class{constructor(t,e){this.chessConsole=t,this.name=e}moveRequest(t,e){}};var Is=class extends pt{constructor(t,e,i){super(t,e),this.props={allowPremoves:!1},Object.assign(this.props,i),this.premoves=[]}validateMoveAndPromote(t,e,i,n){let o=new ie(t),l={from:e,to:i},f=o.move(l);if(f)return n(f),!0;if(o.get(e)&&o.get(e).type==="p"){let m=o.moves({square:e,verbose:!0});for(let g of m)if(g.to===i&&g.promotion)return this.chessConsole.components.board.chessboard.showPromotionDialog(i,o.turn(),k=>{console.log(k),k.piece?(l.promotion=k.piece.charAt(1),console.log(l),n(o.move(l))):n(null)}),!0}return n(null),!1}chessboardMoveInputCallback(t,e){let i=this.chessConsole.state.chess.fen();if(this.chessConsole.playerToMove()===this){if(t.type===j.validateMoveInput)return this.validateMoveAndPromote(i,t.squareFrom,t.squareTo,n=>{let o;n?o=e(n):(o=e({from:t.squareFrom,to:t.squareTo}),this.premoves=[],this.updatePremoveMarkers()),o&&(this.props.allowPremoves||this.chessConsole.components.board.chessboard.disableMoveInput())});if(t.type===j.moveInputStarted)return this.chessConsole.state.plyViewed!==this.chessConsole.state.chess.plyCount()?(this.chessConsole.state.plyViewed=this.chessConsole.state.chess.plyCount(),!1):this.chessConsole.state.chess.moves({square:t.square}).length>0?!0:(this.chessConsole.components.board.chessConsole.messageBroker.publish(Q.illegalMove,{move:{from:t.squareFrom}}),!1)}else return t.type===j.validateMoveInput&&(this.premoves.push(t),this.updatePremoveMarkers()),!0}moveRequest(t,e){this.contextMenuEvent||(this.chessConsole.components.board.chessboard.context.addEventListener("contextmenu",n=>{n.preventDefault(),this.premoves.length>0&&(this.resetBoardPosition(),this.premoves=[],this.updatePremoveMarkers())}),this.contextMenuEvent=!0);let i=this.chessConsole.state.chess.turn()==="w"?U.white:U.black;if(!this.chessConsole.state.chess.gameOver()){if(this.premoves.length>0){let n=this.premoves.shift();return this.updatePremoveMarkers(),setTimeout(()=>{this.chessboardMoveInputCallback(n,e)},100),!0}this.chessConsole.components.board.chessboard.enableMoveInput(n=>this.chessboardMoveInputCallback(n,e),i)}}updatePremoveMarkers(){this.chessConsole.components.board.chessboard.removeMarkers(this.chessConsole.components.board.props.markers.premove);for(let t of this.premoves)this.chessConsole.components.board.chessboard.addMarker(this.chessConsole.components.board.props.markers.premove,t.squareTo)}resetBoardPosition(){this.chessConsole.components.board.chessboard.setPosition(this.chessConsole.state.chess.fen(),!0)}};var qr={frame:{class:"marker-frame",slice:"markerFrame"},framePrimary:{class:"marker-frame-primary",slice:"markerFrame"},frameDanger:{class:"marker-frame-danger",slice:"markerFrame"},circle:{class:"marker-circle",slice:"markerCircle"},circlePrimary:{class:"marker-circle-primary",slice:"markerCircle"},circleDanger:{class:"marker-circle-danger",slice:"markerCircle"},square:{class:"marker-square",slice:"markerSquare"},dot:{class:"marker-dot",slice:"markerDot",position:"above"},bevel:{class:"marker-bevel",slice:"markerBevel"}},rs=class extends Te{constructor(t,e={}){super(t),this.registerExtensionPoint(L.afterRedrawBoard,()=>{this.onRedrawBoard()}),this.props={autoMarkers:qr.frame,sprite:"extensions/markers/markers.svg"},Object.assign(this.props,e),t.props.assetsCache&&t.view.cacheSpriteToDiv("cm-chessboard-markers",this.getSpriteUrl()),t.addMarker=this.addMarker.bind(this),t.getMarkers=this.getMarkers.bind(this),t.removeMarkers=this.removeMarkers.bind(this),this.markerGroupDown=O.addElement(t.view.markersLayer,"g",{class:"markers"}),this.markerGroupUp=O.addElement(t.view.markersTopLayer,"g",{class:"markers"}),this.markers=[],this.props.autoMarkers&&(Object.assign(this.props.autoMarkers,this.props.autoMarkers),this.registerExtensionPoint(L.moveInput,i=>{this.drawAutoMarkers(i)}))}drawAutoMarkers(t){t.type!==j.moveInputFinished&&this.removeMarkers(this.props.autoMarkers),!(t.type===j.moveInputStarted&&!t.moveInputCallbackResult)&&(t.type===j.moveInputStarted||t.type===j.movingOverSquare)&&(t.squareFrom&&this.addMarker(this.props.autoMarkers,t.squareFrom),t.squareTo&&this.addMarker(this.props.autoMarkers,t.squareTo))}onRedrawBoard(){for(;this.markerGroupUp.firstChild;)this.markerGroupUp.removeChild(this.markerGroupUp.firstChild);for(;this.markerGroupDown.firstChild;)this.markerGroupDown.removeChild(this.markerGroupDown.firstChild);this.markers.forEach(t=>{this.drawMarker(t)})}drawMarker(t){let e;t.type.position==="above"?e=O.addElement(this.markerGroupUp,"g"):e=O.addElement(this.markerGroupDown,"g"),e.setAttribute("data-square",t.square);let i=this.chessboard.view.squareToPoint(t.square),n=this.chessboard.view.svg.createSVGTransform();n.setTranslate(i.x,i.y),e.transform.baseVal.appendItem(n);let o=this.chessboard.props.assetsCache?"":this.getSpriteUrl(),l=O.addElement(e,"use",{href:`${o}#${t.type.slice}`,class:"marker "+t.type.class}),f=this.chessboard.view.svg.createSVGTransform();return f.setScale(this.chessboard.view.scalingX,this.chessboard.view.scalingY),l.transform.baseVal.appendItem(f),e}addMarker(t,e){if(typeof t=="string"||typeof e=="object"){console.error("changed the signature of `addMarker` to `(type, square)` with v5.1.x");return}this.markers.push(new qs(e,t)),this.onRedrawBoard()}getMarkers(t=void 0,e=void 0){if(typeof t=="string"||typeof e=="object"){console.error("changed the signature of `getMarkers` to `(type, square)` with v5.1.x");return}let i=[];return this.markers.forEach(n=>{n.matches(e,t)&&i.push(n)}),i}removeMarkers(t=void 0,e=void 0){if(typeof t=="string"||typeof e=="object"){console.error("changed the signature of `removeMarkers` to `(type, square)` with v5.1.x");return}this.markers=this.markers.filter(i=>!i.matches(e,t)),this.onRedrawBoard()}getSpriteUrl(){return oe.isAbsoluteUrl(this.props.sprite)?this.props.sprite:this.chessboard.props.assetsUrl+this.props.sprite}},qs=class{constructor(t,e){this.square=t,this.type=e}matches(t=void 0,e=void 0){if(!e&&!t)return!0;if(e){if(t){if(this.type===e&&t===this.square)return!0}else if(this.type===e)return!0}else if(t===this.square)return!0;return!1}};var os=class c{static debounce(t,e=0,i=!1){let n;return function(...l){if(i&&!n)t(...l),n=!0;else{let f=()=>{clearTimeout(n),t(...l)};clearTimeout(n),n=setTimeout(f,e)}}}static mergeObjects(t,e){let i=n=>n&&typeof n=="object";if(!i(t)||!i(e))return e;for(let n of Object.keys(e))e[n]instanceof Object&&Object.assign(e[n],c.mergeObjects(t[n],e[n]));return Object.assign(t||{},e),t}static createTask(){let t,e,i=new Promise(function(n,o){t=n,e=o});return i.resolve=t,i.reject=e,i}};var ve={hidden:"hidden",displayRequested:"displayRequested",shown:"shown"},Os={pieceSelected:"pieceSelected",canceled:"canceled"},as=class extends Te{constructor(t){super(t),this.registerExtensionPoint(L.afterRedrawBoard,this.extensionPointRedrawBoard.bind(this)),t.showPromotionDialog=this.showPromotionDialog.bind(this),t.isPromotionDialogShown=this.isPromotionDialogShown.bind(this),this.promotionDialogGroup=O.addElement(t.view.interactiveTopLayer,"g",{class:"promotion-dialog-group"}),this.state={displayState:ve.hidden,callback:null,dialogParams:{square:null,color:null}}}showPromotionDialog(t,e,i){this.state.dialogParams.square=t,this.state.dialogParams.color=e,this.state.callback=i,this.setDisplayState(ve.displayRequested),setTimeout(()=>{this.chessboard.view.positionsAnimationTask.then(()=>{this.setDisplayState(ve.shown)})})}isPromotionDialogShown(){return this.state.displayState===ve.shown||this.state.displayState===ve.displayRequested}extensionPointRedrawBoard(){this.redrawDialog()}drawPieceButton(t,e){let i=this.chessboard.view.squareWidth,n=this.chessboard.view.squareHeight;O.addElement(this.promotionDialogGroup,"rect",{x:e.x,y:e.y,width:i,height:n,class:"promotion-dialog-button","data-piece":t}),this.chessboard.view.drawPiece(this.promotionDialogGroup,t,e)}redrawDialog(){for(;this.promotionDialogGroup.firstChild;)this.promotionDialogGroup.removeChild(this.promotionDialogGroup.firstChild);if(this.state.displayState===ve.shown){let t=this.chessboard.view.squareWidth,e=this.chessboard.view.squareHeight,i=this.chessboard.view.squareToPoint(this.state.dialogParams.square);i.x=i.x+t/2,i.y=i.y+e/2;let n=!1,o=parseInt(this.state.dialogParams.square.charAt(1),10);(this.chessboard.getOrientation()===U.white&&o<5||this.chessboard.getOrientation()===U.black&&o>=5)&&(n=!0);let l=n?-4*e:0,f=i.x+t>this.chessboard.view.width?-t:0;O.addElement(this.promotionDialogGroup,"rect",{x:i.x+f,y:i.y+l,width:t,height:e*4,class:"promotion-dialog"});let m=this.state.dialogParams;n?(this.drawPieceButton(Re[m.color+"q"],{x:i.x+f,y:i.y-e}),this.drawPieceButton(Re[m.color+"r"],{x:i.x+f,y:i.y-e*2}),this.drawPieceButton(Re[m.color+"b"],{x:i.x+f,y:i.y-e*3}),this.drawPieceButton(Re[m.color+"n"],{x:i.x+f,y:i.y-e*4})):(this.drawPieceButton(Re[m.color+"q"],{x:i.x+f,y:i.y}),this.drawPieceButton(Re[m.color+"r"],{x:i.x+f,y:i.y+e}),this.drawPieceButton(Re[m.color+"b"],{x:i.x+f,y:i.y+e*2}),this.drawPieceButton(Re[m.color+"n"],{x:i.x+f,y:i.y+e*3}))}}promotionDialogOnClickPiece(t){t.button!==2&&(t.target.dataset.piece?(this.state.callback&&this.state.callback({type:Os.pieceSelected,square:this.state.dialogParams.square,piece:t.target.dataset.piece}),this.setDisplayState(ve.hidden)):this.promotionDialogOnCancel(t))}promotionDialogOnCancel(t){this.state.displayState===ve.shown&&(t.preventDefault(),this.setDisplayState(ve.hidden),this.state.callback&&this.state.callback({type:Os.canceled}))}contextMenu(t){t.preventDefault(),this.setDisplayState(ve.hidden),this.state.callback&&this.state.callback({type:Os.canceled})}setDisplayState(t){this.state.displayState=t,t===ve.shown?(this.clickDelegate=oe.delegate(this.chessboard.view.svg,"mousedown","*",this.promotionDialogOnClickPiece.bind(this)),this.contextMenuListener=this.contextMenu.bind(this),this.chessboard.view.svg.addEventListener("contextmenu",this.contextMenuListener)):t===ve.hidden&&(this.clickDelegate.remove(),this.chessboard.view.svg.removeEventListener("contextmenu",this.contextMenuListener)),this.redrawDialog()}};var Or={de:{chessboard:"Schachbrett",pieces_lists:"Figurenlisten",board_as_table:"Schachbrett als Tabelle",move_piece:"Figur bewegen",from:"Zug von",to:"Zug nach",move:"Zug ausf\xFChren",input_white_enabled:"Eingabe Wei\xDF aktiviert",input_black_enabled:"Eingabe Schwarz aktiviert",input_disabled:"Eingabe deaktiviert",pieces:"Figuren"},en:{chessboard:"Chessboard",pieces_lists:"Pieces lists",board_as_table:"Chessboard as table",move_piece:"Move piece",from:"Move from",to:"Move to",move:"Make move",input_white_enabled:"Input white enabled",input_black_enabled:"Input black enabled",input_disabled:"Input disabled",pieces:"Pieces"}},ls=class extends Te{constructor(t,e){if(super(t),this.props={language:navigator.language.substring(0,2).toLowerCase(),brailleNotationInAlt:!0,movePieceForm:!0,boardAsTable:!0,piecesAsList:!0,visuallyHidden:!0},Object.assign(this.props,e),this.props.language!=="de"&&this.props.language!=="en"&&(this.props.language="en"),this.lang=this.props.language,this.tPieces=Ne[this.lang],this.t=Or[this.lang],this.components=[],this.props.movePieceForm||this.props.boardAsTable||this.props.piecesAsList){let i=document.createElement("div");i.classList.add("cm-chessboard-accessibility"),this.chessboard.context.appendChild(i),this.props.visuallyHidden&&i.classList.add("visually-hidden"),this.props.movePieceForm&&this.components.push(new Rs(i,this)),this.props.boardAsTable&&this.components.push(new Ns(i,this)),this.props.piecesAsList&&this.components.push(new Us(i,this))}this.props.brailleNotationInAlt&&this.components.push(new Ls(this))}},Ls=class{constructor(t){this.extension=t,t.registerExtensionPoint(L.positionChanged,()=>{this.redraw()})}redraw(){let t=this.extension.chessboard.state.position.getPieces(),e=Ne[this.extension.lang].colors.w.toUpperCase()+":",i=Ne[this.extension.lang].colors.b.toUpperCase()+":";for(let o of t){let l=o.name==="p"?"":Ne[this.extension.lang].pieces[o.name].toUpperCase();o.color==="w"?e+=" "+l+o.position:i+=" "+l+o.position}let n=`${e}
${i}`;this.extension.chessboard.view.svg.setAttribute("alt",n)}},Rs=class{constructor(t,e){this.chessboard=e.chessboard,this.movePieceFormContainer=oe.createDomElement(`
<div>
    <h3 id="hl_form_${this.chessboard.id}">${e.t.move_piece}</h3>
    <form aria-labelledby="hl_form_${this.chessboard.id}">
        <label for="move_piece_input_from_${this.chessboard.id}">${e.t.from}</label>
        <input class="input-from" type="text" size="2" id="move_piece_input_from_${this.chessboard.id}"/>
        <label for="move_piece_input_to_${this.chessboard.id}">${e.t.to}</label>
        <input class="input-to" type="text" size="2" id="move_piece_input_to_${this.chessboard.id}"/>
        <button type="submit" class="button-move">${e.t.move}</button>
    </form>
</div>`),this.form=this.movePieceFormContainer.querySelector("form"),this.inputFrom=this.form.querySelector(".input-from"),this.inputTo=this.form.querySelector(".input-to"),this.moveButton=this.form.querySelector(".button-move"),this.form.addEventListener("submit",i=>{i.preventDefault(),this.chessboard.state.moveInputCallback({chessboard:this.chessboard,type:j.validateMoveInput,squareFrom:this.inputFrom.value,squareTo:this.inputTo.value})&&this.chessboard.movePiece(this.inputFrom.value,this.inputTo.value,!0).then(()=>{this.inputFrom.value="",this.inputTo.value=""})}),t.appendChild(this.movePieceFormContainer),e.registerExtensionPoint(L.moveInputToggled,()=>{this.redraw()})}redraw(){this.inputFrom&&(this.chessboard.state.inputWhiteEnabled||this.chessboard.state.inputBlackEnabled?(this.inputFrom.disabled=!1,this.inputTo.disabled=!1,this.moveButton.disabled=!1):(this.inputFrom.disabled=!0,this.inputTo.disabled=!0,this.moveButton.disabled=!0))}},Ns=class{constructor(t,e){this.extension=e,this.chessboard=e.chessboard,this.boardAsTableContainer=oe.createDomElement(`<div><h3 id="hl_table_${this.chessboard.id}">${e.t.board_as_table}</h3><div class="table"></div></div>`),this.boardAsTable=this.boardAsTableContainer.querySelector(".table"),t.appendChild(this.boardAsTableContainer),e.registerExtensionPoint(L.positionChanged,()=>{this.redraw()}),e.registerExtensionPoint(L.boardChanged,()=>{this.redraw()})}redraw(){let t=this.chessboard.state.position.squares.slice(),e=["a","b","c","d","e","f","g","h"],i=["8","7","6","5","4","3","2","1"];this.chessboard.state.orientation===U.black&&(e.reverse(),i.reverse(),t.reverse());let n=`<table aria-labelledby="hl_table_${this.chessboard.id}"><tr><th></th>`;for(let o of e)n+=`<th scope='col'>${o}</th>`;n+="</tr>";for(let o=7;o>=0;o--){n+=`<tr><th scope="row">${i[7-o]}</th>`;for(let l=0;l<8;l++){let f=t[l%8+o*8],m,g;f?(m=f.charAt(0),g=f.charAt(1),n+=`<td>${is(this.extension.lang,g,m)}</td>`):n+="<td></td>"}n+="</tr>"}n+="</table>",this.boardAsTable.innerHTML=n}},Us=class{constructor(t,e){this.extension=e,this.chessboard=e.chessboard,this.piecesListContainer=oe.createDomElement(`<div><h3 id="hl_lists_${this.chessboard.id}">${e.t.pieces_lists}</h3><div class="list"></div></div>`),this.piecesList=this.piecesListContainer.querySelector(".list"),t.appendChild(this.piecesListContainer),e.registerExtensionPoint(L.positionChanged,()=>{this.redraw()})}redraw(){let t=this.chessboard.state.position.getPieces(),e="",i="";for(let n of t)n.color==="w"?e+=`<li class="list-inline-item">${is(this.extension.lang,n.name)} ${n.position}</li>`:i+=`<li class="list-inline-item">${is(this.extension.lang,n.name)} ${n.position}</li>`;this.piecesList.innerHTML=`
        <h4 id="white_${this.chessboard.id}">${this.extension.t.pieces} ${this.extension.tPieces.colors_long.w}</h4>
        <ul aria-labelledby="white_${this.chessboard.id}" class="list-inline">${e}</ul>
        <h4 id="black_${this.chessboard.id}">${this.extension.t.pieces} ${this.extension.tPieces.colors_long.b}</h4>
        <ul aria-labelledby="black_${this.chessboard.id}" class="list-inline">${i}</ul>`}};var cs=class extends Te{constructor(t,e={}){super(t),this.props={chessboardBorderType:t.props.style.borderType,borderNoneBelow:540},Object.assign(this.props,e),this.registerExtensionPoint(L.beforeRedrawBoard,this.extensionPointBeforeRedrawBoard.bind(this))}extensionPointBeforeRedrawBoard(){let t;this.chessboard.view.width<this.props.borderNoneBelow?t="none":t=this.props.chessboardBorderType,t!==this.chessboard.props.style.borderType&&(this.chessboard.props.style.borderType=t,this.chessboard.view.updateMetrics())}};var ft={moveInput:{class:"marker-frame",slice:"markerFrame"},check:{class:"marker-circle-danger",slice:"markerCircle"},wrongMove:{class:"marker-frame-danger",slice:"markerFrame"},premove:{class:"marker-frame-primary",slice:"markerFrame"},legalMove:{class:"marker-dot",slice:"markerDot"},legalMoveCapture:{class:"marker-bevel",slice:"markerBevel"}},Gs=class extends ae{constructor(t,e={}){super(t.componentContainers.board,e),t.components.board=this,this.initialized=new Promise(i=>{this.i18n=t.i18n,this.i18n.load({de:{chessBoard:"Schachbrett"},en:{chessBoard:"Chess Board"}}).then(()=>{this.chessConsole=t,this.elements={playerTop:document.createElement("div"),playerBottom:document.createElement("div"),chessboard:document.createElement("div")},this.elements.playerTop.setAttribute("class","player top"),this.elements.playerTop.innerHTML="&nbsp;",this.elements.playerBottom.setAttribute("class","player bottom"),this.elements.playerBottom.innerHTML="&nbsp;",this.elements.chessboard.setAttribute("class","chessboard"),this.context.appendChild(ge.createElement("<h2 class='visually-hidden'>"+this.i18n.t("chessBoard")+"</h2>")),this.context.appendChild(this.elements.playerTop),this.context.appendChild(this.elements.chessboard),this.context.appendChild(this.elements.playerBottom),this.chessConsole.state.observeChess(n=>{let o=!0;n.functionName==="load_pgn"&&(o=!1),this.setPositionOfPlyViewed(o),this.markLastMove()}),X.property(this.chessConsole.state,"plyViewed",n=>{this.setPositionOfPlyViewed(n.oldValue!==void 0),this.markLastMove()}),this.props={position:je.empty,orientation:t.state.orientation,assetsUrl:void 0,markLegalMoves:!0,style:{aspectRatio:.98},accessibility:{active:!0,brailleNotationInAlt:!0,movePieceForm:!0,boardAsTable:!0,piecesAsList:!0,visuallyHidden:!0},markers:{moveInput:ft.moveInput,check:ft.check,wrongMove:ft.wrongMove,premove:ft.premove,legalMove:ft.legalMove,legalMoveCapture:ft.legalMoveCapture},extensions:[{class:as},{class:Vs,props:{board:this}},{class:cs}]},os.mergeObjects(this.props,e),this.props.accessibility.active&&this.props.extensions.push({class:ls,props:this.props.accessibility}),this.chessboard=new ts(this.elements.chessboard,this.props),X.property(t.state,"orientation",()=>{this.setPlayerNames(),this.chessboard.setOrientation(t.state.orientation).then(()=>{this.markPlayerToMove()})}),X.property(t.player,"name",()=>{this.setPlayerNames()}),X.property(t.opponent,"name",()=>{this.setPlayerNames()}),t.messageBroker.subscribe(Q.moveRequest,()=>{this.markPlayerToMove()}),this.chessConsole.messageBroker.subscribe(Q.illegalMove,n=>{this.chessboard.removeMarkers(this.props.markers.wrongMove),clearTimeout(this.removeMarkersTimeout),n.move.from?this.chessboard.addMarker(this.props.markers.wrongMove,n.move.from):console.warn("illegalMove without `message.move.from`"),n.move.to&&this.chessboard.addMarker(this.props.markers.wrongMove,n.move.to),this.removeMarkersTimeout=setTimeout(()=>{this.chessboard.removeMarkers(this.props.markers.wrongMove)},500)}),this.setPositionOfPlyViewed(!1),this.setPlayerNames(),this.markPlayerToMove(),this.markLastMove(),i(this)})}),this.initialization=this.initialized}setPositionOfPlyViewed(t=!0){clearTimeout(this.setPositionOfPlyViewedDebounced),this.setPositionOfPlyViewedDebounced=setTimeout(()=>{let e=this.chessConsole.state.chess.fenOfPly(this.chessConsole.state.plyViewed);this.chessboard.setPosition(e,t)})}markLastMove(){window.clearTimeout(this.markLastMoveDebounce),this.markLastMoveDebounce=setTimeout(()=>{if(this.chessboard.removeMarkers(this.props.markers.moveInput),this.chessboard.removeMarkers(this.props.markers.check),this.chessConsole.state.plyViewed===this.chessConsole.state.chess.plyCount()){let t=this.chessConsole.state.chess.lastMove();if(t&&(this.chessboard.addMarker(this.props.markers.moveInput,t.from),this.chessboard.addMarker(this.props.markers.moveInput,t.to)),this.chessConsole.state.chess.inCheck()||this.chessConsole.state.chess.inCheckmate()){let e=this.chessConsole.state.chess.pieces("k",this.chessConsole.state.chess.turn())[0];this.chessboard.addMarker(this.props.markers.check,e.square)}}})}setPlayerNames(){window.clearTimeout(this.setPlayerNamesDebounce),this.setPlayerNamesDebounce=setTimeout(()=>{this.chessConsole.props.playerColor===this.chessConsole.state.orientation?(this.elements.playerBottom.innerHTML=this.chessConsole.player.name,this.elements.playerTop.innerHTML=this.chessConsole.opponent.name):(this.elements.playerBottom.innerHTML=this.chessConsole.opponent.name,this.elements.playerTop.innerHTML=this.chessConsole.player.name)})}markPlayerToMove(){clearTimeout(this.markPlayerToMoveDebounce),this.markPlayerToMoveDebounce=setTimeout(()=>{this.elements.playerTop.classList.remove("to-move"),this.elements.playerBottom.classList.remove("to-move"),this.elements.playerTop.classList.remove("not-to-move"),this.elements.playerBottom.classList.remove("not-to-move");let t=this.chessConsole.playerToMove();this.chessConsole.state.orientation===U.white&&t===this.chessConsole.playerWhite()||this.chessConsole.state.orientation===U.black&&t===this.chessConsole.playerBlack()?(this.elements.playerBottom.classList.add("to-move"),this.elements.playerTop.classList.add("not-to-move")):(this.elements.playerTop.classList.add("to-move"),this.elements.playerBottom.classList.add("not-to-move"))},10)}},Vs=class extends rs{drawAutoMarkers(t){clearTimeout(this.drawAutoMarkersDebounced),this.drawAutoMarkersDebounced=setTimeout(()=>{this.removeMarkers(this.props.autoMarkers);let e=this.props.board,i=this.props.board.chessConsole.state.chess.moves({square:t.square,verbose:!0});if(e.props.markLegalMoves&&((t.type===j.moveInputStarted||t.type===j.validateMoveInput||t.type===j.moveInputCanceled||t.type===j.moveInputFinished)&&(t.chessboard.removeMarkers(e.props.markers.legalMove),t.chessboard.removeMarkers(e.props.markers.legalMoveCapture)),t.type===j.moveInputStarted))for(let n of i)n.promotion&&n.promotion!=="q"||(t.chessboard.getPiece(n.to)?t.chessboard.addMarker(e.props.markers.legalMoveCapture,n.to):t.chessboard.addMarker(e.props.markers.legalMove,n.to));t.type===j.moveInputStarted?t.moveInputCallbackResult&&this.addMarker(this.props.autoMarkers,t.squareFrom):t.type===j.movingOverSquare&&(this.addMarker(this.props.autoMarkers,t.squareFrom),t.squareTo&&this.addMarker(this.props.autoMarkers,t.squareTo))})}};var Ws=class extends ae{constructor(t){super(t.componentContainers.notifications),this.chessConsole=t,this.i18n=t.i18n,this.i18n.load({de:{game_over:"Das Spiel ist beendet",check:"Schach!",checkmate:"Schachmatt",draw:"Remis",stalemate:"Patt",threefold_repetition:"Remis durch dreifache Wiederholung"},en:{game_over:"The game is over",check:"Check!",checkmate:"Checkmate",draw:"Remis",stalemate:"Stalemate",threefold_repetition:"Remis by threefold repetition"}}),this.element=document.createElement("div"),this.element.setAttribute("class","gameState alert alert-primary mb-2"),this.context.appendChild(this.element),this.chessConsole.state.observeChess(()=>{this.redraw()}),this.redraw()}redraw(){let t=this.chessConsole.state.chess,e="";t.gameOver()?(e+=`<b>${this.i18n.t("game_over")}</b><br/>`,t.inCheckmate()?e+=`${this.i18n.t("checkmate")}`:t.inStalemate()?e+=`${this.i18n.t("stalemate")}`:t.inThreefoldRepetition()?e+=`${this.i18n.t("threefold_repetition")}`:t.inDraw()&&(e+=`${this.i18n.t("draw")}`)):t.inCheck()?e=`${this.i18n.t("check")}`:e="",e?(this.chessConsole.componentContainers.notifications.style.display="block",this.element.innerHTML=`${e}`):this.chessConsole.componentContainers.notifications.style.display="none"}};var Ii={notation:{de:{R:"T",N:"S",B:"L",Q:"D",K:"K",P:""}},figures:{utf8:{Rw:"\u2656",Nw:"\u2658",Bw:"\u2657",Qw:"\u2655",Kw:"\u2654",Pw:"\u2659",Rb:"\u265C",Nb:"\u265E",Bb:"\u265D",Qb:"\u265B",Kb:"\u265A",Pb:"\u265F"},fontAwesomePro:{Rw:'<i class="far fa-fw fa-chess-rook"></i>',Nw:'<i class="far fa-fw fa-chess-knight"></i>',Bw:'<i class="far fa-fw fa-chess-bishop"></i>',Qw:'<i class="far fa-fw fa-chess-queen"></i>',Kw:'<i class="far fa-fw fa-chess-king"></i>',Pw:'<i class="far fa-fw fa-chess-pawn"></i>',Rb:'<i class="fas fa-fw fa-chess-rook"></i>',Nb:'<i class="fas fa-fw fa-chess-knight"></i>',Bb:'<i class="fas fa-fw fa-chess-bishop"></i>',Qb:'<i class="fas fa-fw fa-chess-queen"></i>',Kb:'<i class="fas fa-fw fa-chess-king"></i>',Pb:'<i class="fas fa-fw fa-chess-pawn"></i>'}}},$t=class{static san(t,e=re.white,i="en",n="text",o=Ii.figures.utf8){if(n==="figures")return e===re.white?this.replaceAll(t,{R:o.Rw,N:o.Nw,B:o.Bw,Q:o.Qw,K:o.Kw}):this.replaceAll(t,{R:o.Rb,N:o.Nb,B:o.Bb,Q:o.Qb,K:o.Kb});if(n==="text")return this.replaceAll(t,Ii.notation[i]);console.error("mode must be 'text' or 'figures'")}static replaceAll(t,e,i=!1){let n=t,o=i?"gi":"g";for(let l in e)n=n.replace(new RegExp(l,o),e[l]);return n}};var Hs=class extends ae{constructor(t,e){super(t.componentContainers.left.querySelector(".chess-console-history"),e),this.chessConsole=t,this.element=document.createElement("div"),this.element.setAttribute("class","history"),this.context.appendChild(this.element),this.props={notationType:"figures",makeClickable:!0},Object.assign(this.props,e),this.chessConsole.state.observeChess(()=>{this.redraw()}),X.property(t.state,"plyViewed",()=>{this.redraw()}),this.props.makeClickable&&this.addClickEvents(),this.i18n=t.i18n,this.i18n.load({de:{game_history:"Spielnotation"},en:{game_history:"Game notation"}}).then(()=>{this.redraw()})}addClickEvents(){this.clickHandler=ge.delegate(this.element,"click",".ply",t=>{let e=parseInt(t.target.getAttribute("data-ply"),10);e<=this.chessConsole.state.chess.history().length&&(this.chessConsole.state.plyViewed=e)}),this.element.classList.add("clickable")}removeClickEvents(){this.clickHandler.remove(),this.element.classList.remove("clickable")}redraw(){window.clearTimeout(this.redrawDebounce),this.redrawDebounce=setTimeout(()=>{let t=this.chessConsole.state.chess.history(),e,i,n="",o,l="",f="",m="";for(o=0;o<t.length;o+=2){let g=t[o];g&&(e=$t.san(g.san,re.white,this.chessConsole.i18n.lang,this.props.notationType,this.chessConsole.props.figures));let x=t[o+1];x?i=$t.san(x.san,re.black,this.chessConsole.i18n.lang,this.props.notationType,this.chessConsole.props.figures):i="",this.chessConsole.state.plyViewed<o+1&&(f="text-muted"),this.chessConsole.state.plyViewed===o+1&&(f="active"),this.chessConsole.state.plyViewed<o+2&&(m="text-muted"),this.chessConsole.state.plyViewed===o+2&&(m="active"),n+="<tr><td class='num "+l+"'>"+(o/2+1)+".</td><td data-ply='"+(o+1)+"' class='ply "+f+" ply"+(o+1)+"'>"+e+"</td><td data-ply='"+(o+2)+"' class='ply "+m+" ply"+(o+2)+"'>"+i+"</td></tr>"}if(this.element.innerHTML="<h2 class='visually-hidden'>"+this.i18n.t("game_history")+"</h2><table>"+n+"</table>",this.chessConsole.state.plyViewed>0){let g=$(this.element).find(".ply"+this.chessConsole.state.plyViewed);g.position()&&(this.element.scrollTop=0,this.element.scrollTop=g.position().top-68)}})}};var qi="&#8203;",Ks=class extends ae{constructor(t){super(t),this.chessConsole=t,this.element=document.createElement("div"),this.element.setAttribute("class","captured-pieces"),this.chessConsole.componentContainers.left.querySelector(".chess-console-captured").appendChild(this.element),this.chessConsole.state.observeChess(()=>{this.redraw()}),X.property(this.chessConsole.state,"plyViewed",()=>{this.redraw()}),X.property(this.chessConsole.state,"orientation",()=>{this.redraw()}),this.i18n=t.i18n,this.i18n.load({de:{captured_pieces:"Geschlagene Figuren"},en:{captured_pieces:"Captured pieces"}}).then(()=>{this.redraw()}),ge.delegate(this.element,"click",".piece",e=>{let i=e.target.getAttribute("data-ply");this.chessConsole.state.plyViewed=parseInt(i,10)})}redraw(){window.clearTimeout(this.redrawDebounce),this.redrawDebounce=setTimeout(()=>{let t=[],e=[],i=[],n=[],o=this.chessConsole.state.chess.history({verbose:!0}),l=0,f=0;o.forEach((x,k)=>{if(x.flags.indexOf("c")!==-1||x.flags.indexOf("e")!==-1){let ee=x.captured.toUpperCase();if(x.color==="b"){let de=`<span class="piece" role='button' data-ply='${x.ply}'>`+this.chessConsole.props.figures[ee+"w"]+"</span>";k<this.chessConsole.state.plyViewed?t.push(de):e.push(de),l+=Ps[ee.toLowerCase()].value}else if(x.color==="w"){let de=`<span class="piece" role='button' data-ply='${x.ply}'>`+this.chessConsole.props.figures[ee+"b"]+"</span>";k<this.chessConsole.state.plyViewed?i.push(de):n.push(de),f+=Ps[ee.toLowerCase()].value}}});let m=this.renderPieces(t,e,l),g=this.renderPieces(i,n,f);this.element.innerHTML="<h2 class='visually-hidden'>"+this.i18n.t("captured_pieces")+"</h2>"+(this.chessConsole.state.orientation==="w"?m+g:g+m)})}renderPieces(t,e,i){let n="<div>";return t.length>0&&(n+=t.join(qi)),e.length>0&&(n+="<span class='text-muted'>"+e.join(qi)+"</span>"),n+="<small> "+(i>0?i:"")+"</small></div>",n}};var zs=class extends ae{constructor(t,e={}){super(t.componentContainers.controlButtons),this.chessConsole=t;let i=t.i18n;this.props={autoPlayDelay:1500},Object.assign(this.props,e),i.load({de:{to_game_start:"Zum Spielstart",one_move_back:"Ein Zug zur\xFCck",one_move_forward:"Ein Zug weiter",to_last_move:"Zum letzen Zug",auto_run:"Automatisch abspielen",turn_board:"Brett drehen"},en:{to_game_start:"To game start",one_move_back:"One move back",one_move_forward:"One move forward",to_last_move:"To last move",auto_run:"Auto play",turn_board:"Turn board"}}).then(()=>{this.$btnFirst=$(`<button type="button" title="${i.t("to_game_start")}" class="btn btn-link text-black first"><i class="fa fa-fw fa-fast-backward" aria-hidden="true"></i></button>`),this.$btnBack=$(`<button type="button" title="${i.t("one_move_back")}" class="btn btn-link text-black back"><i class="fa fa-fw fa-step-backward" aria-hidden="true"></i></button>`),this.$btnForward=$(`<button type="button" title="${i.t("one_move_forward")}" class="btn btn-link text-black forward"><i class="fa fa-fw fa-step-forward" aria-hidden="true"></i></button>`),this.$btnLast=$(`<button type="button" title="${i.t("to_last_move")}" class="btn btn-link text-black last"><i class="fa fa-fw fa-fast-forward" aria-hidden="true"></i></button>`),this.$btnAutoplay=$(`<button type="button" title="${i.t("auto_run")}" class="btn btn-link text-black autoplay"><i class="fa fa-fw fa-play" aria-hidden="true"></i><i class="fa fa-fw fa-stop" aria-hidden="true"></i></button>`),this.$btnOrientation=$(`<button type="button" title="${i.t("turn_board")}" class="btn btn-link text-black orientation"><i class="fa fa-fw fa-exchange-alt fa-rotate-90" aria-hidden="true"></i></button>`),this.context.appendChild(this.$btnFirst[0]),this.context.appendChild(this.$btnBack[0]),this.context.appendChild(this.$btnForward[0]),this.context.appendChild(this.$btnLast[0]),this.context.appendChild(this.$btnAutoplay[0]),this.context.appendChild(this.$btnOrientation[0]),this.chessConsole.state.observeChess(()=>{this.setButtonStates()}),X.property(this.chessConsole.state,"plyViewed",()=>{this.setButtonStates()}),X.property(this.chessConsole.state,"orientation",()=>{this.chessConsole.state.orientation!==this.chessConsole.props.playerColor?this.$btnOrientation.addClass("btn-active"):this.$btnOrientation.removeClass("btn-active")}),this.$btnFirst.click(()=>{this.chessConsole.state.plyViewed=0,this.resetAutoPlay()}),this.$btnBack.click(()=>{this.chessConsole.state.plyViewed--,this.resetAutoPlay()}),this.$btnForward.click(()=>{this.chessConsole.state.plyViewed++,this.resetAutoPlay()}),this.$btnLast.click(()=>{this.chessConsole.state.plyViewed=this.chessConsole.state.chess.plyCount(),this.resetAutoPlay()}),this.$btnOrientation.click(()=>{this.chessConsole.state.orientation=this.chessConsole.state.orientation===U.white?U.black:U.white}),this.$btnAutoplay.click(()=>{this.autoplay?(clearInterval(this.autoplay),this.autoplay=null):(this.chessConsole.state.plyViewed++,this.autoplay=setInterval(this.autoPlayMove.bind(this),this.props.autoPlayDelay)),this.updatePlayIcon()}),this.setButtonStates()})}resetAutoPlay(){this.autoplay&&(clearInterval(this.autoplay),this.autoplay=setInterval(this.autoPlayMove.bind(this),this.props.autoPlayDelay))}autoPlayMove(){this.chessConsole.state.plyViewed>=this.chessConsole.state.chess.plyCount()?(clearInterval(this.autoplay),this.autoplay=null,this.updatePlayIcon()):(this.chessConsole.state.plyViewed++,this.chessConsole.state.plyViewed>=this.chessConsole.state.chess.plyCount()&&(clearInterval(this.autoplay),this.autoplay=null,this.updatePlayIcon()))}updatePlayIcon(){let t=this.$btnAutoplay.find(".fa-play"),e=this.$btnAutoplay.find(".fa-stop");this.autoplay?(t.hide(),e.show()):(t.show(),e.hide())}setButtonStates(){window.clearTimeout(this.redrawDebounce),this.redrawDebounce=setTimeout(()=>{this.chessConsole.state.plyViewed>0?(this.$btnFirst.prop("disabled",!1),this.$btnBack.prop("disabled",!1)):(this.$btnFirst.prop("disabled",!0),this.$btnBack.prop("disabled",!0)),this.chessConsole.state.plyViewed<this.chessConsole.state.chess.plyCount()?(this.$btnLast.prop("disabled",!1),this.$btnForward.prop("disabled",!1),this.$btnAutoplay.prop("disabled",!1)):(this.$btnLast.prop("disabled",!0),this.$btnForward.prop("disabled",!0),this.$btnAutoplay.prop("disabled",!0))}),this.updatePlayIcon()}};var Qs=class extends tt{constructor(t,e){super(e),this.chessConsole=t,this.props.savePrefix||(this.props.savePrefix="ChessConsole"),this.chessConsole.state.observeChess(()=>{this.save()}),this.chessConsole.messageBroker.subscribe(Q.newGame,()=>{this.save()}),this.chessConsole.persistence=this}load(t=this.props.savePrefix){let e={};try{this.loadValue("PlayerColor")!==null?e.playerColor=this.loadValue("PlayerColor"):e.playerColor=re.white,localStorage.getItem(t+"Pgn")!==null&&(e.pgn=localStorage.getItem(t+"Pgn")),this.chessConsole.messageBroker.publish(Q.load),this.chessConsole.initGame(e)}catch(i){localStorage.clear(),console.warn(i),this.chessConsole.initGame({playerColor:re.white})}}loadValue(t,e=this.props.savePrefix){let i=null;try{return i=localStorage.getItem(e+t),JSON.parse(i)}catch(n){console.error("error loading ",e+t),console.error("item:"+i),console.error(n)}}save(t=this.props.savePrefix){localStorage.setItem(t+"PlayerColor",JSON.stringify(this.chessConsole.props.playerColor)),localStorage.setItem(t+"Pgn",this.chessConsole.state.chess.renderPgn())}saveValue(t,e,i=this.props.savePrefix){localStorage.setItem(i+t,JSON.stringify(e))}};window.AudioContext=window.AudioContext||window.webkitAudioContext;var Ge=new AudioContext,hs=Ge.createGain();hs.gain.value=1;hs.connect(Ge.destination);var Oi=["click","touchstart","touchend","keydown","mousedown","mouseup","dblclick"];function Lr(){Oi.forEach(c=>{document.addEventListener(c,Li)})}function Rr(){Oi.forEach(c=>{document.removeEventListener(c,Li)})}function Li(){Ge.state!=="running"&&Ge.resume().then(()=>{console.log("AudioContext resumed successfully, state:",Ge.state),Rr()})}console.log("AudioContext.state:",Ge.state);Lr();var Ve=class{static context(){return Ge}static destination(){return hs}static setGain(t){hs.gain.setValueAtTime(t,Ge.currentTime)}static isEnabled(){return Ge.state==="running"}};var us=class{constructor(t,e={}){this.src=t,this.props={gain:1,startWithoutAudioContext:!0},Object.assign(this.props,e),this.gainNode=Ve.context().createGain(),this.setGain(this.props.gain),this.audioBuffer=null,this.load()}setGain(t){this.gainNode.gain.setValueAtTime(t,Ve.context().currentTime)}play(t=void 0,e=void 0,i=void 0){(this.props.startWithoutAudioContext||Ve.isEnabled())&&this.loading.then(()=>{let n;n=this.createBufferSource(),n.start(t,e,i)})}createBufferSource(){let t=Ve.context().createBufferSource();return t.buffer=this.audioBuffer,t.connect(this.gainNode),this.gainNode.connect(Ve.destination()),t}load(){return this.loading=new Promise((t,e)=>{let i=new XMLHttpRequest;i.open("GET",this.src,!0),i.responseType="arraybuffer",i.onload=()=>{Ve.context().decodeAudioData(i.response,n=>{this.audioBuffer=n,t()},()=>{console.error("error loading sound",this.src),e()})},i.send()}),this.loading}};var ps=class extends us{play(t,e=0){let i=this.props.slices[t];if(!i)throw new Error(`slice ${t} not found in sprite`);super.play(e,i.offset,i.duration)}};var Ys=class extends tt{constructor(t,e){super(e),this.chessConsole=t,this.audioSprite=new ps(this.props.soundSpriteFile,{gain:1,slices:{game_start:{offset:0,duration:.9},game_won:{offset:.9,duration:1.8},game_lost:{offset:2.7,duration:.9},game_draw:{offset:9.45,duration:1.35},check:{offset:3.6,duration:.45},wrong_move:{offset:4.05,duration:.45},move:{offset:4.5,duration:.2},capture:{offset:6.3,duration:.2},castle:{offset:7.65,duration:.2},take_back:{offset:8.1,duration:.12},promotion:{offset:9,duration:.45},dialog:{offset:10.8,duration:.45}}}),t.messageBroker.subscribe(Q.initGame,()=>{}),t.messageBroker.subscribe(Q.legalMove,i=>{let n=this.chessConsole.state.chess,o=i.moveResult.flags;o.indexOf("p")!==-1?this.play("promotion"):o.indexOf("c")!==-1?this.play("capture"):o.indexOf("k")!==-1||o.indexOf("q")!==-1?this.play("castle"):(clearInterval(this.moveDebounced),this.moveDebounced=setTimeout(()=>{this.play("move")},10)),(n.inCheck()||n.inCheckmate())&&this.play("check")}),t.messageBroker.subscribe(Q.illegalMove,()=>{this.play("wrong_move")}),t.messageBroker.subscribe(Q.moveUndone,()=>{this.play("take_back")}),t.messageBroker.subscribe(Q.gameOver,i=>{setTimeout(()=>{i.wonColor?i.wonColor===this.chessConsole.props.playerColor?this.play("game_won"):this.play("game_lost"):this.play("game_lost")},500)}),t.sound=this}play(t){this.audioSprite.play(t)}};var js=class{constructor(t){this.props={title:"",body:"",footer:"",modalClass:"fade",modalDialogClass:"",headerClass:"",bodyClass:"",footerClass:"",theme:void 0,options:{backdrop:"static"},draggable:!1,onCreate:null,onShown:null,onDispose:null,onSubmit:null},Object.assign(this.props,t),this.id="bootstrap-show-modal-"+Ri,Ri++,this.show(),this.props.onCreate&&this.props.onCreate(this)}createContainerElement(){let t=this;this.element=document.createElement("div"),this.element.id=this.id;let e="modal "+this.props.modalClass;this.props.theme==="dark"&&(e+=" text-light"),this.element.setAttribute("class",e),this.element.setAttribute("tabindex","-1"),this.element.setAttribute("role","dialog"),this.element.setAttribute("aria-labelledby",this.id),this.props.theme&&this.element.setAttribute("data-bs-theme",this.props.theme),this.element.innerHTML=`
<div class="modal-dialog ${this.props.modalDialogClass}" role="document">
    <div class="modal-content">
    <div class="modal-header ${this.props.headerClass}">
        <h5 class="modal-title"></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
    </div>
    <div class="modal-body ${this.props.bodyClass}"></div>
    <div class="modal-footer ${this.props.footerClass}"></div>
    </div>
</div>`,document.body.appendChild(this.element),this.titleElement=this.element.querySelector(".modal-title"),this.bodyElement=this.element.querySelector(".modal-body"),this.footerElement=this.element.querySelector(".modal-footer"),this.element.addEventListener("hidden.bs.modal",function(){t.dispose()}),this.element.addEventListener("shown.bs.modal",function(){t.props.onShown&&t.props.onShown(t)})}show(){if(this.element){let t=bootstrap.Modal.getInstance(this.element);t&&t.show()}else if(this.createContainerElement(),this.props.options){let t=new bootstrap.Modal(this.element,this.props.options);t&&t.show()}else{let t=new bootstrap.Modal(this.element);t&&t.show()}this.props.title?(this.titleElement.style.display="",this.titleElement.innerHTML=this.props.title):this.titleElement.style.display="none",this.props.body?(this.bodyElement.style.display="",this.bodyElement.innerHTML=this.props.body):this.bodyElement.style.display="none",this.props.footer?(this.footerElement.style.display="",this.footerElement.innerHTML=this.props.footer):this.footerElement.style.display="none"}hide(){let t=bootstrap.Modal.getInstance(this.element);t&&t.hide()}dispose(){let t=bootstrap.Modal.getInstance(this.element);t&&t.dispose(),document.body.removeChild(this.element),this.props.onDispose&&this.props.onDispose(this)}},Ri=0;bootstrap.showModal=c=>{if(c.buttons){let t="";for(let e in c.buttons){let i=c.buttons[e];t+=`<button type="button" class="btn btn-primary" data-value="${e}" data-bs-dismiss="modal">${i}</button>`}c.footer=t}return new js(c)};bootstrap.showAlert=c=>(c.buttons={OK:"OK"},bootstrap.showModal(c));bootstrap.showConfirm=c=>(c.footer=`<button class="btn btn-secondary btn-false btn-cancel">${c.textFalse}</button><button class="btn btn-primary btn-true">${c.textTrue}</button>`,c.onCreate=t=>{let e=bootstrap.Modal.getInstance(t.element);t.element.querySelector(".btn-false").addEventListener("click",function(){e&&e.hide(),t.props.onSubmit(!1,t)}),t.element.querySelector(".btn-true").addEventListener("click",function(){e&&e.hide(),t.props.onSubmit(!0,t)})},bootstrap.showModal(c));var fs=class{constructor(t,e){let i=t.i18n;i.load({de:{color:"Farbe",white:"Weiss",black:"Schwarz",auto:"automatisch"},en:{color:"Color",white:"White",black:"Black",auto:"automatically"}}).then(()=>{let n=t.persistence.loadValue("newGameColor");e.modalClass="fade",e.body=`<form class="form"><div class="form-group row">
                    <div class="col-3"><label for="color" class="col-form-label">${i.t("color")}</label></div>
                    <div class="col-9"><select id="color" class="form-select">
                        <option value="auto">${i.t("auto")}</option>
                        <option value="w" ${n==="w"?"selected":""}>${i.t("white")}</option>
                        <option value="b" ${n==="b"?"selected":""}>${i.t("black")}</option>
                    </select></div>
                </div></form>`,e.footer=`<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">${i.t("cancel")}</button>
            <button type="submit" class="btn btn-primary">${i.t("ok")}</button>`,e.onCreate=o=>{o.element.querySelector("button[type='submit']").addEventListener("click",function(l){l.preventDefault();let m=o.element.querySelector(".form").querySelector("#color").value;t.persistence.saveValue("newGameColor",m),m!==re.white&&m!==re.black&&(m=t.props.playerColor===re.white?re.black:re.white),o.hide(),t.newGame({playerColor:m})})},bootstrap.showModal(e)})}};var ds=class extends ae{constructor(t,e){super(t.componentContainers.controlButtons,e),this.chessConsole=t;let i=t.i18n;i.load({de:{start_game:"Ein neues Spiel starten",undo_move:"Zug zur\xFCck nehmen"},en:{start_game:"Start a new game",undo_move:"Undo move"}}).then(()=>{this.$btnUndoMove=$(`<button type="button" title="${i.t("undo_move")}" class="btn btn-icon btn-light undoMove"><i class="fa fa-fw fa-undo-alt" aria-hidden="true"></i></button>`),this.$btnStartNewGame=$(`<button type="button" title="${i.t("start_game")}" class="btn btn-icon btn-light startNewGame"><i class="fa fa-fw fa-plus" aria-hidden="true"></i></button>\`)`),this.context.appendChild(this.$btnUndoMove[0]),this.context.appendChild(this.$btnStartNewGame[0]),this.$btnUndoMove.click(()=>{this.chessConsole.undoMove()}),this.$btnStartNewGame.click(()=>{this.showNewGameDialog()}),this.chessConsole.state.observeChess(()=>{this.setButtonStates()}),this.setButtonStates()})}showNewGameDialog(){new fs(this.chessConsole,{title:this.chessConsole.i18n.t("start_game")})}setButtonStates(){this.chessConsole.state.chess.plyCount()<2?this.$btnUndoMove.prop("disabled",!0):this.$btnUndoMove.prop("disabled",!1)}};var ne={LOADING:1,LOADED:2,READY:3,THINKING:4},dt=class{constructor(t){this.props={debug:!1,responseDelay:1e3},Object.assign(this.props,t),this.engineState=ne.LOADING,this.initialized=this.init(),this.initialization=this.initialized}init(){return Promise.reject("you have to implement `init()` in the EngineRunner")}calculateMove(t,e={}){}};var ms={1:[3,0],2:[3,1],3:[4,2],4:[5,3],5:[5,4],6:[6,5],7:[7,6],8:[8,7],9:[9,8],10:[10,10],11:[11,11],12:[12,12],13:[13,13],14:[14,14],15:[15,15],16:[16,16],17:[17,17],18:[18,18],19:[19,19],20:[20,20]},Cs=class extends dt{constructor(t){super(t)}init(){return new Promise(t=>{let e=i=>{this.workerListener(i)};this.engineWorker&&(this.engineWorker.removeEventListener("message",e),this.engineWorker.terminate()),this.engineWorker=new Worker(this.props.workerUrl),this.engineWorker.addEventListener("message",e),this.uciCmd("uci"),this.uciCmd("ucinewgame"),this.uciCmd("isready"),t()})}workerListener(t){this.props.debug&&(t.type==="message"?console.log("  msg",t.data):console.log(t));let e=t.data;if(e==="uciok")this.engineState=ne.LOADED;else if(e==="readyok")this.engineState=ne.READY;else{let i=e.match(/^info .*\bscore (\w+) (-?\d+)/);if(i){let n=parseInt(i[2],10),o;i[1]==="cp"?o=(n/100).toFixed(1):i[1]==="mate"&&(o="#"+Math.abs(n)),this.score=o}if(i=e.match(/^bestmove ([a-h][1-8])([a-h][1-8])([qrbk])?( ponder ([a-h][1-8])?([a-h][1-8])?)?/),i){this.engineState=ne.READY,i[4]!==void 0?this.ponder={from:i[5],to:i[6]}:this.ponder=void 0;let n={from:i[1],to:i[2],promotion:i[3],score:this.score,ponder:this.ponder};this.moveResponse(n)}else i=e.match(/^info .*\bdepth (\d+) .*\bnps (\d+)/),i&&(this.engineState=ne.THINKING,this.search="Depth: "+i[1]+" Nps: "+i[2])}}calculateMove(t,e={level:4}){this.engineState=ne.THINKING;let i=new Promise(o=>{setTimeout(async()=>{o()},this.props.responseDelay)}),n=new Promise(o=>{setTimeout(()=>{this.uciCmd("setoption name Skill Level value "+ms[e.level][1]),this.uciCmd("position fen "+t),this.uciCmd("go depth "+ms[e.level][0]),this.moveResponse=l=>{o(l)}},this.props.responseDelay)});return new Promise(o=>{Promise.all([this.initialisation,i,n]).then(l=>{this.engineState=ne.READY,o(l[2])})})}uciCmd(t){this.props.debug&&console.log("  uci ->",t),this.engineWorker.postMessage(t)}};var Mt=class{constructor(t,e){this.chessConsole=t,this.props=e;let i=t.i18n;i.load({de:{color:"Farbe",white:"Weiss",black:"Schwarz",auto:"Automatisch wechselnd",random:"Zufallsauswahl"},en:{color:"Color",white:"white",black:"black",auto:"automatically alternating",random:"random"}}).then(()=>{let n=t.persistence.loadValue("newGameColor");e.modalClass="fade",e.body=`<div class="form"><div class="form-group row">
                        <div class="col-3"><label for="color" class="col-form-label">${i.t("color")}</label></div>
                        <div class="col-9"><select id="color" class="form-control">
                        <option value="w" ${n==="w"?"selected":""}>${i.t("white")}</option>
                        <option value="b" ${n==="b"?"selected":""}>${i.t("black")}</option>
                        <option value="random" ${n==="random"?"selected":""}>${i.t("random")}</option>
                        <option value="auto" ${n==="auto"?"selected":""}>${i.t("auto")}</option>
                        </select></div>
                        </div>
                        <div class="form-group row">
                        <div class="col-3"><label for="level" class="col-form-label">${i.t("level")}</label></div>
                        <div class="col-9"><select id="level" class="form-control">
                        ${this.renderLevelOptions()}
                        </select></div>
                        </div></div>`,e.footer=`<button type="button" class="btn btn-link" data-dismiss="modal">${i.t("cancel")}</button>
            <button type="submit" class="btn btn-primary">${i.t("ok")}</button>`,e.onCreate=o=>{$(o.element).on("click","button[type='submit']",function(l){l.preventDefault();let f=$(o.element).find(".form"),m=f.find("#color").val();t.persistence.saveValue("newGameColor",m);let g=parseInt(f.find("#level").val(),10)||1;m==="auto"?m=t.props.playerColor===COLOR.white?COLOR.black:COLOR.white:m==="random"&&(m="wb".charAt(Math.floor(Math.random()*2))),o.hide(),t.newGame({playerColor:m,engineLevel:g})})},bootstrap.showModal(e)})}renderLevelOptions(){let t="",e=this.props.player.state.level,i=Object.keys(ms);for(let n=i[0];n<=i[i.length-1];n++){let o="";e===n&&(o="selected "),t+="<option "+o+'value="'+n+'">Level '+n+"</option>"}return t}};var Xs=class extends ds{showNewGameDialog(){new Mt(this.chessConsole,{title:this.chessConsole.i18n.t("start_game"),player:this.props.player})}};var It=class{constructor(t,e){this.ofs=e;let i=BigInt(0),n,o;for(n=0;n<8;++n)o=t.charCodeAt(e++),i=i<<BigInt(8)|BigInt(o);this.key=i;let l=0;for(n=0;n<2;++n)o=t.charCodeAt(e++),l=l<<8|o;this.raw_move=l;let f=0;for(n=0;n<2;++n)o=t.charCodeAt(e++),f=f<<8|o;this.weight=f;let m=0;for(n=0;n<4;++n)o=t.charCodeAt(e++),m=m<<8|o;this.learn=m}get_key(){return this.key}get_from_row(){return this.raw_move>>9&7}get_from_col(){return this.raw_move>>6&7}get_to_row(){return this.raw_move>>3&7}get_to_col(){return this.raw_move&7}get_promo_piece(){return this.raw_move>>12&7}isOOW(){return this.raw_move===263}isOOB(){return this.raw_move===3903}isOOOW(){return this.raw_move===256}isOOOB(){return this.raw_move===3896}},gs=class{constructor(t){this.bookdata=t,this.cache=[],this.bookdata.length>=32?(this.first=new It(this.bookdata,0),this.last=new It(this.bookdata,this.get_last_index())):(this.first=null,this.last=null)}get_length(){return this.bookdata.length/16}get_last_index(){return this.get_length()-1}get_offset(t){return t*16}get_entry(t){let e;return this.cache[t]===void 0?(e=new It(this.bookdata,this.get_offset(t)),this.cache[t]=e):e=this.cache[t],e}find_first_hash(t){if(this.first===null||this.last===null||t<this.first||t>this.last)return-1;if(t===this.first)return 0;let e=0,i=this.bookdata.length/16-1,n=i,o=0n;if(t!==this.last)for(;i-e>1&&(n=Math.floor((e+i)/2),o=this.get_entry(n).get_key(),o!==t);)o<t?e=n:i=n;if(o!==t)return-1;for(;n>0&&this.get_entry(n-1).get_key()===t;)n=n-1;return n}get_all_moves(t){let e=this.find_first_hash(t);if(e<0)return[];let i=[],n=this.get_entry(e);for(;n!==void 0&&n.get_key()===t;)i.push(n),n=this.get_entry(++e);return i}};var Nr=[0x9D39247E33776D41n,0x2AF7398005AAA5C7n,0x44DB015024623547n,0x9C15F73E62A76AE2n,0x75834465489C0C89n,0x3290AC3A203001BFn,0x0FBBAD1F61042279n,0xE83A908FF2FB60CAn,0x0D7E765D58755C10n,0x1A083822CEAFE02Dn,0x9605D5F0E25EC3B0n,0xD021FF5CD13A2ED5n,0x40BDF15D4A672E32n,0x011355146FD56395n,0x5DB4832046F3D9E5n,0x239F8B2D7FF719CCn,0x05D1A1AE85B49AA1n,0x679F848F6E8FC971n,0x7449BBFF801FED0Bn,0x7D11CDB1C3B7ADF0n,0x82C7709E781EB7CCn,0xF3218F1C9510786Cn,0x331478F3AF51BBE6n,0x4BB38DE5E7219443n,0xAA649C6EBCFD50FCn,0x8DBD98A352AFD40Bn,0x87D2074B81D79217n,0x19F3C751D3E92AE1n,0xB4AB30F062B19ABFn,0x7B0500AC42047AC4n,0xC9452CA81A09D85Dn,0x24AA6C514DA27500n,0x4C9F34427501B447n,0x14A68FD73C910841n,0xA71B9B83461CBD93n,0x03488B95B0F1850Fn,0x637B2B34FF93C040n,0x09D1BC9A3DD90A94n,0x3575668334A1DD3Bn,0x735E2B97A4C45A23n,0x18727070F1BD400Bn,0x1FCBACD259BF02E7n,0xD310A7C2CE9B6555n,0xBF983FE0FE5D8244n,0x9F74D14F7454A824n,0x51EBDC4AB9BA3035n,0x5C82C505DB9AB0FAn,0xFCF7FE8A3430B241n,0x3253A729B9BA3DDEn,0x8C74C368081B3075n,0xB9BC6C87167C33E7n,0x7EF48F2B83024E20n,0x11D505D4C351BD7Fn,0x6568FCA92C76A243n,0x4DE0B0F40F32A7B8n,0x96D693460CC37E5Dn,0x42E240CB63689F2Fn,0x6D2BDCDAE2919661n,0x42880B0236E4D951n,0x5F0F4A5898171BB6n,0x39F890F579F92F88n,0x93C5B5F47356388Bn,0x63DC359D8D231B78n,0xEC16CA8AEA98AD76n,0x5355F900C2A82DC7n,0x07FB9F855A997142n,0x5093417AA8A7ED5En,0x7BCBC38DA25A7F3Cn,0x19FC8A768CF4B6D4n,0x637A7780DECFC0D9n,0x8249A47AEE0E41F7n,0x79AD695501E7D1E8n,0x14ACBAF4777D5776n,0xF145B6BECCDEA195n,0xDABF2AC8201752FCn,0x24C3C94DF9C8D3F6n,0xBB6E2924F03912EAn,0x0CE26C0B95C980D9n,0xA49CD132BFBF7CC4n,0xE99D662AF4243939n,0x27E6AD7891165C3Fn,0x8535F040B9744FF1n,0x54B3F4FA5F40D873n,0x72B12C32127FED2Bn,0xEE954D3C7B411F47n,0x9A85AC909A24EAA1n,0x70AC4CD9F04F21F5n,0xF9B89D3E99A075C2n,0x87B3E2B2B5C907B1n,0xA366E5B8C54F48B8n,0xAE4A9346CC3F7CF2n,0x1920C04D47267BBDn,0x87BF02C6B49E2AE9n,0x092237AC237F3859n,0xFF07F64EF8ED14D0n,0x8DE8DCA9F03CC54En,0x9C1633264DB49C89n,0xB3F22C3D0B0B38EDn,0x390E5FB44D01144Bn,0x5BFEA5B4712768E9n,0x1E1032911FA78984n,0x9A74ACB964E78CB3n,0x4F80F7A035DAFB04n,0x6304D09A0B3738C4n,0x2171E64683023A08n,0x5B9B63EB9CEFF80Cn,0x506AACF489889342n,0x1881AFC9A3A701D6n,0x6503080440750644n,0xDFD395339CDBF4A7n,0xEF927DBCF00C20F2n,0x7B32F7D1E03680ECn,0xB9FD7620E7316243n,0x05A7E8A57DB91B77n,0xB5889C6E15630A75n,0x4A750A09CE9573F7n,0xCF464CEC899A2F8An,0xF538639CE705B824n,0x3C79A0FF5580EF7Fn,0xEDE6C87F8477609Dn,0x799E81F05BC93F31n,0x86536B8CF3428A8Cn,0x97D7374C60087B73n,0xA246637CFF328532n,0x043FCAE60CC0EBA0n,0x920E449535DD359En,0x70EB093B15B290CCn,0x73A1921916591CBDn,0x56436C9FE1A1AA8Dn,0xEFAC4B70633B8F81n,0xBB215798D45DF7AFn,0x45F20042F24F1768n,0x930F80F4E8EB7462n,0xFF6712FFCFD75EA1n,0xAE623FD67468AA70n,0xDD2C5BC84BC8D8FCn,0x7EED120D54CF2DD9n,0x22FE545401165F1Cn,0xC91800E98FB99929n,0x808BD68E6AC10365n,0xDEC468145B7605F6n,0x1BEDE3A3AEF53302n,0x43539603D6C55602n,0xAA969B5C691CCB7An,0xA87832D392EFEE56n,0x65942C7B3C7E11AEn,0xDED2D633CAD004F6n,0x21F08570F420E565n,0xB415938D7DA94E3Cn,0x91B859E59ECB6350n,0x10CFF333E0ED804An,0x28AED140BE0BB7DDn,0xC5CC1D89724FA456n,0x5648F680F11A2741n,0x2D255069F0B7DAB3n,0x9BC5A38EF729ABD4n,0xEF2F054308F6A2BCn,0xAF2042F5CC5C2858n,0x480412BAB7F5BE2An,0xAEF3AF4A563DFE43n,0x19AFE59AE451497Fn,0x52593803DFF1E840n,0xF4F076E65F2CE6F0n,0x11379625747D5AF3n,0xBCE5D2248682C115n,0x9DA4243DE836994Fn,0x066F70B33FE09017n,0x4DC4DE189B671A1Cn,0x51039AB7712457C3n,0xC07A3F80C31FB4B4n,0xB46EE9C5E64A6E7Cn,0xB3819A42ABE61C87n,0x21A007933A522A20n,0x2DF16F761598AA4Fn,0x763C4A1371B368FDn,0xF793C46702E086A0n,0xD7288E012AEB8D31n,0xDE336A2A4BC1C44Bn,0x0BF692B38D079F23n,0x2C604A7A177326B3n,0x4850E73E03EB6064n,0xCFC447F1E53C8E1Bn,0xB05CA3F564268D99n,0x9AE182C8BC9474E8n,0xA4FC4BD4FC5558CAn,0xE755178D58FC4E76n,0x69B97DB1A4C03DFEn,0xF9B5B7C4ACC67C96n,0xFC6A82D64B8655FBn,0x9C684CB6C4D24417n,0x8EC97D2917456ED0n,0x6703DF9D2924E97En,0xC547F57E42A7444En,0x78E37644E7CAD29En,0xFE9A44E9362F05FAn,0x08BD35CC38336615n,0x9315E5EB3A129ACEn,0x94061B871E04DF75n,0xDF1D9F9D784BA010n,0x3BBA57B68871B59Dn,0xD2B7ADEEDED1F73Fn,0xF7A255D83BC373F8n,0xD7F4F2448C0CEB81n,0xD95BE88CD210FFA7n,0x336F52F8FF4728E7n,0xA74049DAC312AC71n,0xA2F61BB6E437FDB5n,0x4F2A5CB07F6A35B3n,0x87D380BDA5BF7859n,0x16B9F7E06C453A21n,0x7BA2484C8A0FD54En,0xF3A678CAD9A2E38Cn,0x39B0BF7DDE437BA2n,0xFCAF55C1BF8A4424n,0x18FCF680573FA594n,0x4C0563B89F495AC3n,0x40E087931A00930Dn,0x8CFFA9412EB642C1n,0x68CA39053261169Fn,0x7A1EE967D27579E2n,0x9D1D60E5076F5B6Fn,0x3810E399B6F65BA2n,0x32095B6D4AB5F9B1n,0x35CAB62109DD038An,0xA90B24499FCFAFB1n,0x77A225A07CC2C6BDn,0x513E5E634C70E331n,0x4361C0CA3F692F12n,0xD941ACA44B20A45Bn,0x528F7C8602C5807Bn,0x52AB92BEB9613989n,0x9D1DFA2EFC557F73n,0x722FF175F572C348n,0x1D1260A51107FE97n,0x7A249A57EC0C9BA2n,0x04208FE9E8F7F2D6n,0x5A110C6058B920A0n,0x0CD9A497658A5698n,0x56FD23C8F9715A4Cn,0x284C847B9D887AAEn,0x04FEABFBBDB619CBn,0x742E1E651C60BA83n,0x9A9632E65904AD3Cn,0x881B82A13B51B9E2n,0x506E6744CD974924n,0xB0183DB56FFC6A79n,0x0ED9B915C66ED37En,0x5E11E86D5873D484n,0xF678647E3519AC6En,0x1B85D488D0F20CC5n,0xDAB9FE6525D89021n,0x0D151D86ADB73615n,0xA865A54EDCC0F019n,0x93C42566AEF98FFBn,0x99E7AFEABE000731n,0x48CBFF086DDF285An,0x7F9B6AF1EBF78BAFn,0x58627E1A149BBA21n,0x2CD16E2ABD791E33n,0xD363EFF5F0977996n,0x0CE2A38C344A6EEDn,0x1A804AADB9CFA741n,0x907F30421D78C5DEn,0x501F65EDB3034D07n,0x37624AE5A48FA6E9n,0x957BAF61700CFF4En,0x3A6C27934E31188An,0xD49503536ABCA345n,0x088E049589C432E0n,0xF943AEE7FEBF21B8n,0x6C3B8E3E336139D3n,0x364F6FFA464EE52En,0xD60F6DCEDC314222n,0x56963B0DCA418FC0n,0x16F50EDF91E513AFn,0xEF1955914B609F93n,0x565601C0364E3228n,0xECB53939887E8175n,0xBAC7A9A18531294Bn,0xB344C470397BBA52n,0x65D34954DAF3CEBDn,0xB4B81B3FA97511E2n,0xB422061193D6F6A7n,0x071582401C38434Dn,0x7A13F18BBEDC4FF5n,0xBC4097B116C524D2n,0x59B97885E2F2EA28n,0x99170A5DC3115544n,0x6F423357E7C6A9F9n,0x325928EE6E6F8794n,0xD0E4366228B03343n,0x565C31F7DE89EA27n,0x30F5611484119414n,0xD873DB391292ED4Fn,0x7BD94E1D8E17DEBCn,0xC7D9F16864A76E94n,0x947AE053EE56E63Cn,0xC8C93882F9475F5Fn,0x3A9BF55BA91F81CAn,0xD9A11FBB3D9808E4n,0x0FD22063EDC29FCAn,0xB3F256D8ACA0B0B9n,0xB03031A8B4516E84n,0x35DD37D5871448AFn,0xE9F6082B05542E4En,0xEBFAFA33D7254B59n,0x9255ABB50D532280n,0xB9AB4CE57F2D34F3n,0x693501D628297551n,0xC62C58F97DD949BFn,0xCD454F8F19C5126An,0xBBE83F4ECC2BDECBn,0xDC842B7E2819E230n,0xBA89142E007503B8n,0xA3BC941D0A5061CBn,0xE9F6760E32CD8021n,0x09C7E552BC76492Fn,0x852F54934DA55CC9n,0x8107FCCF064FCF56n,0x098954D51FFF6580n,0x23B70EDB1955C4BFn,0xC330DE426430F69Dn,0x4715ED43E8A45C0An,0xA8D7E4DAB780A08Dn,0x0572B974F03CE0BBn,0xB57D2E985E1419C7n,0xE8D9ECBE2CF3D73Fn,0x2FE4B17170E59750n,0x11317BA87905E790n,0x7FBF21EC8A1F45ECn,0x1725CABFCB045B00n,0x964E915CD5E2B207n,0x3E2B8BCBF016D66Dn,0xBE7444E39328A0ACn,0xF85B2B4FBCDE44B7n,0x49353FEA39BA63B1n,0x1DD01AAFCD53486An,0x1FCA8A92FD719F85n,0xFC7C95D827357AFAn,0x18A6A990C8B35EBDn,0xCCCB7005C6B9C28Dn,0x3BDBB92C43B17F26n,0xAA70B5B4F89695A2n,0xE94C39A54A98307Fn,0xB7A0B174CFF6F36En,0xD4DBA84729AF48ADn,0x2E18BC1AD9704A68n,0x2DE0966DAF2F8B1Cn,0xB9C11D5B1E43A07En,0x64972D68DEE33360n,0x94628D38D0C20584n,0xDBC0D2B6AB90A559n,0xD2733C4335C6A72Fn,0x7E75D99D94A70F4Dn,0x6CED1983376FA72Bn,0x97FCAACBF030BC24n,0x7B77497B32503B12n,0x8547EDDFB81CCB94n,0x79999CDFF70902CBn,0xCFFE1939438E9B24n,0x829626E3892D95D7n,0x92FAE24291F2B3F1n,0x63E22C147B9C3403n,0xC678B6D860284A1Cn,0x5873888850659AE7n,0x0981DCD296A8736Dn,0x9F65789A6509A440n,0x9FF38FED72E9052Fn,0xE479EE5B9930578Cn,0xE7F28ECD2D49EECDn,0x56C074A581EA17FEn,0x5544F7D774B14AEFn,0x7B3F0195FC6F290Fn,0x12153635B2C0CF57n,0x7F5126DBBA5E0CA7n,0x7A76956C3EAFB413n,0x3D5774A11D31AB39n,0x8A1B083821F40CB4n,0x7B4A38E32537DF62n,0x950113646D1D6E03n,0x4DA8979A0041E8A9n,0x3BC36E078F7515D7n,0x5D0A12F27AD310D1n,0x7F9D1A2E1EBE1327n,0xDA3A361B1C5157B1n,0xDCDD7D20903D0C25n,0x36833336D068F707n,0xCE68341F79893389n,0xAB9090168DD05F34n,0x43954B3252DC25E5n,0xB438C2B67F98E5E9n,0x10DCD78E3851A492n,0xDBC27AB5447822BFn,0x9B3CDB65F82CA382n,0xB67B7896167B4C84n,0xBFCED1B0048EAC50n,0xA9119B60369FFEBDn,0x1FFF7AC80904BF45n,0xAC12FB171817EEE7n,0xAF08DA9177DDA93Dn,0x1B0CAB936E65C744n,0xB559EB1D04E5E932n,0xC37B45B3F8D6F2BAn,0xC3A9DC228CAAC9E9n,0xF3B8B6675A6507FFn,0x9FC477DE4ED681DAn,0x67378D8ECCEF96CBn,0x6DD856D94D259236n,0xA319CE15B0B4DB31n,0x073973751F12DD5En,0x8A8E849EB32781A5n,0xE1925C71285279F5n,0x74C04BF1790C0EFEn,0x4DDA48153C94938An,0x9D266D6A1CC0542Cn,0x7440FB816508C4FEn,0x13328503DF48229Fn,0xD6BF7BAEE43CAC40n,0x4838D65F6EF6748Fn,0x1E152328F3318DEAn,0x8F8419A348F296BFn,0x72C8834A5957B511n,0xD7A023A73260B45Cn,0x94EBC8ABCFB56DAEn,0x9FC10D0F989993E0n,0xDE68A2355B93CAE6n,0xA44CFE79AE538BBEn,0x9D1D84FCCE371425n,0x51D2B1AB2DDFB636n,0x2FD7E4B9E72CD38Cn,0x65CA5B96B7552210n,0xDD69A0D8AB3B546Dn,0x604D51B25FBF70E2n,0x73AA8A564FB7AC9En,0x1A8C1E992B941148n,0xAAC40A2703D9BEA0n,0x764DBEAE7FA4F3A6n,0x1E99B96E70A9BE8Bn,0x2C5E9DEB57EF4743n,0x3A938FEE32D29981n,0x26E6DB8FFDF5ADFEn,0x469356C504EC9F9Dn,0xC8763C5B08D1908Cn,0x3F6C6AF859D80055n,0x7F7CC39420A3A545n,0x9BFB227EBDF4C5CEn,0x89039D79D6FC5C5Cn,0x8FE88B57305E2AB6n,0xA09E8C8C35AB96DEn,0xFA7E393983325753n,0xD6B6D0ECC617C699n,0xDFEA21EA9E7557E3n,0xB67C1FA481680AF8n,0xCA1E3785A9E724E5n,0x1CFC8BED0D681639n,0xD18D8549D140CAEAn,0x4ED0FE7E9DC91335n,0xE4DBF0634473F5D2n,0x1761F93A44D5AEFEn,0x53898E4C3910DA55n,0x734DE8181F6EC39An,0x2680B122BAA28D97n,0x298AF231C85BAFABn,0x7983EED3740847D5n,0x66C1A2A1A60CD889n,0x9E17E49642A3E4C1n,0xEDB454E7BADC0805n,0x50B704CAB602C329n,0x4CC317FB9CDDD023n,0x66B4835D9EAFEA22n,0x219B97E26FFC81BDn,0x261E4E4C0A333A9Dn,0x1FE2CCA76517DB90n,0xD7504DFA8816EDBBn,0xB9571FA04DC089C8n,0x1DDC0325259B27DEn,0xCF3F4688801EB9AAn,0xF4F5D05C10CAB243n,0x38B6525C21A42B0En,0x36F60E2BA4FA6800n,0xEB3593803173E0CEn,0x9C4CD6257C5A3603n,0xAF0C317D32ADAA8An,0x258E5A80C7204C4Bn,0x8B889D624D44885Dn,0xF4D14597E660F855n,0xD4347F66EC8941C3n,0xE699ED85B0DFB40Dn,0x2472F6207C2D0484n,0xC2A1E7B5B459AEB5n,0xAB4F6451CC1D45ECn,0x63767572AE3D6174n,0xA59E0BD101731A28n,0x116D0016CB948F09n,0x2CF9C8CA052F6E9Fn,0x0B090A7560A968E3n,0xABEEDDB2DDE06FF1n,0x58EFC10B06A2068Dn,0xC6E57A78FBD986E0n,0x2EAB8CA63CE802D7n,0x14A195640116F336n,0x7C0828DD624EC390n,0xD74BBE77E6116AC7n,0x804456AF10F5FB53n,0xEBE9EA2ADF4321C7n,0x03219A39EE587A30n,0x49787FEF17AF9924n,0xA1E9300CD8520548n,0x5B45E522E4B1B4EFn,0xB49C3B3995091A36n,0xD4490AD526F14431n,0x12A8F216AF9418C2n,0x001F837CC7350524n,0x1877B51E57A764D5n,0xA2853B80F17F58EEn,0x993E1DE72D36D310n,0xB3598080CE64A656n,0x252F59CF0D9F04BBn,0xD23C8E176D113600n,0x1BDA0492E7E4586En,0x21E0BD5026C619BFn,0x3B097ADAF088F94En,0x8D14DEDB30BE846En,0xF95CFFA23AF5F6F4n,0x3871700761B3F743n,0xCA672B91E9E4FA16n,0x64C8E531BFF53B55n,0x241260ED4AD1E87Dn,0x106C09B972D2E822n,0x7FBA195410E5CA30n,0x7884D9BC6CB569D8n,0x0647DFEDCD894A29n,0x63573FF03E224774n,0x4FC8E9560F91B123n,0x1DB956E450275779n,0xB8D91274B9E9D4FBn,0xA2EBEE47E2FBFCE1n,0xD9F1F30CCD97FB09n,0xEFED53D75FD64E6Bn,0x2E6D02C36017F67Fn,0xA9AA4D20DB084E9Bn,0xB64BE8D8B25396C1n,0x70CB6AF7C2D5BCF0n,0x98F076A4F7A2322En,0xBF84470805E69B5Fn,0x94C3251F06F90CF3n,0x3E003E616A6591E9n,0xB925A6CD0421AFF3n,0x61BDD1307C66E300n,0xBF8D5108E27E0D48n,0x240AB57A8B888B20n,0xFC87614BAF287E07n,0xEF02CDD06FFDB432n,0xA1082C0466DF6C0An,0x8215E577001332C8n,0xD39BB9C3A48DB6CFn,0x2738259634305C14n,0x61CF4F94C97DF93Dn,0x1B6BACA2AE4E125Bn,0x758F450C88572E0Bn,0x959F587D507A8359n,0xB063E962E045F54Dn,0x60E8ED72C0DFF5D1n,0x7B64978555326F9Fn,0xFD080D236DA814BAn,0x8C90FD9B083F4558n,0x106F72FE81E2C590n,0x7976033A39F7D952n,0xA4EC0132764CA04Bn,0x733EA705FAE4FA77n,0xB4D8F77BC3E56167n,0x9E21F4F903B33FD9n,0x9D765E419FB69F6Dn,0xD30C088BA61EA5EFn,0x5D94337FBFAF7F5Bn,0x1A4E4822EB4D7A59n,0x6FFE73E81B637FB3n,0xDDF957BC36D8B9CAn,0x64D0E29EEA8838B3n,0x08DD9BDFD96B9F63n,0x087E79E5A57D1D13n,0xE328E230E3E2B3FBn,0x1C2559E30F0946BEn,0x720BF5F26F4D2EAAn,0xB0774D261CC609DBn,0x443F64EC5A371195n,0x4112CF68649A260En,0xD813F2FAB7F5C5CAn,0x660D3257380841EEn,0x59AC2C7873F910A3n,0xE846963877671A17n,0x93B633ABFA3469F8n,0xC0C0F5A60EF4CDCFn,0xCAF21ECD4377B28Cn,0x57277707199B8175n,0x506C11B9D90E8B1Dn,0xD83CC2687A19255Fn,0x4A29C6465A314CD1n,0xED2DF21216235097n,0xB5635C95FF7296E2n,0x22AF003AB672E811n,0x52E762596BF68235n,0x9AEBA33AC6ECC6B0n,0x944F6DE09134DFB6n,0x6C47BEC883A7DE39n,0x6AD047C430A12104n,0xA5B1CFDBA0AB4067n,0x7C45D833AFF07862n,0x5092EF950A16DA0Bn,0x9338E69C052B8E7Bn,0x455A4B4CFE30E3F5n,0x6B02E63195AD0CF8n,0x6B17B224BAD6BF27n,0xD1E0CCD25BB9C169n,0xDE0C89A556B9AE70n,0x50065E535A213CF6n,0x9C1169FA2777B874n,0x78EDEFD694AF1EEDn,0x6DC93D9526A50E68n,0xEE97F453F06791EDn,0x32AB0EDB696703D3n,0x3A6853C7E70757A7n,0x31865CED6120F37Dn,0x67FEF95D92607890n,0x1F2B1D1F15F6DC9Cn,0xB69E38A8965C6B65n,0xAA9119FF184CCCF4n,0xF43C732873F24C13n,0xFB4A3D794A9A80D2n,0x3550C2321FD6109Cn,0x371F77E76BB8417En,0x6BFA9AAE5EC05779n,0xCD04F3FF001A4778n,0xE3273522064480CAn,0x9F91508BFFCFC14An,0x049A7F41061A9E60n,0xFCB6BE43A9F2FE9Bn,0x08DE8A1C7797DA9Bn,0x8F9887E6078735A1n,0xB5B4071DBFC73A66n,0x230E343DFBA08D33n,0x43ED7F5A0FAE657Dn,0x3A88A0FBBCB05C63n,0x21874B8B4D2DBC4Fn,0x1BDEA12E35F6A8C9n,0x53C065C6C8E63528n,0xE34A1D250E7A8D6Bn,0xD6B04D3B7651DD7En,0x5E90277E7CB39E2Dn,0x2C046F22062DC67Dn,0xB10BB459132D0A26n,0x3FA9DDFB67E2F199n,0x0E09B88E1914F7AFn,0x10E8B35AF3EEAB37n,0x9EEDECA8E272B933n,0xD4C718BC4AE8AE5Fn,0x81536D601170FC20n,0x91B534F885818A06n,0xEC8177F83F900978n,0x190E714FADA5156En,0xB592BF39B0364963n,0x89C350C893AE7DC1n,0xAC042E70F8B383F2n,0xB49B52E587A1EE60n,0xFB152FE3FF26DA89n,0x3E666E6F69AE2C15n,0x3B544EBE544C19F9n,0xE805A1E290CF2456n,0x24B33C9D7ED25117n,0xE74733427B72F0C1n,0x0A804D18B7097475n,0x57E3306D881EDB4Fn,0x4AE7D6A36EB5DBCBn,0x2D8D5432157064C8n,0xD1E649DE1E7F268Bn,0x8A328A1CEDFE552Cn,0x07A3AEC79624C7DAn,0x84547DDC3E203C94n,0x990A98FD5071D263n,0x1A4FF12616EEFC89n,0xF6F7FD1431714200n,0x30C05B1BA332F41Cn,0x8D2636B81555A786n,0x46C9FEB55D120902n,0xCCEC0A73B49C9921n,0x4E9D2827355FC492n,0x19EBB029435DCB0Fn,0x4659D2B743848A2Cn,0x963EF2C96B33BE31n,0x74F85198B05A2E7Dn,0x5A0F544DD2B1FB18n,0x03727073C2E134B1n,0xC7F6AA2DE59AEA61n,0x352787BAA0D7C22Fn,0x9853EAB63B5E0B35n,0xABBDCDD7ED5C0860n,0xCF05DAF5AC8D77B0n,0x49CAD48CEBF4A71En,0x7A4C10EC2158C4A6n,0xD9E92AA246BF719En,0x13AE978D09FE5557n,0x730499AF921549FFn,0x4E4B705B92903BA4n,0xFF577222C14F0A3An,0x55B6344CF97AAFAEn,0xB862225B055B6960n,0xCAC09AFBDDD2CDB4n,0xDAF8E9829FE96B5Fn,0xB5FDFC5D3132C498n,0x310CB380DB6F7503n,0xE87FBB46217A360En,0x2102AE466EBB1148n,0xF8549E1A3AA5E00Dn,0x07A69AFDCC42261An,0xC4C118BFE78FEAAEn,0xF9F4892ED96BD438n,0x1AF3DBE25D8F45DAn,0xF5B4B0B0D2DEEEB4n,0x962ACEEFA82E1C84n,0x046E3ECAAF453CE9n,0xF05D129681949A4Cn,0x964781CE734B3C84n,0x9C2ED44081CE5FBDn,0x522E23F3925E319En,0x177E00F9FC32F791n,0x2BC60A63A6F3B3F2n,0x222BBFAE61725606n,0x486289DDCC3D6780n,0x7DC7785B8EFDFC80n,0x8AF38731C02BA980n,0x1FAB64EA29A2DDF7n,0xE4D9429322CD065An,0x9DA058C67844F20Cn,0x24C0E332B70019B0n,0x233003B5A6CFE6ADn,0xD586BD01C5C217F6n,0x5E5637885F29BC2Bn,0x7EBA726D8C94094Bn,0x0A56A5F0BFE39272n,0xD79476A84EE20D06n,0x9E4C1269BAA4BF37n,0x17EFEE45B0DEE640n,0x1D95B0A5FCF90BC6n,0x93CBE0B699C2585Dn,0x65FA4F227A2B6D79n,0xD5F9E858292504D5n,0xC2B5A03F71471A6Fn,0x59300222B4561E00n,0xCE2F8642CA0712DCn,0x7CA9723FBB2E8988n,0x2785338347F2BA08n,0xC61BB3A141E50E8Cn,0x150F361DAB9DEC26n,0x9F6A419D382595F4n,0x64A53DC924FE7AC9n,0x142DE49FFF7A7C3Dn,0x0C335248857FA9E7n,0x0A9C32D5EAE45305n,0xE6C42178C4BBB92En,0x71F1CE2490D20B07n,0xF1BCC3D275AFE51An,0xE728E8C83C334074n,0x96FBF83A12884624n,0x81A1549FD6573DA5n,0x5FA7867CAF35E149n,0x56986E2EF3ED091Bn,0x917F1DD5F8886C61n,0xD20D8C88C8FFE65Fn,0x31D71DCE64B2C310n,0xF165B587DF898190n,0xA57E6339DD2CF3A0n,0x1EF6E6DBB1961EC9n,0x70CC73D90BC26E24n,0xE21A6B35DF0C3AD7n,0x003A93D8B2806962n,0x1C99DED33CB890A1n,0xCF3145DE0ADD4289n,0xD0E4427A5514FB72n,0x77C621CC9FB3A483n,0x67A34DAC4356550Bn,0xF8D626AAAF278509n],vs=class{constructor(){this.bail_out=!1,this.en_passant_row=-1,this.en_passant_column=-1,this.can_take_ep=!1}bn2hex(t,e){let i=t.toString();for(;i.length<e;)i="0"+i;return"0x"+i}xor_with_random(t,e){return t^Nr[e]}parse_en_passant(t){if(!t||t==="-")return;if(t.length!==2){this.bail_out=!0;return}let e=t.charCodeAt(0)-97,i=t.charCodeAt(1)-49;if(e<0||e>7||i<0||i>7){this.bail_out=!0;return}this.en_passant_column=e,this.en_passant_row=i}hash_color_to_move(t,e){return e==="w"?this.xor_with_random(t,780):(e!=="b"&&(this.bail_out=!0),t)}hash_castle(t,e){return e==="-"||(e.search("K")!==-1&&(t=this.xor_with_random(t,768)),e.search("Q")!==-1&&(t=this.xor_with_random(t,769)),e.search("k")!==-1&&(t=this.xor_with_random(t,770)),e.search("q")!==-1&&(t=this.xor_with_random(t,771))),t}hash_pieces(t,e){let i=e.split("/");if(i.length!==8)return this.bail_out=!0,t;for(let n=0;n<8;n++){let o=0,l=7-n;for(let f=0;f<i[n].length;f++)switch(i[n][f]){case"p":t=this.xor_with_random(t,8*l+o),this.en_passant_row===2&&l===3&&this.en_passant_column>0&&o===this.en_passant_column-1&&(this.can_take_ep=!0),this.en_passant_row===2&&l===3&&this.en_passant_column<7&&o===this.en_passant_column+1&&(this.can_take_ep=!0),o++;break;case"P":t=this.xor_with_random(t,64+8*l+o),this.en_passant_row===5&&l===4&&this.en_passant_column>0&&o===this.en_passant_column-1&&(this.can_take_ep=!0),this.en_passant_row===5&&l===4&&this.en_passant_column<7&&o===this.en_passant_column+1&&(this.can_take_ep=!0),o++;break;case"n":t=this.xor_with_random(t,64*2+8*l+o),o++;break;case"N":t=this.xor_with_random(t,64*3+8*l+o),o++;break;case"b":t=this.xor_with_random(t,64*4+8*l+o),o++;break;case"B":t=this.xor_with_random(t,64*5+8*l+o),o++;break;case"r":t=this.xor_with_random(t,64*6+8*l+o),o++;break;case"R":t=this.xor_with_random(t,64*7+8*l+o),o++;break;case"q":t=this.xor_with_random(t,64*8+8*l+o),o++;break;case"Q":t=this.xor_with_random(t,64*9+8*l+o),o++;break;case"k":t=this.xor_with_random(t,64*10+8*l+o),o++;break;case"K":t=this.xor_with_random(t,64*11+8*l+o),o++;break;case"0":case"1":case"2":case"3":case"4":case"5":case"6":case"7":case"8":let m=i[n].charCodeAt(f)-48;o+=m;break;default:return this.bail_out=!0,t}o!==8&&(this.bail_out=!0)}return t}compute_fen_hash(t){this.en_passant_row=-1,this.en_passant_column=-1,this.can_take_ep=!1;let e=0n,i=t.trim().split(" ");return i.length!==6?null:(this.parse_en_passant(i[3]),e=this.hash_pieces(e,i[0]),this.can_take_ep&&(e=this.xor_with_random(e,772+this.en_passant_column)),e=this.hash_color_to_move(e,i[1]),e=this.hash_castle(e,i[2]),e)}};var Es=class{constructor(t){this.book=null,this.initialisation=new Promise(e=>{this.fetchBook(t).then(i=>{this.book=i,e()})}),this.keyGenerator=new vs}entryToMove(t){let e={from:void 0,to:void 0,promotion:void 0},i="abcdefgh",n=" nbrq";return e.from=i[t.get_from_col()],e.from=""+e.from+(t.get_from_row()+1),e.to=i[t.get_to_col()],e.to=""+e.to+(t.get_to_row()+1),t.get_promo_piece()>0&&(e.promotion=n[t.get_promo_piece()]),t.isOOW()?e.to="g1":t.isOOOW()?e.to="c1":t.isOOB()?e.to="g8":t.isOOOB()&&(e.to="c8"),e.weight=t.weight,e}async getMovesFromFen(t,e=.2){return new Promise(i=>{this.initialisation.then(()=>{let n=this.keyGenerator.compute_fen_hash(t),o=this.book.get_all_moves(n),l=[],f=0;for(let m of o)l.push(this.entryToMove(m)),f+=m.weight;for(let m of l)m.probability=Math.pow(m.weight/f,e).toFixed(1);i(l)})})}fetchBook(t){return new Promise((e,i)=>{fetch(t).then(n=>{n.blob().then(o=>{let l=new FileReader;l.readAsBinaryString(o),l.onload=()=>{e(new gs(l.result))},l.onerror=()=>{i(l.error)}})})})}};var bs=class extends dt{constructor(t){super(t)}init(){this.polyglot=new Es(this.props.bookUrl),this.polyglot.initialisation.then(()=>(this.engineState=ne.READY,Promise.resolve()))}calculateMove(t,e={}){this.engineState=ne.THINKING;let i=new Promise(o=>{setTimeout(async()=>{o()},this.props.responseDelay)}),n=new Promise(async o=>{let l=await this.polyglot.getMovesFromFen(t);this.props.debug&&console.log(t,"moves found in opening book",l);let f=[];for(let g of l)for(let x=0;x<g.probability*10;x++)f.push(g);let m=Math.floor(Math.random()*f.length);o(f[m])});return new Promise(o=>{Promise.all([this.initialized,i,n]).then(l=>{this.engineState=ne.READY,o(l[2])})})}};var Zs=class extends pt{constructor(t,e,i){super(t,e),this.props={debug:!1},Object.assign(this.props,i),this.engineRunner=new Cs({workerUrl:i.worker,debug:i.debug}),this.openingRunner=i.book?new bs({bookUrl:i.book}):this.engineRunner,this.state={scoreHistory:{},score:null,level:i.level,engineState:ne.LOADING,currentRunner:this.openingRunner},this.initialisation=Promise.all([this.openingRunner.initialization,this.engineRunner.initialization]),this.initialisation.then(()=>{this.state.engineState=ne.LOADED}),this.i18n=t.i18n,this.i18n.load({de:{score:"Bewertung",level:"Stufe"},en:{score:"Score",level:"Level"}}),this.chessConsole.messageBroker.subscribe(Q.load,()=>{if(this.chessConsole.persistence.loadValue("level")&&(this.state.level=parseInt(this.chessConsole.persistence.loadValue("level"),10)),this.chessConsole.persistence.loadValue("scoreHistory")){this.state.scoreHistory=this.chessConsole.persistence.loadValue("scoreHistory");let n=this.state.scoreHistory[this.chessConsole.state.plyViewed];!n&&this.chessConsole.state.plyViewed>0&&(n=this.state.scoreHistory[this.chessConsole.state.plyViewed-1]),this.state.score=n}}),this.chessConsole.messageBroker.subscribe(Q.moveUndone,()=>{this.state.currentRunner=this.openingRunner}),this.chessConsole.messageBroker.subscribe(Q.newGame,()=>{this.state.scoreHistory={},this.state.score=0}),this.chessConsole.messageBroker.subscribe(Q.initGame,n=>{n.props.engineLevel&&(this.state.level=n.props.engineLevel),this.state.currentRunner=this.openingRunner}),X.property(this.state,"level",()=>{this.chessConsole.persistence.saveValue("level",this.state.level)}),X.property(this.state,"score",()=>{this.chessConsole.persistence.saveValue("score",this.state.score),this.chessConsole.persistence.saveValue("scoreHistory",this.state.scoreHistory)})}moveRequest(t,e){this.props.debug&&console.log("moveRequest",t),this.initialisation.then(async()=>{this.state.engineState=ne.THINKING,this.state.level<3&&(this.state.currentRunner=this.engineRunner);let i=await this.state.currentRunner.calculateMove(t,{level:this.state.level});if(i){this.props.debug&&(console.log("this.state.currentRunner",this.state.currentRunner),console.log("nextMove",i,this.state.currentRunner.constructor.name));let n;i.score!==void 0?(isNaN(i.score)?n=i.score:n=-i.score,this.state.scoreHistory[this.chessConsole.state.chess.plyCount()]=n,this.state.score=n):this.state.score=void 0,this.state.engineState=ne.READY,e(i)}else if(this.props.debug&&console.log("no move found with",this.state.currentRunner.constructor.name),this.state.currentRunner===this.openingRunner)this.state.currentRunner=this.engineRunner,this.moveRequest(t,e);else throw new Error("can't find move with fen "+t+" and runner "+this.state.currentRunner)})}};var Js=class extends ae{constructor(t,e,i={}){super(void 0,i),this.chessConsole=t,this.player=e;let n=t.i18n;this.props.spinnerIcon||(this.props.spinnerIcon="spinner"),this.numberFormat=new Intl.NumberFormat(n.locale,{minimumFractionDigits:1,maximumFractionDigits:1}),this.element=this.chessConsole.context.querySelector(".engine-state"),this.element.innerHTML=`<span class="score text-muted"></span> <span class="thinking text-muted"><i class="fas fa-${this.props.spinnerIcon} fa-spin"></i></span>`,this.scoreElement=this.element.querySelector(".score"),this.thinkingElement=this.element.querySelector(".thinking"),this.thinkingElement.style.display="none",X.property(e.state,"level",()=>{this.updatePlayerName()}),X.property(e.state,"engineState",()=>{e.state.engineState===ne.THINKING?this.thinkingElement.style.display="":this.thinkingElement.style.display="none"}),X.property(e.state,"score",o=>{let l=o.newValue;if(l){let f;isNaN(l)?f=l:f=this.numberFormat.format(l),this.scoreElement.innerHTML=`${n.t("score")} ${f}`}else this.scoreElement.innerHTML=""}),X.property(this.chessConsole.state,"plyViewed",()=>{let o=e.state.scoreHistory[this.chessConsole.state.plyViewed];if(!o&&this.chessConsole.state.plyViewed>0&&(o=e.state.scoreHistory[this.chessConsole.state.plyViewed-1]),o){let l;isNaN(o)?l=o:l=this.numberFormat.format(o),this.scoreElement.innerHTML=`${n.t("score")} ${l}`}else this.scoreElement.innerHTML=""}),this.updatePlayerName()}updatePlayerName(){this.player.name=`Stockfish ${this.chessConsole.i18n.t("level")} ${this.player.state.level}`}};export{Gs as Board,Ks as CapturedPieces,Ms as ChessConsole,Ws as GameStateOutput,Hs as History,zs as HistoryControl,Tt as I18n,Is as LocalPlayer,Qs as Persistence,Ys as Sound,Xs as StockfishGameControl,Mt as StockfishNewGameDialog,Zs as StockfishPlayer,Js as StockfishStateView};
//# sourceMappingURL=chess-console-stockfish.js.map
